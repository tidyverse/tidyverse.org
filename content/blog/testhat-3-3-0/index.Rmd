---
output: hugodown::hugo_document

slug: testhat-3-3-0
title: testhat 3 3 0
date: 2025-11-05
author: Hadley Wickham
description: >
    A 2-3 sentence description of the post that appears on the articles page.
    This can be omitted if it would just recapitulate the title.

photo:
  url: https://unsplash.com/photos/n6vS3xlnsCc
  author: Kelley Bozarth

# one of: "deep-dive", "learn", "package", "programming", "roundup", or "other"
categories: [package] 
tags: []
---

```{r}
#| include: false
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

<!--
TODO:
* [ ] Look over / edit the post's title in the yaml
* [ ] Edit (or delete) the description; note this appears in the Twitter card
* [ ] Pick category and tags (see existing with `hugodown::tidy_show_meta()`)
* [ ] Find photo & update yaml metadata
* [ ] Create `thumbnail-sq.jpg`; height and width should be equal
* [ ] Create `thumbnail-wd.jpg`; width should be >5x height
* [ ] `hugodown::use_tidy_thumbnails()`
* [ ] Add intro sentence, e.g. the standard tagline for the package
* [ ] `usethis::use_tidy_thanks()`
-->

We're chuffed to announce the release of []({ home }) .  is ... 

You can install it from CRAN with:

```{r, eval = FALSE}
install.packages("{package}")
```

This blog post will ...

You can see a full list of changes in the [release notes]({ github_release })

```{r setup}
library(testthat)
```

## Claude code experiences

I also used this version of testthat as an opportunity to learn claude code, and hence it's the first project where I've really used AI to support development of many features

* `settings.json` - 
* `CLAUDE.md` - 

Overall it was a successful experiement and helped me close over a 100 issues, in what felt like less time than usual. Overall, while there might have been a few specific cases where I got 2x performance, on average it feels more like a 10-20% improvement. Obviously this is still significant, especially since I'm already an experienced R programmer. I mostly used it for smaller well-defined tasks where I had a good sense of what was needed. I found it particularly useful for refactoring. It was rare for me to accept what it did as is, but often it got me started.

I also found it generally useful for getting over the "activation energy hump". There were a few issues that had been stangnating for years because they felt like they were going to be hard to do, and with relatively limited payoff. I let claude code lose on a few of these and found it super useful. Again, it only produced code I was happy with a couple of times, but every time it gave me something to react too (often with strong negative feelings!) and that got me started actually engaging with the problem.

I also experimented with using claude code to review PRs. It was just barely useful enough that I kept it turned on for my own PRs, but didn't bother trying to get it to work for contributed PRs. Most of the time it either gave a thumbs up or bad advice. But every now and then it would pick up a smaller error.

## Lifecycle changes

The biggest change in this release is that `local_mock()` and `with_mock()` are now defunct. They were deprecated in 3.0.0 (2020-10-31) because the technique that made them work is no longer permitted in R 4.5.0. This was a fairly disruptive change, affecting ~100 CRAN packages, but it had to be done, and I've been working on notifying package developers since January so everyone had plenty of time to update. (Fortunately the changes needed were also generally small). 

Other changes:

* testthat now requires R 4.1. This is in line [with our supported version policy](https://tidyverse.org/blog/2019/04/r-version-support/) where we support five version of R. Importantly means that we can now use the base pipe and the short-form of `function() {}`, `\() {}`. This is exciting for us!

* `is_null()`/`matches()`, deprecated in 2.0.0 (2017-12-19), and `is_true()`/`is_false()`, deprecated in 2.1.0 (2019-04-23), have been removed. These conflicted with other tidyverse functions so we pushed their deprecation through, even though we have largely left the old form of testthat (which uses `test_that()`) largely untouched.

* `expect_snapshot(binary)`, soft deprecated in 3.0.3 (2021-06-16), is now fully deprecated. `test_files(wrap)`, deprecated in 3.0.0 (2020-10-31) has now been removed.

* There are a few other changes that broke existing packaes listed below. The most impactful change was to start checking the inputs to `expect()` which (unfortunately, depsite the name) is an internal helper. That revealed a surprising number of packages were accidentally using it instead of `expect_true()` or `expect_equal()`. We technically don't consider this a breaking change because it revealed off-label usage of existing functions.

## Expectations and the interactive testing experience

A lot of work in this version was prompted by an overhaul of `vignette("custom-expectations")`. This was motivated by _finally_ creating some decent documentation about how to write your own expectations. But as I worked on this vignette, I realised that I didn't really know how to write new expectations and there was a lot of variation in how existing expectations were written. So this kick off a bunch of changes:

* All `expect_` functions have had their failure messages rewritten. They now all state what was expected, what was actually received, and, if possible, clearly illustrate the difference. 

* They consistently return the value of the first argument, regardless of whether the expectation succeeds or fails (the only exception is `expect_message()` and friends which return the condition). This shouldn't affect existing tests, but will make failures clearer when you chain together multiple expectations.

* A new `pass()` function makes it clear how to signal when an expectation succeeds.

* Revised `expect_success()` and `expect_failure()` functions test that an expectation follows the expectation contract: each call of an `expect_` function should return exactly one success or failure (this ensures that the counts you see in the reporters are always correct).

This framework helped us write six new expectations:

*   New `expect_all_equal()`, `expect_all_true()`, and `expect_all_false()` check that every element of a vector has the same value, giving better error messages than `expect_true(all(...))`.

    ```{r}
    #| error: true

    test_that("some test", {
      x <- c(0.408, 0.961, 0.883, 0.46, 0.537, 0.961, 0.851, 0.887, 0.023)
      expect_all_true(x < 0.95)
    })
    ```

*   New `expect_disjoint()` expects values to to be absent.

    ```{r}
    #| error: true

    test_that("", {
      expect_disjoint(c("a", "b", "c"), c("c", "d", "e"))
    })
    ```

*   New `expect_r6_class()` expects an R6 object.

    ```{r}
    #| error: true

    test_that("", {
      x <- 10
      expect_r6_class(x, "foo")

      x <- R6::R6Class("bar")$new()
      expect_r6_class(x, "foo")
    })
    ```

*   New `expect_shape()` expects a specific shape (i.e., `nrow()`, `ncol()`, or `dim()`).

    ```{r}
    #| error: true

    test_that("show off expect_shape() failure messages", {
      x <- matrix(1:9, nrow = 3)
      expect_shape(x, nrow = 4)
      expect_shape(x, dim = c(3, 3, 3))
      expect_shape(x, dim = c(3, 4))
    })
    ```

As I wrote this vignette, I also realised that the interactive behaviour of `test_that()` (i.e. when you execute a single test at the console, not as part of a test suite) could be improved so you now see the number of successes and failures. You'll notice that in the examples above.


## Other new features

* I've generally consider the case of nested tests (i.e. putting a `test_that()` inside another `test_that()`, or more typically `it()` inside of `describe()`). They should now generally generate more informative failure messages, free from duplication, with more informative skips if any of the subtests are empty.

* On CRAN, `test_that()` will automatically skip if a package is not installed, which means that you no longer need to check if suggested packages are installed in your tests.

* New `vignette("mocking")` explains mocking in detail, and `local_mocked_s3_method()`, `local_mocked_s4_method()`, and `local_mocked_r6_class()` make it easier to mock S3 and S4 methods and R6 classes.

* `test_dir()`, `test_check()`, and friends gain a `shuffle` argument that uses `sample()` to randomly reorder the top-level expressions in each test file. This random reordering surfaces dependencies between tests and code outside of any test, as well as dependencies between tests. This helps you find and eliminate unintentional dependencies.

* `try_again()` is now publicised, making it easier to test flaky code. We changed the first argument to represent the number of retries, not tries.

* New `skip_unless_r()` skip tests on unsuitable versions of R. It has a convenient sytnax so you can use, e.g., `skip_unless_r(">= 4.1.0")` to skip tests that require `...names()`.

* We put a lot of work into the snapshot experience, fixing all known bug and adding some new helpers. `snapshot_reject()` rejects all modified snapshots by deleting the `.new` variants, and `snapshot_download_gh()` makes it easy to get snapshots off GitHub and into your local package. `expect_snapshot()` and friends will now fail when creating a new snapshot on CI. This is usually a signal that you've forgotten to run it locally before committing.

* New `SlowReporter` makes it easier to find the slowest tests in your package. You can run it with `devtools::test(reporter = "slow")`.

* New `vignette("challenging-functions")` provides an index to other documentation organised by various challenges (#1265).


## Acknowledgements
