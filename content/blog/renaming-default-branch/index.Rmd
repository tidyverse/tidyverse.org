---
output: hugodown::hugo_document

slug: renaming-default-branch
title: Renaming the default branch
date: 2021-09-10
author: Jenny Bryan
description: >
    We are renaming the default branch of many Git(Hub) repositories and this
    post explains how contributors can adapt, using new functionality in
    usethis.

photo:
  url: https://unsplash.com/photos/jA264x_MkCI
  author: Natalie Chaney

# one of: "deep-dive", "learn", "package", "programming", or "other"
categories: [learn] 
tags: [usethis, devtools]
---

Technically, Git has no official concept of the default branch.
But in practice, most Git repos have an *effective default branch*.
If there's only one branch, this is it!
It is the branch that most bug fixes and features get merged in to.
It is the branch you see when you first visit a repo on a site such as GitHub.
On a Git remote, it is the branch that `HEAD` points to.
The default branch may not be precisely defined in Git itself, but most of us know it when we see it.

Historically, `master` has been the most common name for the default branch,
but `main` is an increasingly popular choice.
There is coordinated change across the Git ecosystem that is making it easier for users to make this switch, for example:

* [Regarding Git and Branch Naming](https://sfconservancy.org/news/2020/jun/23/gitbranchname/), statement from the Git project and the Software Freedom Conservancy regarding the new `init.defaultBranch` configuration option
* [Renaming the default branch from` master`](https://github.com/github/renaming#readme), GitHub's roadmap for supporting the shift away from `master`
* [The new Git default branch name](https://about.gitlab.com/blog/2021/03/10/new-git-default-branch-name/), same but for GitLab

Folks at RStudio maintain hundreds of public repositories on GitHub, spread out over various organizations and user accounts.
Some individual repos had already moved away from `master` in the past year, but many of us had not made the change, just due to inertia.
We've decided it tackle this switch proactively and in bulk, for any interested individual or team, hopefully reducing the pain for everyone.

The purpose of this blog post is to:

* Give our community a heads-up about this change.
* Explain how this affects people who have cloned or forked our repositories.
* Explain how you can make the `master` to `main` switch in your own Git life.
* Advertise new functions in the usethis package that help with the above.

## Which repositories are affected?

The transition from `master` to `main` is happening organization-wide for specific GitHub organizations (e.g. [tidyverse](https://github.com/tidyverse), [r-lib](https://github.com/r-lib), [tidymodels](https://github.com/tidymodels), and [sol-eng](https://github.com/sol-eng)).
However, several teams maintain repos across multiple organizations and several organizations host repos for multiple teams and purposes.
The organization-driven approach is a poor fit, in these cases.
Therefore, several hundred additional "one-off" repos are also part of this effort.

All told, we're coordinating the `master` to `main` switch for FILL IN THIS NUMBER repositories.

In each case, we opened a GitHub issue announcing the coming change, several weeks in advance.
These issues all look something like this: <https://github.com/tidyverse/dplyr/issues/6006>.

## When are things changing?

"Around now."

Ideally, we would publish this post at the very same moment we rename our branches.
But that's not possible for a variety of reasons, chiefly because no single person has the necessary permissions for all of the affected repos.

Coordinated change is going to work best for repos that are part of an organization-wide effort, because each organization has at least one person with the necessary superpowers.
But things are more complicated for the one-off repos.
If there's a repo you care about, that has an open issue about branch renaming, and yet the change doesn't seem to be happening?
Feel free to give us a gentle nudge by commenting in the issue thread.

## usethis x.y.z has functions to help

The recently released x.y.z. version of usethis has some new functions to support changes in the default branch.
To be clear, you don't _need_ usethis to do adapt to change in the default branch.
The work can be done via command line Git and/or in a web browser, if that's how you roll.

But the new `git_default_branch*()` family of functions can make this process more pleasant, for those who enjoy using devtools/usethis, especially for Git and GitHub tasks.

You can install the newest version of usethis from CRAN with:

```{r, eval = FALSE}
install.packages("usethis")
```

You can make usethis available in your R session with either of these commands:

```{r setup}
library(usethis)

# devtools Depends on usethis, so attaching it also attaches usethis
library(devtools)
```

If you'd like usethis to help with you with Git/GitHub, please read the article [Managing Git(Hub) Credentials](https://usethis.r-lib.org/articles/articles/git-credentials.html).

## How to update clones and forks after default branch renaming

As mentioned above, our bulk renaming involves FILL IN THIS NUMBER GitHub repos, which are associated with FILL IN THIS NUMBER forks.
It's impossible to say how many non-fork clones there may be.
Undoubtedly, many of these forks and clones are inactive, but it's also clear that our branch renaming potentially affects lots of people.

### How will I know I have a problem?

Let's show what it looks like when you try to pull from a remote repo in a project that used to use `master`, but now uses `main`, but you haven't updated your local repo yet.

* Example with `usethis::pr_merge_main()`:

    ```
    ✓ Pulling changes from 'origin/master' (default branch of source repo)
    Error in libgit2::git_annotated_commit_from_revspec : 
      revspec 'origin/master' not found
    ```

* Example with command line `git pull` (which is essentially what RStudio's Git pane does):

    ```
    Your configuration specifies to merge with the ref 'refs/heads/master'
    from the remote, but no such ref was fetched.
    ```

Both messages are telling you the same thing:

> We're trying to pull changes from the remote `master` branch, but the remote does not have a `master` branch.

TODO: update this as usethis gets smarter and more proactive about detecting this. As it is, I only got the usethis error by first calling `gert::git_fetch(prune = TRUE)`. Without that, usethis doesn't surface the problem in an obvious way. It just silently fetches a nonexistent ref and the merge leads to "Already up to date, nothing to merge" (which we suppress, which is neither here nor there).

### Can I just burn it all down?

Yes, yes you can!

If there's nothing precious in your local clone of our repo or in your fork, it's perfectly reasonable to delete them and just start over.
Locally, you just delete the folder.
On GitHub, in your fork, go to *Settings* and scroll down to the *Danger Zone* to *Delete this repository*.

Then you could do a fresh fork-and-clone of, for example, dplyr:

```{r eval = FALSE}
create_from_github("tidyverse/dplyr")
```

### How do I update my stuff to reflect the new default branch?

If you don't want to burn it all down, you can call `usethis::git_default_branch_rediscover()` to _rediscover_ the default branch from the **source repo**.

```{r eval = FALSE}
git_default_branch_rediscover()
#> ✓ Rediscovering the default branch from source repo.
#> ✓ Setting active project to '/Users/jenny/tmp/aaa'
#> ℹ GitHub remote configuration type: 'ours'
#> ℹ Read more about GitHub remote configurations at:
#>   'https://happygitwithr.com/common-remote-setups.html'
#> ℹ Source repo is 'jennybc/aaa' and its current default branch is 'main'.
#> The local branch 'master' appears to play the role of the default branch.
#> Do you confirm?
#> 
#> 1: yes
#> 2: no
#> 
#> Selection: 1
#> ✓ Moving local 'master' branch to 'main'.
#> ✓ Setting remote tracking branch for local 'main' branch to 'origin/main'.
```

Above, you see usethis updating the local repository to match the source repo.
If we detect that you also have a fork of this repo, usethis will rename its default branch as well.

usethis is very opinionated and conservative about which GitHub setups it's willing to manage, because we don't want to barge in and mess with something we don't understand.
These standard setups and what we mean by, e.g., **source repo** are all described at <https://happygitwithr.com/common-remote-setups.html>.

TODO: get rid of this note in Happy Git "2020-10 note: this currently refers to features in a development version of usethis. These features will appear in usethis v2.0.0."

GitHub provides official instructions for [updating a local clone after a branch name changes](https://docs.github.com/en/github/administering-a-repository/managing-branches-in-your-repository/renaming-a-branch#updating-a-local-clone-after-a-branch-name-changes), using only command line Git:

```{sh, eval = FALSE}
$ git branch -m OLD-BRANCH-NAME NEW-BRANCH-NAME
$ git fetch origin
$ git branch -u origin/NEW-BRANCH-NAME NEW-BRANCH-NAME
$ git remote set-head origin -a
```

Depending on your setup, above you might need to substitute `upstream` for `origin`.
`OLD-BRANCH-NAME` is probably `master` and `NEW-BRANCH-NAME` is probably `main`.

## How to rename default branch in your own existing repos

## How to change your "default default" branch for the future

## Acknowledgements

