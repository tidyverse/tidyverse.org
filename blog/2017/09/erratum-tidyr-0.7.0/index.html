<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>Erratum tidyr 0.7.0</title><meta property="og:title" content="Erratum tidyr 0.7.0"><meta property="og:description" content="We have updated tidyselect to revert a behaviour introduced in tidyr 0.7.0."><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2017/09/erratum-tidyr-0.7.0/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="Erratum tidyr 0.7.0 - Tidyverse"><meta property="description" content="We have updated tidyselect to revert a behaviour introduced in tidyr 0.7.0."><meta property="og:description" content="We have updated tidyselect to revert a behaviour introduced in tidyr 0.7.0."><meta property="og:image" content="https://www.tidyverse.org/blog/2017/09/erratum-tidyr-0.7.0/erratum-tidyr-0.7.0-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2017/09/erratum-tidyr-0.7.0/erratum-tidyr-0.7.0-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/%20/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title>Erratum tidyr 0.7.0</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2017/09/erratum-tidyr-0.7.0/erratum-tidyr-0.7.0-wd.jpg></div><div class=photoCredit>Photo by <a href=https://unsplash.com/photos/0vY082Un2pk>Edu Grande</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2017/09/04</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/tidyverse/>tidyverse</a>,
<a href=/tags/tidyr/>tidyr</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Lionel Henry</p><div class=article-content><p>In <a href=http://www.tidyverse.org/articles/2017/08/tidyr-0.7.0/>tidyr 0.7.0</a>, we introduced a stronger distinction between data expressions and context expressions for selection verbs like <code>gather()</code>. However that change caused a lot of trouble and confusion and we have updated <code>tidyselect</code> (the backend for selection functions) to revert that behaviour. In that article, we provide a few comments on these changes as well as some notes on good practices for writing functions with tidyverse tools. Finally we introduce two new selection features that help write safer code: improved support for strings and character vectors and a new selection helper <code>last_col()</code>.</p><p>You can install the new version of tidyselect from CRAN:</p><pre class=r><code>install.packages(&quot;tidyselect&quot;)</code></pre><div id=updated-selection-rules class="section level3"><h3>Updated selection rules</h3><p>Since tidyr 0.7.0, selecting functions like <code>gather()</code> use the tidyselect package as backend. Tidyselect was extracted from dplyr and provides the mechanism for helpers like <code>starts_with()</code> or <code>everything()</code>. However, tidyselect had one big change compared to dplyr: data expressions could no longer refer to contextual variables. A <strong>data</strong> expression is defined as either a bare symbol like <code>var</code>, or a call like <code>var1:var2</code> or <code>c(var1, var2)</code>. Any other expressions is a <strong>context</strong> expression. The semantic change meant that it was no longer legal to refer to a contextual variable in a data expression:</p><pre class=r><code>var &lt;- 5
mtcars %&gt;% gather(&quot;key&quot;, &quot;value&quot;, 1:var)</code></pre><p>We thought this was a relatively uncommon occurrence in practice. However that broke a lot of code that had this form:</p><pre class=r><code>df %&gt;% gather(&quot;key&quot;, &quot;value&quot;, 1:ncol(df))</code></pre><p>Although the change was well-intentioned, it proved to be too disruptive and we have reverted it.</p><p>Note that we still maintain a distinction between data and context expressions. The notion of context expression (anything that’s not a symbol or a call to <code>:</code> or <code>c()</code>) was introduced in dplyr 0.7.0. Since that version, context expressions cannot refer to the data. This makes it safer to refer to other objects.</p></div><div id=safety-versus-convenience class="section level3"><h3>Safety versus convenience</h3><p>Most datawise functions in R obey the same set rules regarding the visibility of objects. Visibility is hierarchical: data frame objects override those found in the context. This is convenient for interactive use and scripts, but can also cause issues. In the following example, should <code>gather()</code> select the first three columns (using the <code>x</code> defined in the global environment), or should it select the first two columns (using the column named <code>x</code>)?</p><pre class=r><code>x &lt;- 3
df &lt;- tibble(w = 1, x = 2, y = 3)
df %&gt;% gather(&quot;key&quot;, &quot;value&quot;, 1:x)
#&gt; # A tibble: 2 x 3
#&gt;       y   key value
#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;
#&gt; 1     3     w     1
#&gt; 2     3     x     2</code></pre><p>The answer is that it selects the first two variables because <code>x</code> is first found in the data.</p><p>In practice, the hierarchical ambiguity is not a big problem when you use these tools interactively or in scripts. However it becomes worrying when you’re writing reusable functions because you don’t know in advance the variables in the input data frame. For those cases where ambiguity matters, the tidy eval feature of quasiquotation allows you to explicitly pick a variable from the context:</p><pre class=r><code>df %&gt;% gather(&quot;key&quot;, &quot;value&quot;, 1:(!! x))
#&gt; # A tibble: 3 x 2
#&gt;     key value
#&gt;   &lt;chr&gt; &lt;dbl&gt;
#&gt; 1     w     1
#&gt; 2     x     2
#&gt; 3     y     3</code></pre></div><div id=the-special-semantics-of-selection-functions class="section level3"><h3>The special semantics of selection functions</h3><p>Selection functions have always been a bit special in the tidyverse. They don’t behave exactly like regular quoting functions. In almost all quoting functions in R, variables represent a data frame <em>column</em>. That’s why expressions like this are natural:</p><pre class=r><code>lm(mass ~ scale(height), data = starwars)</code></pre><p>Since variables represent actual columns, you can include them in expressions as if they were actual objects. For instance <code>scale(height)</code> is equivalent to <code>scale(starwars$height)</code>. The same is true for most tidyverse tools, e.g. <code>dplyr::mutate()</code>:</p><pre class=r><code>starwars %&gt;% mutate(height = scale(height))</code></pre><p>However in selection functions, variables do not represent columns but <em>column positions</em>. That is a subtle but important distinction. When you type <code>height</code>, tidyselect actually sees the integer <code>2</code>. This makes sense for several reasons:</p><ul><li><p>Expressions such as <code>name:mass</code> evaluate to <code>1:3</code> in a natural way.</p></li><li><p>You can select the same column multiple times. For example if you supply a selection for the dataset <code>starwars</code> with <code>starts_with("s")</code> and <code>ends_with("s")</code>, the variables <code>species</code> and <code>starships</code> would be matched twice. It is easy for tidyselect to take the intersection of the two sets of column positions. If the sets contained vectors instead, it could not determine whether there were two different but identical vectors rather than the same vector selected twice.</p></li><li><p>Finally and most importantly, if the variables evaluated to the column vectors, we would have no information about their names or positions, which we need to reconstitute the data frame.</p></li></ul><p>Since the variables represent positions, expressions such as <code>select(sqrt(hair_color):mass^2)</code> are valid but won’t do what you might think at first. In the selection context, that expression translates to <code>2:9</code> because <code>hair_color</code> and <code>mass</code> are the fourth and third column of the data frame.</p></div><div id=safety-in-selection-functions class="section level3"><h3>Safety in selection functions</h3><p>Given the special semantics of selection functions, we had more freedom to solve the hierarchical ambiguity of quoting functions. Indeed, apart from <code>:</code>, <code>c()</code> or <code>-</code>, there rarely is any need for referring to column positions in helpers like <code>starts_with()</code> or <code>contains()</code>. For this reason, dplyr 0.7.0 introduced the notion of context expressions. Data frame columns are no longer in scope in these calls in order to solve the hierarchical ambiguity. This has the downside that context expressions in selection functions behave a bit differently from the rest of the tidyverse, but we gain safety in exchange.</p><p>Given these special semantics, it seemed to make sense to give data expressions the opposite behaviour and only allow references to the data. This would solve the ambiguity in the opposite direction. As explained above, this broke too much code. We had to change it back and the issue of hierarchical ambiguity along with it.</p><p>Luckily tidyselect 0.2.0 also introduces a few features that help writing safer code for data expressions. First, the support for strings and character vectors has been improved. All data expressions fully support strings. It is now valid to supply strings to <code>-</code> and <code>:</code>:</p><pre class=r><code>starwars %&gt;% gather(&quot;key&quot;, &quot;value&quot;, &quot;name&quot; : &quot;films&quot;)
#&gt; # A tibble: 957 x 4
#&gt;     vehicles starships   key     value
#&gt;       &lt;list&gt;    &lt;list&gt; &lt;chr&gt;    &lt;list&gt;
#&gt;  1 &lt;chr [2]&gt; &lt;chr [2]&gt;  name &lt;chr [1]&gt;
#&gt;  2 &lt;chr [0]&gt; &lt;chr [0]&gt;  name &lt;chr [1]&gt;
#&gt;  3 &lt;chr [0]&gt; &lt;chr [0]&gt;  name &lt;chr [1]&gt;
#&gt;  4 &lt;chr [0]&gt; &lt;chr [1]&gt;  name &lt;chr [1]&gt;
#&gt;  5 &lt;chr [1]&gt; &lt;chr [0]&gt;  name &lt;chr [1]&gt;
#&gt;  6 &lt;chr [0]&gt; &lt;chr [0]&gt;  name &lt;chr [1]&gt;
#&gt;  7 &lt;chr [0]&gt; &lt;chr [0]&gt;  name &lt;chr [1]&gt;
#&gt;  8 &lt;chr [0]&gt; &lt;chr [0]&gt;  name &lt;chr [1]&gt;
#&gt;  9 &lt;chr [0]&gt; &lt;chr [1]&gt;  name &lt;chr [1]&gt;
#&gt; 10 &lt;chr [1]&gt; &lt;chr [5]&gt;  name &lt;chr [1]&gt;
#&gt; # ... with 947 more rows
starwars %&gt;% gather(&quot;key&quot;, &quot;value&quot;, -&quot;height&quot;)
#&gt; # A tibble: 1,044 x 3
#&gt;    height   key     value
#&gt;     &lt;int&gt; &lt;chr&gt;    &lt;list&gt;
#&gt;  1    172  name &lt;chr [1]&gt;
#&gt;  2    167  name &lt;chr [1]&gt;
#&gt;  3     96  name &lt;chr [1]&gt;
#&gt;  4    202  name &lt;chr [1]&gt;
#&gt;  5    150  name &lt;chr [1]&gt;
#&gt;  6    178  name &lt;chr [1]&gt;
#&gt;  7    165  name &lt;chr [1]&gt;
#&gt;  8     97  name &lt;chr [1]&gt;
#&gt;  9    183  name &lt;chr [1]&gt;
#&gt; 10    182  name &lt;chr [1]&gt;
#&gt; # ... with 1,034 more rows</code></pre><p>Note that this only applies to <code>c()</code>, <code>-</code> or <code>:</code> because it would not make sense to write <code>seq("name", "mass")</code>. Also, it only makes sense to support strings in this way because of the special nature of selection functions. This wouldn’t work with <code>mutate()</code> or <code>lm()</code> since they wouldn’t be able to differentiate between a column name or an actual column (by recycling the string to column length if the data frame has more than one row).</p><p>The purpose of supporting strings in selection function is to make it easier to unquote column names. Excluding columns with quasiquotation is now as simple as this:</p><pre class=r><code>x &lt;- &quot;height&quot;
starwars %&gt;% gather(&quot;key&quot;, &quot;value&quot;, -(!! x))
#&gt; # A tibble: 1,044 x 3
#&gt;    height   key     value
#&gt;     &lt;int&gt; &lt;chr&gt;    &lt;list&gt;
#&gt;  1    172  name &lt;chr [1]&gt;
#&gt;  2    167  name &lt;chr [1]&gt;
#&gt;  3     96  name &lt;chr [1]&gt;
#&gt;  4    202  name &lt;chr [1]&gt;
#&gt;  5    150  name &lt;chr [1]&gt;
#&gt;  6    178  name &lt;chr [1]&gt;
#&gt;  7    165  name &lt;chr [1]&gt;
#&gt;  8     97  name &lt;chr [1]&gt;
#&gt;  9    183  name &lt;chr [1]&gt;
#&gt; 10    182  name &lt;chr [1]&gt;
#&gt; # ... with 1,034 more rows</code></pre><p>The second feature introduced in tidyselect 0.2.0 is the <code>last_col()</code> helper. We noticed in bug reports that many people use variants of:</p><pre class=r><code>x &lt;- starwars
x %&gt;% gather(&quot;key&quot;, &quot;value&quot;, 3 : ncol(x))
#&gt; # A tibble: 957 x 4
#&gt;                  name height   key     value
#&gt;                 &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;    &lt;list&gt;
#&gt;  1     Luke Skywalker    172  mass &lt;dbl [1]&gt;
#&gt;  2              C-3PO    167  mass &lt;dbl [1]&gt;
#&gt;  3              R2-D2     96  mass &lt;dbl [1]&gt;
#&gt;  4        Darth Vader    202  mass &lt;dbl [1]&gt;
#&gt;  5        Leia Organa    150  mass &lt;dbl [1]&gt;
#&gt;  6          Owen Lars    178  mass &lt;dbl [1]&gt;
#&gt;  7 Beru Whitesun lars    165  mass &lt;dbl [1]&gt;
#&gt;  8              R5-D4     97  mass &lt;dbl [1]&gt;
#&gt;  9  Biggs Darklighter    183  mass &lt;dbl [1]&gt;
#&gt; 10     Obi-Wan Kenobi    182  mass &lt;dbl [1]&gt;
#&gt; # ... with 947 more rows</code></pre><p>That is potentially unsafe in functions since the data frame might contain a column named <code>x</code>. You can now use <code>last_col()</code> instead:</p><pre class=r><code># Importing last_col() because it&#39;s not exported in dplyr yet
last_col &lt;- tidyselect::last_col

x %&gt;% gather(&quot;key&quot;, &quot;value&quot;, 3 : last_col())
#&gt; # A tibble: 957 x 4
#&gt;                  name height   key     value
#&gt;                 &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;    &lt;list&gt;
#&gt;  1     Luke Skywalker    172  mass &lt;dbl [1]&gt;
#&gt;  2              C-3PO    167  mass &lt;dbl [1]&gt;
#&gt;  3              R2-D2     96  mass &lt;dbl [1]&gt;
#&gt;  4        Darth Vader    202  mass &lt;dbl [1]&gt;
#&gt;  5        Leia Organa    150  mass &lt;dbl [1]&gt;
#&gt;  6          Owen Lars    178  mass &lt;dbl [1]&gt;
#&gt;  7 Beru Whitesun lars    165  mass &lt;dbl [1]&gt;
#&gt;  8              R5-D4     97  mass &lt;dbl [1]&gt;
#&gt;  9  Biggs Darklighter    183  mass &lt;dbl [1]&gt;
#&gt; 10     Obi-Wan Kenobi    182  mass &lt;dbl [1]&gt;
#&gt; # ... with 947 more rows</code></pre></div></div></div><div class=column25><div class="section hideOnMobile"></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script src=/js/math-code.js></script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>