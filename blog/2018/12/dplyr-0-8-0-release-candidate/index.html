<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>dplyr 0.8.0 release candidate</title><meta property="og:title" content="dplyr 0.8.0 release candidate"><meta property="og:description" content="What you need to know about upcoming changes in dplyr 0.8.0."><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2018/12/dplyr-0-8-0-release-candidate/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="dplyr 0.8.0 release candidate - Tidyverse"><meta property="description" content="What you need to know about upcoming changes in dplyr 0.8.0."><meta property="og:description" content="What you need to know about upcoming changes in dplyr 0.8.0."><meta property="og:image" content="https://www.tidyverse.org/blog/2018/12/dplyr-0-8-0-release-candidate/dplyr-0-8-0-release-candidate-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2018/12/dplyr-0-8-0-release-candidate/dplyr-0-8-0-release-candidate-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/%20/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title>dplyr 0.8.0 release candidate</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2018/12/dplyr-0-8-0-release-candidate/dplyr-0-8-0-release-candidate-wd.jpg></div><div class=photoCredit>Photo by <a href=https://unsplash.com/photos/kU-WKSyTcp4>Pau Casals</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2018/12/03</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/dplyr/>dplyr</a>,
<a href=/tags/tidyverse/>tidyverse</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Romain Fran√ßois</p><div class=article-content><style>blockquote{margin:10px 0;padding:10px 10px 0;border:2px solid red;background:#f8f8f8;font-size:100%;font-style:inherit;font-weight:inherit}</style><blockquote><p>This post, published in early December 2018 and promoted on Twitter
generated valuable discussions that led us to reconsider some
design choices for <code>dplyr</code> 0.8.0</p></blockquote><blockquote><p>We&rsquo;ve left the original post unchanged, with addenda when
changes have been made.</p></blockquote><p>A new release of dplyr (0.8.0) is on the horizon, <del>roughly planned for early January</del> planned
for February 1st.</p><p>Since it is a major release with some potential
disruption, we&rsquo;d love for the community to try it out, give us some feedback,
and
<a href=https://github.com/tidyverse/dplyr/issues target=_blank rel=noopener>report issues</a>
before we submit to CRAN. This version represents about nine months of development, making dplyr more
respectful of factors, and less surprising in its evaluation of expressions.</p><p>In this post, we&rsquo;ll highlight the major changes. Please see the
<a href=https://github.com/tidyverse/dplyr/blob/master/NEWS.md target=_blank rel=noopener>NEWS</a> for a more
detailed description of changes. Our formalised process for this release is captured
in
<a href=https://github.com/tidyverse/dplyr/issues/3931 target=_blank rel=noopener>this issue</a>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=c1># install.packages(&#34;devtools&#34;)</span>
<span class=n>devtools</span><span class=o>::</span><span class=nf>install_github</span><span class=p>(</span><span class=s>&#34;tidyverse/dplyr@rc_0.8.0&#34;</span><span class=p>)</span>
</code></pre></div><p>If needed, you can restore the
<a href="https://CRAN.R-project.org/package=dplyr" target=_blank rel=noopener>release version</a> by installing from CRAN:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>install.packages</span><span class=p>(</span><span class=s>&#34;dplyr&#34;</span><span class=p>)</span>
</code></pre></div><h1 id=new-grouping-algorithm>New grouping algorithm
<a href=#new-grouping-algorithm><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><h2 id=group-creation>Group creation
<a href=#group-creation><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The algorithm behind
<a href=https://dplyr.tidyverse.org/reference/group_by.html target=_blank rel=noopener><code>group_by()</code></a> has been redesigned to better respect factor levels,
so that a group is created for each level of the factor, even if there is no data. This
differs from previous versions of dplyr where groups were only created to
match the observed data. This closes the epic issue
<a href=https://github.com/tidyverse/dplyr/issues/341 target=_blank rel=noopener>341</a>, which dates back to 2014, and has generated
a lot of press and frustration, see
<a href=https://kieranhealy.org/blog/archives/2018/11/19/zero-counts-in-dplyr/ target=_blank rel=noopener>Zero Counts in dplyr</a>
for a recent walkthrough of the issue.</p><p>Let&rsquo;s illustrate the new algorithm with the
<a href=https://dplyr.tidyverse.org/reference/count.html target=_blank rel=noopener><code>count()</code></a> function:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>&lt;-</span> <span class=nf>tibble</span><span class=p>(</span>
  <span class=n>f1</span> <span class=o>=</span> <span class=nf>factor</span><span class=p>(</span><span class=nf>c</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>,</span> <span class=s>&#34;a&#34;</span><span class=p>,</span> <span class=s>&#34;a&#34;</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>),</span> <span class=n>levels</span> <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=s>&#34;c&#34;</span><span class=p>)),</span> 
  <span class=n>f2</span> <span class=o>=</span> <span class=nf>factor</span><span class=p>(</span><span class=nf>c</span><span class=p>(</span><span class=s>&#34;d&#34;</span><span class=p>,</span> <span class=s>&#34;e&#34;</span><span class=p>,</span> <span class=s>&#34;d&#34;</span><span class=p>,</span> <span class=s>&#34;e&#34;</span><span class=p>,</span> <span class=s>&#34;f&#34;</span><span class=p>),</span> <span class=n>levels</span> <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=s>&#34;d&#34;</span><span class=p>,</span> <span class=s>&#34;e&#34;</span><span class=p>,</span> <span class=s>&#34;f&#34;</span><span class=p>)),</span> 
  <span class=n>x</span>  <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>2</span><span class=p>),</span> 
  <span class=n>y</span>  <span class=o>=</span> <span class=m>1</span><span class=o>:</span><span class=m>5</span>
<span class=p>)</span>
<span class=n>df</span>
<span class=c1>#&gt; # A tibble: 5 x 4</span>
<span class=c1>#&gt;   f1    f2        x     y</span>
<span class=c1>#&gt;   &lt;fct&gt; &lt;fct&gt; &lt;dbl&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1 a     d         1     1</span>
<span class=c1>#&gt; 2 a     e         1     2</span>
<span class=c1>#&gt; 3 a     d         1     3</span>
<span class=c1>#&gt; 4 b     e         2     4</span>
<span class=c1>#&gt; 5 b     f         2     5</span>
<span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>count</span><span class=p>(</span><span class=n>f1</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 3 x 2</span>
<span class=c1>#&gt;   f1        n</span>
<span class=c1>#&gt;   &lt;fct&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1 a         3</span>
<span class=c1>#&gt; 2 b         2</span>
<span class=c1>#&gt; 3 c         0</span>
</code></pre></div><p>Where previous versions of <code>dplyr</code> would have created only two groups (for levels <code>a</code> and <code>b</code>),
it now creates one group per level, and the group related to the level <code>c</code> just happens to be
empty.</p><p>Groups are still made to match the data on other types of columns:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>count</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 2 x 2</span>
<span class=c1>#&gt;       x     n</span>
<span class=c1>#&gt;   &lt;dbl&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1     1     3</span>
<span class=c1>#&gt; 2     2     2</span>
</code></pre></div><p>Expansion of groups for factors happens at each step of the grouping, so if we group
by <code>f1</code> and <code>f2</code> we get 9 groups,</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>count</span><span class=p>(</span><span class=n>f1</span><span class=p>,</span> <span class=n>f2</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 9 x 3</span>
<span class=c1>#&gt;   f1    f2        n</span>
<span class=c1>#&gt;   &lt;fct&gt; &lt;fct&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1 a     d         2</span>
<span class=c1>#&gt; 2 a     e         1</span>
<span class=c1>#&gt; 3 a     f         0</span>
<span class=c1>#&gt; 4 b     d         0</span>
<span class=c1>#&gt; 5 b     e         1</span>
<span class=c1>#&gt; 6 b     f         1</span>
<span class=c1>#&gt; 7 c     d         0</span>
<span class=c1>#&gt; 8 c     e         0</span>
<span class=c1>#&gt; 9 c     f         0</span>
</code></pre></div><p>When factors and non factors are involved in the grouping, the number of
groups depends on the order. At each level of grouping, factors are always expanded
to one group per level, but non factors only create groups based on observed data.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>count</span><span class=p>(</span><span class=n>f1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 3 x 3</span>
<span class=c1>#&gt;   f1        x     n</span>
<span class=c1>#&gt;   &lt;fct&gt; &lt;dbl&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1 a         1     3</span>
<span class=c1>#&gt; 2 b         2     2</span>
<span class=c1>#&gt; 3 c        NA     0</span>
</code></pre></div><p>In this example, we group by <code>f1</code> then <code>x</code>. At the first layer, grouping on <code>f1</code> creates
three groups. Each of these groups is then subdivided based on the values of the second
variable <code>x</code>. Since <code>x</code> is always 1 when <code>f1</code> is <code>a</code> the group is not
further divided.</p><p>The last group, associated with the level <code>c</code> of the factor <code>f1</code> is empty, and
consequently has no values for the vector <code>x</code>. In that case,
<a href=https://dplyr.tidyverse.org/reference/group_by.html target=_blank rel=noopener><code>group_by()</code></a> uses
<code>NA</code>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>count</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>f1</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 6 x 3</span>
<span class=c1>#&gt;       x f1        n</span>
<span class=c1>#&gt;   &lt;dbl&gt; &lt;fct&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1     1 a         3</span>
<span class=c1>#&gt; 2     1 b         0</span>
<span class=c1>#&gt; 3     1 c         0</span>
<span class=c1>#&gt; 4     2 a         0</span>
<span class=c1>#&gt; 5     2 b         2</span>
<span class=c1>#&gt; 6     2 c         0</span>
</code></pre></div><p>When we group by <code>x</code> then <code>f1</code> we initially split the data according to <code>x</code> which
gives 2 groups. Each of these two groups is then further divided in 3 groups,
i.e. one for each level of <code>f1</code>.</p><blockquote><p>We&rsquo;ve added the possibility to drop the empty groups, and hence
get the previous behaviour by using <code>group_by(.drop = TRUE)</code>.</p><p>This is not the default value, because we still strongly believe that
all levels of factors should be represented in the grouping structure.</p></blockquote><h2 id=group-preservation>Group preservation
<a href=#group-preservation><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The grouping structure is more coherently preserved by dplyr verbs.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>f1</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>summarise</span><span class=p>(</span><span class=n>y</span> <span class=o>=</span> <span class=nf>mean</span><span class=p>(</span><span class=n>y</span><span class=p>))</span>
<span class=c1>#&gt; # A tibble: 6 x 3</span>
<span class=c1>#&gt; # Groups:   x [2]</span>
<span class=c1>#&gt;       x f1        y</span>
<span class=c1>#&gt;   &lt;dbl&gt; &lt;fct&gt; &lt;dbl&gt;</span>
<span class=c1>#&gt; 1     1 a       2  </span>
<span class=c1>#&gt; 2     1 b     NaN  </span>
<span class=c1>#&gt; 3     1 c     NaN  </span>
<span class=c1>#&gt; 4     2 a     NaN  </span>
<span class=c1>#&gt; 5     2 b       4.5</span>
<span class=c1>#&gt; 6     2 c     NaN</span>
</code></pre></div><p>The expression <code>mean(y)</code> is evaluated for the empty groups as well, and gives
consistent results with :</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>mean</span><span class=p>(</span><span class=nf>numeric</span><span class=p>())</span>
<span class=c1>#&gt; [1] NaN</span>
</code></pre></div><p>In particular the result of
<a href=https://dplyr.tidyverse.org/reference/filter.html target=_blank rel=noopener><code>filter()</code></a> preserves the grouping structure of the input
data frame.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>f1</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>filter</span><span class=p>(</span><span class=n>y</span> <span class=o>&lt;</span> <span class=m>4</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 3 x 4</span>
<span class=c1>#&gt; # Groups:   x, f1 [3]</span>
<span class=c1>#&gt;   f1    f2        x     y</span>
<span class=c1>#&gt;   &lt;fct&gt; &lt;fct&gt; &lt;dbl&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1 a     d         1     1</span>
<span class=c1>#&gt; 2 a     e         1     2</span>
<span class=c1>#&gt; 3 a     d         1     3</span>
</code></pre></div><p>The resulting tibble after the
<a href=https://dplyr.tidyverse.org/reference/filter.html target=_blank rel=noopener><code>filter()</code></a> call has six groups, the same
exact groups that were made by
<a href=https://dplyr.tidyverse.org/reference/group_by.html target=_blank rel=noopener><code>group_by()</code></a>. Previous versions of dplyr
would perform an implicit <code>group_by()</code> after the filtering, potentially losing
groups.</p><p>Because this is potentially disruptive,
<a href=https://dplyr.tidyverse.org/reference/filter.html target=_blank rel=noopener><code>filter()</code></a> has gained a <code>.preserve</code> argument,
when <code>.preserve</code> is <code>FALSE</code> the data is first filtered and then regrouped:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>df</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>f1</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>filter</span><span class=p>(</span><span class=n>y</span> <span class=o>&lt;</span> <span class=m>5</span><span class=p>,</span> <span class=n>.preserve</span> <span class=o>=</span> <span class=kc>FALSE</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 4 x 4</span>
<span class=c1>#&gt; # Groups:   x, f1 [6]</span>
<span class=c1>#&gt;   f1    f2        x     y</span>
<span class=c1>#&gt;   &lt;fct&gt; &lt;fct&gt; &lt;dbl&gt; &lt;int&gt;</span>
<span class=c1>#&gt; 1 a     d         1     1</span>
<span class=c1>#&gt; 2 a     e         1     2</span>
<span class=c1>#&gt; 3 a     d         1     3</span>
<span class=c1>#&gt; 4 b     e         2     4</span>
</code></pre></div><blockquote><p>As opposed to what is described above, feedback from this post led us
to change the default value of <code>.preserve</code> to <code>FALSE</code>, and update the
algorithm to limit the cost of preserving.</p></blockquote><p>Note however, that even <code>.preserve = FALSE</code> respects the factors that are used as
grouping variables, in particular <code>filter( , .preserve = FALSE)</code> is not a way to
discard empty groups. The
<a href=https://forcats.tidyverse.org target=_blank rel=noopener>forcats</a> üì¶ may help:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>filter</span><span class=p>(</span><span class=n>stringr</span><span class=o>::</span><span class=nf>str_detect</span><span class=p>(</span><span class=n>Species</span><span class=p>,</span> <span class=s>&#34;^v&#34;</span><span class=p>))</span> <span class=o>%&gt;%</span> 
  <span class=nf>ungroup</span><span class=p>()</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>Species</span> <span class=o>=</span> <span class=n>forcats</span><span class=o>::</span><span class=nf>fct_drop</span><span class=p>(</span><span class=n>Species</span><span class=p>))</span>
<span class=c1>#&gt; # A tibble: 100 x 5</span>
<span class=c1>#&gt; # Groups:   Species [2]</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species   </span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     </span>
<span class=c1>#&gt;  1          7           3.2          4.7         1.4 versicolor</span>
<span class=c1>#&gt;  2          6.4         3.2          4.5         1.5 versicolor</span>
<span class=c1>#&gt;  3          6.9         3.1          4.9         1.5 versicolor</span>
<span class=c1>#&gt;  4          5.5         2.3          4           1.3 versicolor</span>
<span class=c1>#&gt;  5          6.5         2.8          4.6         1.5 versicolor</span>
<span class=c1>#&gt;  6          5.7         2.8          4.5         1.3 versicolor</span>
<span class=c1>#&gt;  7          6.3         3.3          4.7         1.6 versicolor</span>
<span class=c1>#&gt;  8          4.9         2.4          3.3         1   versicolor</span>
<span class=c1>#&gt;  9          6.6         2.9          4.6         1.3 versicolor</span>
<span class=c1>#&gt; 10          5.2         2.7          3.9         1.4 versicolor</span>
<span class=c1>#&gt; # ‚Ä¶ with 90 more rows</span>
</code></pre></div><blockquote><p>Furthermore, the <code>group_trim()</code> function has been added. <code>group_trim()</code>
recalculates the grouping metadata after dropping unused levels for
all grouping variables that are factors.</p></blockquote><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>filter</span><span class=p>(</span><span class=n>stringr</span><span class=o>::</span><span class=nf>str_detect</span><span class=p>(</span><span class=n>Species</span><span class=p>,</span> <span class=s>&#34;^v&#34;</span><span class=p>))</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_trim</span><span class=p>()</span>
<span class=c1>#&gt; # A tibble: 100 x 5</span>
<span class=c1>#&gt; # Groups:   Species [2]</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species   </span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     </span>
<span class=c1>#&gt;  1          7           3.2          4.7         1.4 versicolor</span>
<span class=c1>#&gt;  2          6.4         3.2          4.5         1.5 versicolor</span>
<span class=c1>#&gt;  3          6.9         3.1          4.9         1.5 versicolor</span>
<span class=c1>#&gt;  4          5.5         2.3          4           1.3 versicolor</span>
<span class=c1>#&gt;  5          6.5         2.8          4.6         1.5 versicolor</span>
<span class=c1>#&gt;  6          5.7         2.8          4.5         1.3 versicolor</span>
<span class=c1>#&gt;  7          6.3         3.3          4.7         1.6 versicolor</span>
<span class=c1>#&gt;  8          4.9         2.4          3.3         1   versicolor</span>
<span class=c1>#&gt;  9          6.6         2.9          4.6         1.3 versicolor</span>
<span class=c1>#&gt; 10          5.2         2.7          3.9         1.4 versicolor</span>
<span class=c1>#&gt; # ‚Ä¶ with 90 more rows</span>
</code></pre></div><h2 id=new-grouping-fuctions>New grouping fuctions
<a href=#new-grouping-fuctions><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The grouping family is extended with new functions:</p><ul><li><a href=https://dplyr.tidyverse.org/reference/group_nest.html target=_blank rel=noopener><code>group_nest()</code></a> : similar to
<a href=https://tidyr.tidyverse.org/reference/nest.html target=_blank rel=noopener><code>tidyr::nest()</code></a> but focusing on the grouping columns
rather than the columns to nest</li><li><a href=https://dplyr.tidyverse.org/reference/group_split.html target=_blank rel=noopener><code>group_split()</code></a> : similar to <code>base::split()</code> but the grouping is subject to the data mask</li><li><a href=https://dplyr.tidyverse.org/reference/group_keys.html target=_blank rel=noopener><code>group_keys()</code></a> : retrieves a tibble with one row per group and one column per grouping variable</li><li><a href=https://dplyr.tidyverse.org/reference/group_rows.html target=_blank rel=noopener><code>group_rows()</code></a> : retrieves a list of 1-based integer vectors, each vector represents the indices
of the group in the grouped data frame</li></ul><p>The primary use case for these functions is with already grouped data frames, that may directly
or indirectly originate from
<a href=https://dplyr.tidyverse.org/reference/group_by.html target=_blank rel=noopener><code>group_by()</code></a>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>data</span> <span class=o>&lt;-</span> <span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>filter</span><span class=p>(</span><span class=n>Sepal.Length</span> <span class=o>&gt;</span> <span class=nf>mean</span><span class=p>(</span><span class=n>Sepal.Length</span><span class=p>))</span>

<span class=n>data</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_nest</span><span class=p>()</span>
<span class=c1>#&gt; # A tibble: 3 x 2</span>
<span class=c1>#&gt;   Species    data             </span>
<span class=c1>#&gt;   &lt;fct&gt;      &lt;list&gt;           </span>
<span class=c1>#&gt; 1 setosa     &lt;tibble [22 √ó 4]&gt;</span>
<span class=c1>#&gt; 2 versicolor &lt;tibble [24 √ó 4]&gt;</span>
<span class=c1>#&gt; 3 virginica  &lt;tibble [22 √ó 4]&gt;</span>
<span class=n>data</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_split</span><span class=p>()</span>
<span class=c1>#&gt; [[1]]</span>
<span class=c1>#&gt; # A tibble: 22 x 5</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span>
<span class=c1>#&gt;  1          5.1         3.5          1.4         0.2 setosa </span>
<span class=c1>#&gt;  2          5.4         3.9          1.7         0.4 setosa </span>
<span class=c1>#&gt;  3          5.4         3.7          1.5         0.2 setosa </span>
<span class=c1>#&gt;  4          5.8         4            1.2         0.2 setosa </span>
<span class=c1>#&gt;  5          5.7         4.4          1.5         0.4 setosa </span>
<span class=c1>#&gt;  6          5.4         3.9          1.3         0.4 setosa </span>
<span class=c1>#&gt;  7          5.1         3.5          1.4         0.3 setosa </span>
<span class=c1>#&gt;  8          5.7         3.8          1.7         0.3 setosa </span>
<span class=c1>#&gt;  9          5.1         3.8          1.5         0.3 setosa </span>
<span class=c1>#&gt; 10          5.4         3.4          1.7         0.2 setosa </span>
<span class=c1>#&gt; # ‚Ä¶ with 12 more rows</span>
<span class=c1>#&gt; </span>
<span class=c1>#&gt; [[2]]</span>
<span class=c1>#&gt; # A tibble: 24 x 5</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species   </span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     </span>
<span class=c1>#&gt;  1          7           3.2          4.7         1.4 versicolor</span>
<span class=c1>#&gt;  2          6.4         3.2          4.5         1.5 versicolor</span>
<span class=c1>#&gt;  3          6.9         3.1          4.9         1.5 versicolor</span>
<span class=c1>#&gt;  4          6.5         2.8          4.6         1.5 versicolor</span>
<span class=c1>#&gt;  5          6.3         3.3          4.7         1.6 versicolor</span>
<span class=c1>#&gt;  6          6.6         2.9          4.6         1.3 versicolor</span>
<span class=c1>#&gt;  7          6           2.2          4           1   versicolor</span>
<span class=c1>#&gt;  8          6.1         2.9          4.7         1.4 versicolor</span>
<span class=c1>#&gt;  9          6.7         3.1          4.4         1.4 versicolor</span>
<span class=c1>#&gt; 10          6.2         2.2          4.5         1.5 versicolor</span>
<span class=c1>#&gt; # ‚Ä¶ with 14 more rows</span>
<span class=c1>#&gt; </span>
<span class=c1>#&gt; [[3]]</span>
<span class=c1>#&gt; # A tibble: 22 x 5</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species  </span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    </span>
<span class=c1>#&gt;  1          7.1         3            5.9         2.1 virginica</span>
<span class=c1>#&gt;  2          7.6         3            6.6         2.1 virginica</span>
<span class=c1>#&gt;  3          7.3         2.9          6.3         1.8 virginica</span>
<span class=c1>#&gt;  4          6.7         2.5          5.8         1.8 virginica</span>
<span class=c1>#&gt;  5          7.2         3.6          6.1         2.5 virginica</span>
<span class=c1>#&gt;  6          6.8         3            5.5         2.1 virginica</span>
<span class=c1>#&gt;  7          7.7         3.8          6.7         2.2 virginica</span>
<span class=c1>#&gt;  8          7.7         2.6          6.9         2.3 virginica</span>
<span class=c1>#&gt;  9          6.9         3.2          5.7         2.3 virginica</span>
<span class=c1>#&gt; 10          7.7         2.8          6.7         2   virginica</span>
<span class=c1>#&gt; # ‚Ä¶ with 12 more rows</span>
<span class=n>data</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_keys</span><span class=p>()</span>
<span class=c1>#&gt; # A tibble: 3 x 1</span>
<span class=c1>#&gt;   Species   </span>
<span class=c1>#&gt;   &lt;fct&gt;     </span>
<span class=c1>#&gt; 1 setosa    </span>
<span class=c1>#&gt; 2 versicolor</span>
<span class=c1>#&gt; 3 virginica</span>
<span class=n>data</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_rows</span><span class=p>()</span>
<span class=c1>#&gt; [[1]]</span>
<span class=c1>#&gt;  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22</span>
<span class=c1>#&gt; </span>
<span class=c1>#&gt; [[2]]</span>
<span class=c1>#&gt;  [1] 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45</span>
<span class=c1>#&gt; [24] 46</span>
<span class=c1>#&gt; </span>
<span class=c1>#&gt; [[3]]</span>
<span class=c1>#&gt;  [1] 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68</span>
</code></pre></div><p>Alternatively, these functions may be used on an ungrouped data frame, together with a
grouping specification that is subject to the data mask. In that case, the grouping is
implicitly performed by
<a href=https://dplyr.tidyverse.org/reference/group_by.html target=_blank rel=noopener><code>group_by()</code></a>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_nest</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 3 x 2</span>
<span class=c1>#&gt;   Species    data             </span>
<span class=c1>#&gt;   &lt;fct&gt;      &lt;list&gt;           </span>
<span class=c1>#&gt; 1 setosa     &lt;tibble [50 √ó 4]&gt;</span>
<span class=c1>#&gt; 2 versicolor &lt;tibble [50 √ó 4]&gt;</span>
<span class=c1>#&gt; 3 virginica  &lt;tibble [50 √ó 4]&gt;</span>

<span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_split</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span>
<span class=c1>#&gt; [[1]]</span>
<span class=c1>#&gt; # A tibble: 50 x 5</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span>
<span class=c1>#&gt;  1          5.1         3.5          1.4         0.2 setosa </span>
<span class=c1>#&gt;  2          4.9         3            1.4         0.2 setosa </span>
<span class=c1>#&gt;  3          4.7         3.2          1.3         0.2 setosa </span>
<span class=c1>#&gt;  4          4.6         3.1          1.5         0.2 setosa </span>
<span class=c1>#&gt;  5          5           3.6          1.4         0.2 setosa </span>
<span class=c1>#&gt;  6          5.4         3.9          1.7         0.4 setosa </span>
<span class=c1>#&gt;  7          4.6         3.4          1.4         0.3 setosa </span>
<span class=c1>#&gt;  8          5           3.4          1.5         0.2 setosa </span>
<span class=c1>#&gt;  9          4.4         2.9          1.4         0.2 setosa </span>
<span class=c1>#&gt; 10          4.9         3.1          1.5         0.1 setosa </span>
<span class=c1>#&gt; # ‚Ä¶ with 40 more rows</span>
<span class=c1>#&gt; </span>
<span class=c1>#&gt; [[2]]</span>
<span class=c1>#&gt; # A tibble: 50 x 5</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species   </span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     </span>
<span class=c1>#&gt;  1          7           3.2          4.7         1.4 versicolor</span>
<span class=c1>#&gt;  2          6.4         3.2          4.5         1.5 versicolor</span>
<span class=c1>#&gt;  3          6.9         3.1          4.9         1.5 versicolor</span>
<span class=c1>#&gt;  4          5.5         2.3          4           1.3 versicolor</span>
<span class=c1>#&gt;  5          6.5         2.8          4.6         1.5 versicolor</span>
<span class=c1>#&gt;  6          5.7         2.8          4.5         1.3 versicolor</span>
<span class=c1>#&gt;  7          6.3         3.3          4.7         1.6 versicolor</span>
<span class=c1>#&gt;  8          4.9         2.4          3.3         1   versicolor</span>
<span class=c1>#&gt;  9          6.6         2.9          4.6         1.3 versicolor</span>
<span class=c1>#&gt; 10          5.2         2.7          3.9         1.4 versicolor</span>
<span class=c1>#&gt; # ‚Ä¶ with 40 more rows</span>
<span class=c1>#&gt; </span>
<span class=c1>#&gt; [[3]]</span>
<span class=c1>#&gt; # A tibble: 50 x 5</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species  </span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    </span>
<span class=c1>#&gt;  1          6.3         3.3          6           2.5 virginica</span>
<span class=c1>#&gt;  2          5.8         2.7          5.1         1.9 virginica</span>
<span class=c1>#&gt;  3          7.1         3            5.9         2.1 virginica</span>
<span class=c1>#&gt;  4          6.3         2.9          5.6         1.8 virginica</span>
<span class=c1>#&gt;  5          6.5         3            5.8         2.2 virginica</span>
<span class=c1>#&gt;  6          7.6         3            6.6         2.1 virginica</span>
<span class=c1>#&gt;  7          4.9         2.5          4.5         1.7 virginica</span>
<span class=c1>#&gt;  8          7.3         2.9          6.3         1.8 virginica</span>
<span class=c1>#&gt;  9          6.7         2.5          5.8         1.8 virginica</span>
<span class=c1>#&gt; 10          7.2         3.6          6.1         2.5 virginica</span>
<span class=c1>#&gt; # ‚Ä¶ with 40 more rows</span>

<span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_keys</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 3 x 1</span>
<span class=c1>#&gt;   Species   </span>
<span class=c1>#&gt;   &lt;fct&gt;     </span>
<span class=c1>#&gt; 1 setosa    </span>
<span class=c1>#&gt; 2 versicolor</span>
<span class=c1>#&gt; 3 virginica</span>
</code></pre></div><p>These functions are related to each other in how they handle and organize the
grouping information and who/what is responsible for maintaining the relation between the
data and the groups.</p><ul><li><p>A grouped data frame, as generated by
<a href=https://dplyr.tidyverse.org/reference/group_by.html target=_blank rel=noopener><code>group_by()</code></a> stores the grouping information
as an attribute of the data frame, dplyr verbs use that information to maintain
the relationship</p></li><li><p>When using
<a href=https://dplyr.tidyverse.org/reference/group_nest.html target=_blank rel=noopener><code>group_nest()</code></a> the data is structured as a data frame that has a list column
to hold the non grouping columns. The result of
<a href=https://dplyr.tidyverse.org/reference/group_nest.html target=_blank rel=noopener><code>group_nest()</code></a> is not a grouped data frame,
therefore the structure of the data frame maintains the relationship.</p></li><li><p>When using
<a href=https://dplyr.tidyverse.org/reference/group_split.html target=_blank rel=noopener><code>group_split()</code></a> the data is split into a list, and each element of the list
contains a tibble with the rows of the associated group. The user is responsible to
maintain the relationship, and may benefit from the assistance of the
<a href=https://dplyr.tidyverse.org/reference/group_keys.html target=_blank rel=noopener><code>group_keys()</code></a>
function, especially in the presence of empty groups.</p></li></ul><h2 id=iterate-on-grouped-tibbles-by-group>Iterate on grouped tibbles by group
<a href=#iterate-on-grouped-tibbles-by-group><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The new
<a href=https://dplyr.tidyverse.org/reference/group_map.html target=_blank rel=noopener><code>group_map()</code></a> function provides a purrr style function that can be used to
iterate on grouped tibbles. Each conceptual group of the data frame is exposed to the
function with two pieces of information:</p><ul><li>The subset of the data for the group, exposed as <code>.x</code>.</li><li>The key, a tibble with exactly one row and columns for each grouping variable,
exposed as <code>.y</code></li></ul><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>mtcars</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>cyl</span><span class=p>)</span> <span class=o>%&gt;%</span>
  <span class=nf>group_map</span><span class=p>(</span><span class=o>~</span> <span class=nf>head</span><span class=p>(</span><span class=n>.x</span><span class=p>,</span> <span class=m>2L</span><span class=p>))</span>
<span class=c1>#&gt; # A tibble: 6 x 11</span>
<span class=c1>#&gt; # Groups:   cyl [3]</span>
<span class=c1>#&gt;     cyl   mpg  disp    hp  drat    wt  qsec    vs    am  gear  carb</span>
<span class=c1>#&gt; * &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class=c1>#&gt; 1     4  22.8  108     93  3.85  2.32  18.6     1     1     4     1</span>
<span class=c1>#&gt; 2     4  24.4  147.    62  3.69  3.19  20       1     0     4     2</span>
<span class=c1>#&gt; 3     6  21    160    110  3.9   2.62  16.5     0     1     4     4</span>
<span class=c1>#&gt; 4     6  21    160    110  3.9   2.88  17.0     0     1     4     4</span>
<span class=c1>#&gt; 5     8  18.7  360    175  3.15  3.44  17.0     0     0     3     2</span>
<span class=c1>#&gt; 6     8  14.3  360    245  3.21  3.57  15.8     0     0     3     4</span>

<span class=n>mtcars</span> <span class=o>%&gt;%</span>
  <span class=nf>group_by</span><span class=p>(</span><span class=n>cyl</span><span class=p>)</span> <span class=o>%&gt;%</span>
  <span class=nf>group_map</span><span class=p>(</span><span class=o>~</span> <span class=nf>tibble</span><span class=p>(</span><span class=n>mod</span> <span class=o>=</span> <span class=nf>list</span><span class=p>(</span><span class=nf>lm</span><span class=p>(</span><span class=n>mpg</span> <span class=o>~</span> <span class=n>disp</span><span class=p>,</span> <span class=n>data</span> <span class=o>=</span> <span class=n>.x</span><span class=p>))))</span>
<span class=c1>#&gt; # A tibble: 3 x 2</span>
<span class=c1>#&gt; # Groups:   cyl [3]</span>
<span class=c1>#&gt;     cyl mod     </span>
<span class=c1>#&gt; * &lt;dbl&gt; &lt;list&gt;  </span>
<span class=c1>#&gt; 1     4 &lt;S3: lm&gt;</span>
<span class=c1>#&gt; 2     6 &lt;S3: lm&gt;</span>
<span class=c1>#&gt; 3     8 &lt;S3: lm&gt;</span>
</code></pre></div><p>The lambda function must return a data frame.
<a href=https://dplyr.tidyverse.org/reference/group_map.html target=_blank rel=noopener><code>group_map()</code></a> row binds the data
frames, recycles the grouping columns and structures the result as a grouped tibble.</p><blockquote><p><code>group_walk()</code> can be used when iterating on the groups is only desired for side effects.
It applies the formula to each group, and then silently returns its input.</p></blockquote><h1 id=changes-in-filter-and-slice>Changes in filter and slice
<a href=#changes-in-filter-and-slice><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Besides changes described previously related to preservation of the grouping structure,
<a href=https://dplyr.tidyverse.org/reference/filter.html target=_blank rel=noopener><code>filter()</code></a> and
<a href=https://dplyr.tidyverse.org/reference/slice.html target=_blank rel=noopener><code>slice()</code></a> now reorganize the data by groups for performance reasons:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>tibble</span><span class=p>(</span>
  <span class=n>x</span> <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>1</span><span class=p>),</span> 
  <span class=n>y</span> <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>3</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>5</span><span class=p>)</span>
<span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>filter</span><span class=p>(</span><span class=n>y</span> <span class=o>&lt;</span> <span class=m>5</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 4 x 2</span>
<span class=c1>#&gt; # Groups:   x [2]</span>
<span class=c1>#&gt;       x     y</span>
<span class=c1>#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class=c1>#&gt; 1     1     1</span>
<span class=c1>#&gt; 2     2     2</span>
<span class=c1>#&gt; 3     1     3</span>
<span class=c1>#&gt; 4     2     4</span>
</code></pre></div><blockquote><p>This has been reverted for <code>filter()</code> due to popular demand. Calling <code>filter()</code>
on a grouped data frame leaves the rows in the original order.</p></blockquote><h1 id=redesigned-hybrid-evaluation>Redesigned hybrid evaluation
<a href=#redesigned-hybrid-evaluation><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><h2 id=whats-hybrid-evaluation-again->What&rsquo;s hybrid evaluation again ?
<a href=#whats-hybrid-evaluation-again-><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Hybrid evaluation is used in
<a href=https://dplyr.tidyverse.org/reference/summarise.html target=_blank rel=noopener><code>summarise()</code></a> and
<a href=https://dplyr.tidyverse.org/reference/mutate.html target=_blank rel=noopener><code>mutate()</code></a> to replace
potential expensive R operations by native C++ code that is group aware.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>summarise</span><span class=p>(</span><span class=n>Petal.Length</span> <span class=o>=</span> <span class=nf>mean</span><span class=p>(</span><span class=n>Petal.Length</span><span class=p>))</span>
<span class=c1>#&gt; # A tibble: 3 x 2</span>
<span class=c1>#&gt;   Species    Petal.Length</span>
<span class=c1>#&gt;   &lt;fct&gt;             &lt;dbl&gt;</span>
<span class=c1>#&gt; 1 setosa             1.46</span>
<span class=c1>#&gt; 2 versicolor         4.26</span>
<span class=c1>#&gt; 3 virginica          5.55</span>
</code></pre></div><p>In the example, the <code>base::mean()</code> function is never called because the
hybrid alternative can directly calculate the mean for each group. Hybrid
evaluation typically gives better performance because it needs fewer memory
allocations.</p><p>In this example, a standard evaluation path would need to:</p><ul><li>create subsets of the <code>Petal.Length</code> column for each group</li><li>call the <code>base::mean()</code> function on each subset, which would also
imply a cost for S3 dispatching to the right method</li><li>collect all results in a new vector</li></ul><p>In constrast, hybrid evaluation can directly allocate the final
vector, and calculate all 3 means without having to allocate the subsets.</p><h2 id=flaws-in-previous-version>Flaws in previous version
<a href=#flaws-in-previous-version><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Previous versions of hybrid evaluation relied on folding to
replace part of the expression by their hybrid result. For example,
there are hybrid versions of <code>sum()</code> and <code>n()</code>, so previous
versions attempted to use them for:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>summarise</span><span class=p>(</span><span class=n>Petal.Length</span> <span class=o>=</span> <span class=nf>sum</span><span class=p>(</span><span class=n>Petal.Length</span><span class=p>)</span> <span class=o>/</span> <span class=nf>n</span><span class=p>())</span>
<span class=c1>#&gt; # A tibble: 3 x 2</span>
<span class=c1>#&gt;   Species    Petal.Length</span>
<span class=c1>#&gt;   &lt;fct&gt;             &lt;dbl&gt;</span>
<span class=c1>#&gt; 1 setosa             1.46</span>
<span class=c1>#&gt; 2 versicolor         4.26</span>
<span class=c1>#&gt; 3 virginica          5.55</span>
</code></pre></div><p>The gain of replacing parts of the expression with the result of the
hybrid versions was minimal, and the we had to rely on
brittle heuristics to try to respect standard R evaluation semantics.</p><h2 id=new-implementation>New implementation
<a href=#new-implementation><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The new hybrid system is stricter and falls back to standard R evaluation
when the expression is not entirely recognized.</p><p>The
<a href=https://dplyr.tidyverse.org/reference/hybrid_call.html target=_blank rel=noopener><code>hybrid_call()</code></a> function (subject to change) can be used to test if an expression
would be handled by hybrid or standard evaluation:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> <span class=nf>hybrid_call</span><span class=p>(</span><span class=nf>mean</span><span class=p>(</span><span class=n>Sepal.Length</span><span class=p>))</span>
<span class=c1>#&gt; &lt;hybrid evaluation&gt;</span>
<span class=c1>#&gt;   call      : base::mean(Sepal.Length)</span>
<span class=c1>#&gt;   C++ class : dplyr::hybrid::internal::SimpleDispatchImpl&lt;14, false, dplyr::NaturalDataFrame, dplyr::hybrid::internal::MeanImpl&gt;</span>
<span class=n>iris</span> <span class=o>%&gt;%</span> <span class=nf>hybrid_call</span><span class=p>(</span><span class=nf>sum</span><span class=p>(</span><span class=n>Sepal.Length</span><span class=p>)</span> <span class=o>/</span> <span class=nf>n</span><span class=p>())</span>
<span class=c1>#&gt; &lt;standard evaluation&gt;</span>
<span class=c1>#&gt;   call      : sum(Sepal.Length)/n()</span>
<span class=n>iris</span> <span class=o>%&gt;%</span> <span class=nf>hybrid_call</span><span class=p>(</span><span class=o>+</span><span class=nf>mean</span><span class=p>(</span><span class=n>Sepal.Length</span><span class=p>))</span>
<span class=c1>#&gt; &lt;standard evaluation&gt;</span>
<span class=c1>#&gt;   call      : +mean(Sepal.Length)</span>
</code></pre></div><p>Hybrid is very picky about what it can handle, for example <code>TRUE</code> and <code>FALSE</code>
are fine for <code>na.rm=</code> because they are reserved words that can&rsquo;t be replaced, but
<code>T</code>, <code>F</code> or any expression that would resolve to a scalar logical are not:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> <span class=nf>hybrid_call</span><span class=p>(</span><span class=nf>mean</span><span class=p>(</span><span class=n>Sepal.Length</span><span class=p>,</span> <span class=n>na.rm</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>))</span>
<span class=c1>#&gt; &lt;hybrid evaluation&gt;</span>
<span class=c1>#&gt;   call      : base::mean(Sepal.Length, na.rm = TRUE)</span>
<span class=c1>#&gt;   C++ class : dplyr::hybrid::internal::SimpleDispatchImpl&lt;14, true, dplyr::NaturalDataFrame, dplyr::hybrid::internal::MeanImpl&gt;</span>
<span class=n>iris</span> <span class=o>%&gt;%</span> <span class=nf>hybrid_call</span><span class=p>(</span><span class=nf>mean</span><span class=p>(</span><span class=n>Sepal.Length</span><span class=p>,</span> <span class=n>na.rm</span> <span class=o>=</span> <span class=bp>T</span><span class=p>))</span>
<span class=c1>#&gt; &lt;standard evaluation&gt;</span>
<span class=c1>#&gt;   call      : mean(Sepal.Length, na.rm = T)</span>
<span class=n>iris</span> <span class=o>%&gt;%</span> <span class=nf>hybrid_call</span><span class=p>(</span><span class=nf>mean</span><span class=p>(</span><span class=n>Sepal.Length</span><span class=p>,</span> <span class=n>na.rm</span> <span class=o>=</span> <span class=m>1</span> <span class=o>==</span> <span class=m>1</span><span class=p>))</span>
<span class=c1>#&gt; &lt;standard evaluation&gt;</span>
<span class=c1>#&gt;   call      : mean(Sepal.Length, na.rm = 1 == 1)</span>
</code></pre></div><p>The first step of the new hybrid system consists of studying the
expression and compare it to known expression patterns. If we find an exact
match, then we have all the information we need, and R is never called
to materialize the result.</p><p>When there is no match, the expression gets evaluated for each group using R standard
evaluation rules in the data mask: a special environment that makes the
columns available and uses contextual information for functions such as
<a href=https://dplyr.tidyverse.org/reference/n.html target=_blank rel=noopener><code>n()</code></a>
and
<a href=https://dplyr.tidyverse.org/reference/row_number.html target=_blank rel=noopener><code>row_number()</code></a>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>%&gt;%</span> 
  <span class=nf>group_by</span><span class=p>(</span><span class=n>Species</span><span class=p>)</span> <span class=o>%&gt;%</span> 
  <span class=nf>summarise</span><span class=p>(</span><span class=n>Petal.Length</span> <span class=o>=</span> <span class=nf>sum</span><span class=p>(</span><span class=n>Petal.Length</span><span class=p>)</span> <span class=o>/</span> <span class=nf>n</span><span class=p>())</span>
<span class=c1>#&gt; # A tibble: 3 x 2</span>
<span class=c1>#&gt;   Species    Petal.Length</span>
<span class=c1>#&gt;   &lt;fct&gt;             &lt;dbl&gt;</span>
<span class=c1>#&gt; 1 setosa             1.46</span>
<span class=c1>#&gt; 2 versicolor         4.26</span>
<span class=c1>#&gt; 3 virginica          5.55</span>
</code></pre></div><h1 id=performance>Performance
<a href=#performance><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>When
<a href=https://dplyr.tidyverse.org/reference/summarise.html target=_blank rel=noopener><code>summarise()</code></a> or
<a href=https://dplyr.tidyverse.org/reference/mutate.html target=_blank rel=noopener><code>mutate()</code></a> use expressions that cannot be handled by
hybrid evaluation, they call back to R from the C++ internals for each group.</p><p>This is an expensive operation because the expressions have to be evaluated
with extra care. Traditionally it meant wrapping the expression in an R <code>tryCatch()</code>
before evaluating, but R 3.5.0 has added unwind protection which we
<a href=https://github.com/RcppCore/Rcpp/pull/873 target=_blank rel=noopener>exposed to
Rcpp</a>. Consequently, the cost of evaluating an R expression carefully is lower
than before.</p><p>We ran a benchmark calculating the means of 10,000 small groups with the
release version of dplyr and this release candidate with and without
using the unwind protect feature.</p><p>Just using the <code>mean()</code> function would not illustrate the feature, because dplyr would
use hybrid evaluation and never use callbacks to R. So instead we defined a <code>mean_</code>
function that has the same body as <code>base::mean()</code>. We also compare this to
the expression <code>sum(x) / n()</code> because it woudld have been handled by
partial hybrid evaluation in previous versions.</p><p><img src=/articles/2018-12-dplyr-0-8-0_files/timings_summarise_mean.jpeg alt></p><p>This is not a comprehensive benchmark analysis, but on this small example we can read:</p><ul><li>unwind protection has no impact when using the hybrid evaluation, this is not a surprise
because the hybrid path does not call back to R.</li><li>hybrid evaluation performs better on the release candidate. This is a direct consequence of
the redesign of hybrid evaluation.</li><li>unwind protection gives a performance boost <code>mean_()</code>. Please note that the
x axis is on a log scale.</li><li>unwind protection more than compensates for no longer using partial hybrid evaluation.</li></ul><h1 id=nest_join>nest_join
<a href=#nest_join><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>The
<a href=https://dplyr.tidyverse.org/reference/nest_join.html target=_blank rel=noopener><code>nest_join()</code></a> function is the newest addition to the join family.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>band_members</span> <span class=o>%&gt;%</span> 
  <span class=nf>nest_join</span><span class=p>(</span><span class=n>band_instruments</span><span class=p>)</span>
<span class=c1>#&gt; Joining, by = &#34;name&#34;</span>
<span class=c1>#&gt; # A tibble: 3 x 3</span>
<span class=c1>#&gt;   name  band    band_instruments</span>
<span class=c1>#&gt; * &lt;chr&gt; &lt;chr&gt;   &lt;list&gt;          </span>
<span class=c1>#&gt; 1 Mick  Stones  &lt;tibble [0 √ó 1]&gt;</span>
<span class=c1>#&gt; 2 John  Beatles &lt;tibble [1 √ó 1]&gt;</span>
<span class=c1>#&gt; 3 Paul  Beatles &lt;tibble [1 √ó 1]&gt;</span>
</code></pre></div><p>A nest join of <code>x</code> and <code>y</code> returns all rows and all columns from <code>x</code>, plus an additional column
that contains a list of tibbles. Each tibble contains all the rows from <code>y</code> that match that row of <code>x</code>.
When there is no match, the list column is a 0-row tibble with the same column names and types as <code>y</code>.</p><p><a href=https://dplyr.tidyverse.org/reference/nest_join.html target=_blank rel=noopener><code>nest_join()</code></a> is the most fundamental join since you can recreate the other joins from it:</p><ul><li><a href=https://dplyr.tidyverse.org/reference/inner_join.html target=_blank rel=noopener><code>inner_join()</code></a> is a
<a href=https://dplyr.tidyverse.org/reference/nest_join.html target=_blank rel=noopener><code>nest_join()</code></a> plus an
<a href=https://tidyr.tidyverse.org/reference/unnest.html target=_blank rel=noopener><code>tidyr::unnest()</code></a></li><li><a href=https://dplyr.tidyverse.org/reference/left_join.html target=_blank rel=noopener><code>left_join()</code></a> is a
<a href=https://dplyr.tidyverse.org/reference/nest_join.html target=_blank rel=noopener><code>nest_join()</code></a> plus an
<a href=https://tidyr.tidyverse.org/reference/unnest.html target=_blank rel=noopener><code>tidyr::unnest()</code></a> with <code>drop=TRUE</code></li><li><a href=https://dplyr.tidyverse.org/reference/semi_join.html target=_blank rel=noopener><code>semi_join()</code></a> is a
<a href=https://dplyr.tidyverse.org/reference/nest_join.html target=_blank rel=noopener><code>nest_join()</code></a> plus a
<a href=https://dplyr.tidyverse.org/reference/filter.html target=_blank rel=noopener><code>filter()</code></a> where you check that every element of data has at least one row.</li><li><a href=https://dplyr.tidyverse.org/reference/anti_join.html target=_blank rel=noopener><code>anti_join()</code></a> is a
<a href=https://dplyr.tidyverse.org/reference/nest_join.html target=_blank rel=noopener><code>nest_join()</code></a> plus a
<a href=https://dplyr.tidyverse.org/reference/filter.html target=_blank rel=noopener><code>filter()</code></a> where you check every element has zero rows.</li></ul><h1 id=scoped-variants>Scoped variants
<a href=#scoped-variants><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>The scoped (or colwise) verbs are the set of verbs with <code>_at</code>, <code>_if</code> and <code>_all</code> suffixes.
These verbs apply a certain behaviour (for instance, a mutating or summarising operation) to a given
selection of columns. This release of dplyr improves the consistency of the syntax and the behaviour with grouped tibbles.</p><h2 id=a-purrr-like-syntax-for-passing-functions>A purrr-like syntax for passing functions
<a href=#a-purrr-like-syntax-for-passing-functions><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>In dplyr 0.8.0, we have implemented support for functions and purrr-style lambda functions:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>iris</span> <span class=o>&lt;-</span> <span class=nf>as_tibble</span><span class=p>(</span><span class=n>iris</span><span class=p>)</span> <span class=c1># For concise print method</span>

<span class=nf>mutate_if</span><span class=p>(</span><span class=n>iris</span><span class=p>,</span> <span class=n>is.numeric</span><span class=p>,</span> <span class=o>~</span> <span class=n>. </span><span class=o>-</span> <span class=nf>mean</span><span class=p>(</span><span class=n>.)</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 150 x 5</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span>
<span class=c1>#&gt;  1       -0.743      0.443         -2.36      -0.999 setosa </span>
<span class=c1>#&gt;  2       -0.943     -0.0573        -2.36      -0.999 setosa </span>
<span class=c1>#&gt;  3       -1.14       0.143         -2.46      -0.999 setosa </span>
<span class=c1>#&gt;  4       -1.24       0.0427        -2.26      -0.999 setosa </span>
<span class=c1>#&gt;  5       -0.843      0.543         -2.36      -0.999 setosa </span>
<span class=c1>#&gt;  6       -0.443      0.843         -2.06      -0.799 setosa </span>
<span class=c1>#&gt;  7       -1.24       0.343         -2.36      -0.899 setosa </span>
<span class=c1>#&gt;  8       -0.843      0.343         -2.26      -0.999 setosa </span>
<span class=c1>#&gt;  9       -1.44      -0.157         -2.36      -0.999 setosa </span>
<span class=c1>#&gt; 10       -0.943      0.0427        -2.26      -1.10  setosa </span>
<span class=c1>#&gt; # ‚Ä¶ with 140 more rows</span>
</code></pre></div><p>And lists of functions and purrr-style lambda functions:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>fns</span> <span class=o>&lt;-</span> <span class=nf>list</span><span class=p>(</span>
  <span class=n>centered</span> <span class=o>=</span> <span class=n>mean</span><span class=p>,</span>                <span class=c1># Function object</span>
  <span class=n>scaled</span> <span class=o>=</span> <span class=o>~</span> <span class=n>. </span><span class=o>-</span> <span class=nf>mean</span><span class=p>(</span><span class=n>.)</span> <span class=o>/</span> <span class=nf>sd</span><span class=p>(</span><span class=n>.)</span>  <span class=c1># Purrr-style lambda</span>
<span class=p>)</span>
<span class=nf>mutate_if</span><span class=p>(</span><span class=n>iris</span><span class=p>,</span> <span class=n>is.numeric</span><span class=p>,</span> <span class=n>fns</span><span class=p>)</span>
<span class=c1>#&gt; # A tibble: 150 x 13</span>
<span class=c1>#&gt;    Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class=c1>#&gt;           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span>
<span class=c1>#&gt;  1          5.1         3.5          1.4         0.2 setosa </span>
<span class=c1>#&gt;  2          4.9         3            1.4         0.2 setosa </span>
<span class=c1>#&gt;  3          4.7         3.2          1.3         0.2 setosa </span>
<span class=c1>#&gt;  4          4.6         3.1          1.5         0.2 setosa </span>
<span class=c1>#&gt;  5          5           3.6          1.4         0.2 setosa </span>
<span class=c1>#&gt;  6          5.4         3.9          1.7         0.4 setosa </span>
<span class=c1>#&gt;  7          4.6         3.4          1.4         0.3 setosa </span>
<span class=c1>#&gt;  8          5           3.4          1.5         0.2 setosa </span>
<span class=c1>#&gt;  9          4.4         2.9          1.4         0.2 setosa </span>
<span class=c1>#&gt; 10          4.9         3.1          1.5         0.1 setosa </span>
<span class=c1>#&gt; # ‚Ä¶ with 140 more rows, and 8 more variables: Sepal.Length_centered &lt;dbl&gt;,</span>
<span class=c1>#&gt; #   Sepal.Width_centered &lt;dbl&gt;, Petal.Length_centered &lt;dbl&gt;,</span>
<span class=c1>#&gt; #   Petal.Width_centered &lt;dbl&gt;, Sepal.Length_scaled &lt;dbl&gt;,</span>
<span class=c1>#&gt; #   Sepal.Width_scaled &lt;dbl&gt;, Petal.Length_scaled &lt;dbl&gt;,</span>
<span class=c1>#&gt; #   Petal.Width_scaled &lt;dbl&gt;</span>
</code></pre></div><p>This is now the preferred syntax for passing functions to the scoped verbs because it is simpler and consistent with purrr.
Counting from dplyr 0.8.0, the hybrid evaluator recognises and inlines these lambdas, so that native implementation of
common algorithms will kick in just as it did with expressions passed with <code>funs()</code>.
Consequently, we are soft-deprecating <code>funs()</code>: it will continue to work without any warnings for now,
but will eventually start issuing warnings.</p><h2 id=behaviour-with-grouped-tibbles>Behaviour with grouped tibbles
<a href=#behaviour-with-grouped-tibbles><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We have reviewed the documentation of all scoped variants to make clear how the scoped operations
are applied to grouped tibbles. For most of the scoped verbs, the operations also apply on
the grouping variables when they are part of the selection. This includes:</p><ul><li><a href=https://dplyr.tidyverse.org/reference/arrange_all.html target=_blank rel=noopener><code>arrange_all()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/arrange_at.html target=_blank rel=noopener><code>arrange_at()</code></a>, and
<a href=https://dplyr.tidyverse.org/reference/arrange_if.html target=_blank rel=noopener><code>arrange_if()</code></a></li><li><a href=https://dplyr.tidyverse.org/reference/distinct_all.html target=_blank rel=noopener><code>distinct_all()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/distinct_at.html target=_blank rel=noopener><code>distinct_at()</code></a>, and
<a href=https://dplyr.tidyverse.org/reference/distinct_if.html target=_blank rel=noopener><code>distinct_if()</code></a></li><li><a href=https://dplyr.tidyverse.org/reference/filter_all.html target=_blank rel=noopener><code>filter_all()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/filter_at.html target=_blank rel=noopener><code>filter_at()</code></a>, and
<a href=https://dplyr.tidyverse.org/reference/filter_if.html target=_blank rel=noopener><code>filter_if()</code></a></li><li><a href=https://dplyr.tidyverse.org/reference/group_by_all.html target=_blank rel=noopener><code>group_by_all()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/group_by_at.html target=_blank rel=noopener><code>group_by_at()</code></a>, and
<a href=https://dplyr.tidyverse.org/reference/group_by_if.html target=_blank rel=noopener><code>group_by_if()</code></a></li><li><a href=https://dplyr.tidyverse.org/reference/select_all.html target=_blank rel=noopener><code>select_all()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/select_at.html target=_blank rel=noopener><code>select_at()</code></a>, and
<a href=https://dplyr.tidyverse.org/reference/select_if.html target=_blank rel=noopener><code>select_if()</code></a></li></ul><p>This is not the case for summarising and mutating variants where operations are <em>not</em> applied on grouping variables.
The behaviour depends on whether the selection is <strong>implicit</strong> (<code>all</code> and <code>if</code> selections) or <strong>explicit</strong> (<code>at</code> selections).
Grouping variables covered by explicit selections (with
<a href=https://dplyr.tidyverse.org/reference/summarise_at.html target=_blank rel=noopener><code>summarise_at()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/mutate_at.html target=_blank rel=noopener><code>mutate_at()</code></a>, and
<a href=https://dplyr.tidyverse.org/reference/transmute_at.html target=_blank rel=noopener><code>transmute_at()</code></a> are always an error.
For implicit selections, the grouping variables are always ignored. In this case, the level of verbosity depends on the kind of operation:</p><ul><li><p>Summarising operations (
<a href=https://dplyr.tidyverse.org/reference/summarise_all.html target=_blank rel=noopener><code>summarise_all()</code></a> and
<a href=https://dplyr.tidyverse.org/reference/summarise_if.html target=_blank rel=noopener><code>summarise_if()</code></a>
ignore grouping variables silently because it is obvious that
operations are not applied on grouping variables.</p></li><li><p>On the other hand, it isn&rsquo;t as obvious in the case of mutating operations (
<a href=https://dplyr.tidyverse.org/reference/mutate_all.html target=_blank rel=noopener><code>mutate_all()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/mutate_if.html target=_blank rel=noopener><code>mutate_if()</code></a>,
<a href=https://dplyr.tidyverse.org/reference/transmute_all.html target=_blank rel=noopener><code>transmute_all()</code></a>, and
<a href=https://dplyr.tidyverse.org/reference/transmute_if.html target=_blank rel=noopener><code>transmute_if()</code></a>).
For this reason, they issue a message indicating which grouping variables are ignored.</p></li></ul><p>In order to make it easier to explicitly remove the grouping columns from an <code>_at</code> selection, we have introduced a
new selection helper
<a href=https://dplyr.tidyverse.org/reference/group_cols.html target=_blank rel=noopener><code>group_cols()</code></a>. Just like
<a href=https://dplyr.tidyverse.org/reference/last_col.html target=_blank rel=noopener><code>last_col()</code></a> matches the last column of a tibble,
<a href=https://dplyr.tidyverse.org/reference/group_cols.html target=_blank rel=noopener><code>group_cols()</code></a> matches all grouping columns:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>mtcars</span> <span class=o>%&gt;%</span>
  <span class=nf>group_by</span><span class=p>(</span><span class=n>cyl</span><span class=p>)</span> <span class=o>%&gt;%</span>
  <span class=nf>select</span><span class=p>(</span><span class=nf>group_cols</span><span class=p>())</span>
<span class=c1>#&gt; # A tibble: 32 x 1</span>
<span class=c1>#&gt; # Groups:   cyl [3]</span>
<span class=c1>#&gt;      cyl</span>
<span class=c1>#&gt;  * &lt;dbl&gt;</span>
<span class=c1>#&gt;  1     6</span>
<span class=c1>#&gt;  2     6</span>
<span class=c1>#&gt;  3     4</span>
<span class=c1>#&gt;  4     6</span>
<span class=c1>#&gt;  5     8</span>
<span class=c1>#&gt;  6     6</span>
<span class=c1>#&gt;  7     8</span>
<span class=c1>#&gt;  8     4</span>
<span class=c1>#&gt;  9     4</span>
<span class=c1>#&gt; 10     6</span>
<span class=c1>#&gt; # ‚Ä¶ with 22 more rows</span>
</code></pre></div><p>This new helper is mostly intended for selection in scoped variants:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>mtcars</span> <span class=o>%&gt;%</span>
  <span class=nf>group_by</span><span class=p>(</span><span class=n>cyl</span><span class=p>)</span> <span class=o>%&gt;%</span>
  <span class=nf>mutate_at</span><span class=p>(</span>
    <span class=nf>vars</span><span class=p>(</span><span class=nf>starts_with</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>)),</span>
    <span class=o>~</span> <span class=n>. </span><span class=o>-</span> <span class=nf>mean</span><span class=p>(</span><span class=n>.)</span>
  <span class=p>)</span>
<span class=c1>#&gt; Error: Column `cyl` can&#39;t be modified because it&#39;s a grouping variable</span>
</code></pre></div><p>It makes it easy to remove explicitly the grouping variables:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>mtcars</span> <span class=o>%&gt;%</span>
  <span class=nf>group_by</span><span class=p>(</span><span class=n>cyl</span><span class=p>)</span> <span class=o>%&gt;%</span>
  <span class=nf>mutate_at</span><span class=p>(</span>
    <span class=nf>vars</span><span class=p>(</span><span class=nf>starts_with</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>),</span> <span class=o>-</span><span class=nf>group_cols</span><span class=p>()),</span>
    <span class=o>~</span> <span class=n>. </span><span class=o>-</span> <span class=nf>mean</span><span class=p>(</span><span class=n>.)</span>
  <span class=p>)</span>
<span class=c1>#&gt; # A tibble: 32 x 11</span>
<span class=c1>#&gt; # Groups:   cyl [3]</span>
<span class=c1>#&gt;      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear   carb</span>
<span class=c1>#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class=c1>#&gt;  1  21       6  160    110  3.9   2.62  16.5     0     1     4  0.571</span>
<span class=c1>#&gt;  2  21       6  160    110  3.9   2.88  17.0     0     1     4  0.571</span>
<span class=c1>#&gt;  3  22.8     4  108     93  3.85  2.32  18.6     1     1     4 -0.545</span>
<span class=c1>#&gt;  4  21.4     6  258    110  3.08  3.22  19.4     1     0     3 -2.43 </span>
<span class=c1>#&gt;  5  18.7     8  360    175  3.15  3.44  17.0     0     0     3 -1.5  </span>
<span class=c1>#&gt;  6  18.1     6  225    105  2.76  3.46  20.2     1     0     3 -2.43 </span>
<span class=c1>#&gt;  7  14.3     8  360    245  3.21  3.57  15.8     0     0     3  0.5  </span>
<span class=c1>#&gt;  8  24.4     4  147.    62  3.69  3.19  20       1     0     4  0.455</span>
<span class=c1>#&gt;  9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4  0.455</span>
<span class=c1>#&gt; 10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4  0.571</span>
<span class=c1>#&gt; # ‚Ä¶ with 22 more rows</span>
</code></pre></div></div></div><div class=column25><div class="section hideOnMobile"><div class=sectionTitle>Contents</div><nav id=TableOfContents><ul><li><a href=#group-creation>Group creation</a></li><li><a href=#group-preservation>Group preservation</a></li><li><a href=#new-grouping-fuctions>New grouping fuctions</a></li><li><a href=#iterate-on-grouped-tibbles-by-group>Iterate on grouped tibbles by group</a></li></ul><ul><li><a href=#whats-hybrid-evaluation-again->What&rsquo;s hybrid evaluation again ?</a></li><li><a href=#flaws-in-previous-version>Flaws in previous version</a></li><li><a href=#new-implementation>New implementation</a></li></ul><ul><li><a href=#a-purrr-like-syntax-for-passing-functions>A purrr-like syntax for passing functions</a></li><li><a href=#behaviour-with-grouped-tibbles>Behaviour with grouped tibbles</a></li></ul></nav></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>