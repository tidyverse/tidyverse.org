<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>`dplyr::if_else()` and `dplyr::case_when()` are up to 30x faster</title><meta property="og:title" content="`dplyr::if_else()` and `dplyr::case_when()` are up to 30x faster"><meta property="og:description" content="dplyr 1.2.0 comes with much faster and more memory efficient `if_else()` and `case_when()` functions!"><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2026/02/dplyr-performance/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="`dplyr::if_else()` and `dplyr::case_when()` are up to 30x faster - Tidyverse"><meta property="description" content="dplyr 1.2.0 comes with much faster and more memory efficient `if_else()` and `case_when()` functions!"><meta property="og:description" content="dplyr 1.2.0 comes with much faster and more memory efficient `if_else()` and `case_when()` functions!"><meta property="og:image" content="https://www.tidyverse.org/blog/2026/02/dplyr-performance/thumbnail-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2026/02/dplyr-performance/thumbnail-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title><code>dplyr::if_else()</code> and <code>dplyr::case_when()</code> are up to 30x faster</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2026/02/dplyr-performance/thumbnail-wd.jpg></div><div class=photoCredit>Photo by <a href=https://unsplash.com/photos/ZbFoi92fyzY>Jahanzeb Ahsan</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2026/02/10</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/dplyr/>dplyr</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Davis Vaughan</p><div class=article-content><p>In this technical post, we&rsquo;ll dive into some performance improvements we&rsquo;ve made to dplyr 1.2.0 to make
<a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>if_else()</code></a> and
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> up to 30x faster and use up to 10x less memory.</p><p>If you haven&rsquo;t seen our
<a href=https://tidyverse.org/blog/2026/02/dplyr-1-2-0/ target=_blank rel=noopener>previous post</a> about the exciting new features in dplyr 1.2.0, you&rsquo;ll want to go check that out first!</p><p>Here&rsquo;s a before-and-after benchmark with
<a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>if_else()</code></a>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=c># Using https://github.com/DavisVaughan/cross</span></span>
<span><span class=nf>cross</span><span class=nf>::</span><span class=nf><a href=https://rdrr.io/pkg/cross/man/bench_versions.html>bench_versions</a></span><span class=o>(</span>pkgs <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"tidyverse/dplyr@v1.1.4"</span>, <span class=s>"tidyverse/dplyr"</span><span class=o>)</span>, <span class=o>&#123;</span></span>
<span>  <span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://dplyr.tidyverse.org>dplyr</a></span><span class=o>)</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/Random.html>set.seed</a></span><span class=o>(</span><span class=m>123</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nv>condition</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=kc>TRUE</span>, <span class=kc>FALSE</span>, <span class=kc>NA</span><span class=o>)</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span>  <span class=nv>x</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span>  <span class=nv>y</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span>  <span class=nv>z</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf>bench</span><span class=nf>::</span><span class=nf><a href=https://bench.r-lib.org/reference/mark.html>mark</a></span><span class=o>(</span>if_else <span class=o>=</span> <span class=nf><a href=https://dplyr.tidyverse.org/reference/if_else.html>if_else</a></span><span class=o>(</span><span class=nv>condition</span>, <span class=nv>x</span>, <span class=nv>y</span>, missing <span class=o>=</span> <span class=nv>z</span><span class=o>)</span><span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span></code></pre></div><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=c1>#&gt; # A tibble: 2 × 6</span>
<span class=c1>#&gt;   pkg                    expression      min   median `itr/sec` mem_alloc</span>
<span class=c1>#&gt;   &lt;chr&gt;                  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span>
<span class=c1>#&gt; 1 tidyverse/dplyr@v1.1.4 if_else    248.25ms 249.25ms      4.02   381.6MB</span>
<span class=c1>#&gt; 2 tidyverse/dplyr        if_else      7.27ms   7.51ms    132.      38.2MB</span>
</code></pre></div><p>And with
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf>cross</span><span class=nf>::</span><span class=nf><a href=https://rdrr.io/pkg/cross/man/bench_versions.html>bench_versions</a></span><span class=o>(</span>pkgs <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"tidyverse/dplyr@v1.1.4"</span>, <span class=s>"tidyverse/dplyr"</span><span class=o>)</span>, <span class=o>&#123;</span></span>
<span>  <span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://dplyr.tidyverse.org>dplyr</a></span><span class=o>)</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/Random.html>set.seed</a></span><span class=o>(</span><span class=m>123</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nv>column</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>100</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nv>x_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>20</span></span>
<span>  <span class=nv>y_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>50</span></span>
<span>  <span class=nv>z_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>80</span></span>
<span></span>
<span>  <span class=nv>x</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span>  <span class=nv>y</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span>  <span class=nv>z</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf>bench</span><span class=nf>::</span><span class=nf><a href=https://bench.r-lib.org/reference/mark.html>mark</a></span><span class=o>(</span></span>
<span>    case_when <span class=o>=</span> <span class=nf><a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html>case_when</a></span><span class=o>(</span></span>
<span>      <span class=nv>x_condition</span> <span class=o>~</span> <span class=nv>x</span>,</span>
<span>      <span class=nv>y_condition</span> <span class=o>~</span> <span class=nv>y</span>,</span>
<span>      <span class=nv>z_condition</span> <span class=o>~</span> <span class=nv>z</span></span>
<span>    <span class=o>)</span></span>
<span>  <span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span></code></pre></div><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=c1>#&gt; # A tibble: 2 × 6</span>
<span class=c1>#&gt;   pkg                    expression      min   median `itr/sec` mem_alloc</span>
<span class=c1>#&gt;   &lt;chr&gt;                  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span>
<span class=c1>#&gt; 1 tidyverse/dplyr@v1.1.4 case_when   228.3ms  231.2ms      4.33   419.9MB</span>
<span class=c1>#&gt; 2 tidyverse/dplyr        case_when    15.5ms   15.8ms     62.8     38.3MB</span>
</code></pre></div><p>So a 33x speed improvement for
<a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>if_else()</code></a>, a 15x speed improvement for
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a>, and a 10x improvement in memory usage for both! In the rest of this post, we&rsquo;ll explain how we&rsquo;ve achieved these numbers.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://dplyr.tidyverse.org>dplyr</a></span><span class=o>)</span></span></code></pre></div><h2 id=lets-talk-memory>Let&rsquo;s talk memory
<a href=#lets-talk-memory><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We&rsquo;ll start with
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a>, because
<a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>if_else()</code></a> is actually just a small variant of that.</p><p>The most important place to start is with the memory usage. Memory usage and raw speed are often related, as allocating memory takes time. Let&rsquo;s look at the memory usage of
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> in dplyr 1.1.4:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/Random.html>set.seed</a></span><span class=o>(</span><span class=m>123</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>column</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>100</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>x_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>20</span></span>
<span><span class=nv>y_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>50</span></span>
<span><span class=nv>z_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>80</span></span>
<span></span>
<span><span class=nv>x</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>y</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>z</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span></code></pre></div><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>profmem</span><span class=o>::</span><span class=nf>profmem</span><span class=p>(</span>
  <span class=n>threshold</span> <span class=o>=</span> <span class=m>1000</span><span class=p>,</span>
  <span class=nf>case_when</span><span class=p>(</span>
    <span class=n>x_condition</span> <span class=o>~</span> <span class=n>x</span><span class=p>,</span>
    <span class=n>y_condition</span> <span class=o>~</span> <span class=n>y</span><span class=p>,</span>
    <span class=n>z_condition</span> <span class=o>~</span> <span class=n>z</span>
  <span class=p>)</span>
<span class=p>)</span>
<span class=c1>#&gt; Rprofmem memory profiling of:</span>
<span class=c1>#&gt; case_when(x_condition ~ x, y_condition ~ y, z_condition ~ z)</span>
<span class=c1>#&gt;</span>
<span class=c1>#&gt; Memory allocations (&gt;= 1000 bytes):</span>
<span class=c1>#&gt;        what     bytes                                           calls</span>
<span class=c1>#&gt; 1     alloc  40000048     case_when() -&gt; vec_case_when() -&gt; vec_rep()</span>
<span class=c1>#&gt; 2     alloc  40000048                  case_when() -&gt; vec_case_when()</span>
<span class=c1>#&gt; 3     alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 4     alloc   7600664       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 5     alloc  40000048                  case_when() -&gt; vec_case_when()</span>
<span class=c1>#&gt; 6     alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 7     alloc  12003312       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 8     alloc  40000048                  case_when() -&gt; vec_case_when()</span>
<span class=c1>#&gt; 9     alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 10    alloc  11996112       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 11    alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 12    alloc   8400112       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 13    alloc   7600664   case_when() -&gt; vec_case_when() -&gt; vec_slice()</span>
<span class=c1>#&gt; 14    alloc  12003312   case_when() -&gt; vec_case_when() -&gt; vec_slice()</span>
<span class=c1>#&gt; 15    alloc  11996112   case_when() -&gt; vec_case_when() -&gt; vec_slice()</span>
<span class=c1>#&gt; 16    alloc   8400112 case_when() -&gt; vec_case_when() -&gt; vec_recycle()</span>
<span class=c1>#&gt; 17    alloc  40000048 case_when() -&gt; vec_case_when() -&gt; list_unchop()</span>
<span class=c1>#&gt; total       440000864</span>
</code></pre></div><p>That&rsquo;s a lot of allocations! And it&rsquo;s pretty hard to understand where they are coming from without a bit more explanation. For that, we&rsquo;re actually going to &ldquo;manually&rdquo; implement an underpowered version of
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> for this example.</p><p>Here&rsquo;s a diagram of what we need to accomplish:</p><p><img src=./images/x-y-z-default.png alt></p><p>In bullets:</p><ul><li><code>x_condition</code> selects the blue elements of <code>x</code></li><li><code>y_condition</code> selects the red elements of <code>y</code></li><li><code>z_condition</code> selects the green elements of <code>z</code></li><li>A <code>default</code> is built around the unused locations</li><li>We combine all of the pieces into <code>out</code></li></ul><p>The trickiest part about
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> is handling places where <code>x_condition</code> and <code>y_condition</code> overlap. In the image, even though both <code>x</code> and <code>y</code> are selected at location 5, only the value of <code>x</code> is retained since it is hit &ldquo;first&rdquo;. This forces us to have to modify <code>y_condition</code> to avoid already &ldquo;used&rdquo; locations.</p><p>An R implementation that computes these modified locations might look like:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>n</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/length.html>length</a></span><span class=o>(</span><span class=nv>x_condition</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>unused</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/rep.html>rep</a></span><span class=o>(</span><span class=kc>TRUE</span>, times <span class=o>=</span> <span class=nv>n</span><span class=o>)</span> <span class=c># 1</span></span>
<span></span>
<span><span class=nv>x_loc</span> <span class=o>&lt;-</span> <span class=nv>unused</span> <span class=o>&amp;</span> <span class=nv>x_condition</span> <span class=c># 2</span></span>
<span><span class=nv>x_loc</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/which.html>which</a></span><span class=o>(</span><span class=nv>x_loc</span><span class=o>)</span> <span class=c># 3,4</span></span>
<span><span class=nv>unused</span><span class=o>[</span><span class=nv>x_loc</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=kc>FALSE</span></span>
<span></span>
<span><span class=nv>y_loc</span> <span class=o>&lt;-</span> <span class=nv>unused</span> <span class=o>&amp;</span> <span class=nv>y_condition</span> <span class=c># 5</span></span>
<span><span class=nv>y_loc</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/which.html>which</a></span><span class=o>(</span><span class=nv>y_loc</span><span class=o>)</span> <span class=c># 6,7</span></span>
<span><span class=nv>unused</span><span class=o>[</span><span class=nv>y_loc</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=kc>FALSE</span></span>
<span></span>
<span><span class=nv>z_loc</span> <span class=o>&lt;-</span> <span class=nv>unused</span> <span class=o>&amp;</span> <span class=nv>z_condition</span> <span class=c># 8</span></span>
<span><span class=nv>z_loc</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/which.html>which</a></span><span class=o>(</span><span class=nv>z_loc</span><span class=o>)</span> <span class=c># 9,10</span></span>
<span><span class=nv>unused</span><span class=o>[</span><span class=nv>z_loc</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=kc>FALSE</span></span></code></pre></div><p>Anything that is still <code>unused</code> falls through to the <code>default</code>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>default</span> <span class=o>&lt;-</span> <span class=kc>NA_integer_</span></span>
<span><span class=nv>default_loc</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/which.html>which</a></span><span class=o>(</span><span class=nv>unused</span><span class=o>)</span> <span class=c># 11,12</span></span></code></pre></div><p>With <code>x_loc</code>, <code>y_loc</code>, <code>z_loc</code>, and <code>default_loc</code> in hand, we can build the output from the pieces:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/vector.html>vector</a></span><span class=o>(</span><span class=s>"integer"</span>, length <span class=o>=</span> <span class=nv>n</span><span class=o>)</span> <span class=c># 17</span></span>
<span></span>
<span><span class=nv>out</span><span class=o>[</span><span class=nv>x_loc</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=nv>x</span><span class=o>[</span><span class=nv>x_loc</span><span class=o>]</span> <span class=c># 13</span></span>
<span><span class=nv>out</span><span class=o>[</span><span class=nv>y_loc</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=nv>y</span><span class=o>[</span><span class=nv>y_loc</span><span class=o>]</span> <span class=c># 14</span></span>
<span><span class=nv>out</span><span class=o>[</span><span class=nv>z_loc</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=nv>z</span><span class=o>[</span><span class=nv>z_loc</span><span class=o>]</span> <span class=c># 15</span></span>
<span></span>
<span><span class=nv>out</span><span class=o>[</span><span class=nv>default_loc</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/rep.html>rep</a></span><span class=o>(</span><span class=nv>default</span>, times <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/length.html>length</a></span><span class=o>(</span><span class=nv>default_loc</span><span class=o>)</span><span class=o>)</span> <span class=c># 16</span></span></code></pre></div><p>And sure enough, this is identical to
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/identical.html>identical</a></span><span class=o>(</span></span>
<span>  <span class=nv>out</span>,</span>
<span>  <span class=nf><a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html>case_when</a></span><span class=o>(</span></span>
<span>    <span class=nv>x_condition</span> <span class=o>~</span> <span class=nv>x</span>,</span>
<span>    <span class=nv>y_condition</span> <span class=o>~</span> <span class=nv>y</span>,</span>
<span>    <span class=nv>z_condition</span> <span class=o>~</span> <span class=nv>z</span></span>
<span>  <span class=o>)</span></span>
<span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] TRUE</span></span>
<span></span></code></pre></div><p>You might be wondering what all of the comments with numbers beside them mean. Those actually map 1:1 with the allocations that
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> was emitting. In fact, we can now split up those allocations into their respective role:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=c1>#&gt; # Tracking `unused` locations</span>
<span class=c1>#&gt; 1     alloc  40000048     case_when() -&gt; vec_case_when() -&gt; vec_rep()</span>

<span class=c1>#&gt; # Computing `x_loc`, `y_loc`, and `z_loc`</span>
<span class=c1>#&gt; 2     alloc  40000048                  case_when() -&gt; vec_case_when()</span>
<span class=c1>#&gt; 3     alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 4     alloc   7600664       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 5     alloc  40000048                  case_when() -&gt; vec_case_when()</span>
<span class=c1>#&gt; 6     alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 7     alloc  12003312       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 8     alloc  40000048                  case_when() -&gt; vec_case_when()</span>
<span class=c1>#&gt; 9     alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 10    alloc  11996112       case_when() -&gt; vec_case_when() -&gt; which()</span>

<span class=c1>#&gt; # Computing `default_loc`</span>
<span class=c1>#&gt; 11    alloc  40000056       case_when() -&gt; vec_case_when() -&gt; which()</span>
<span class=c1>#&gt; 12    alloc   8400112       case_when() -&gt; vec_case_when() -&gt; which()</span>

<span class=c1>#&gt; # Slicing `x`, `y`, and `z` to align with `x_loc`, `y_loc`, and `z_loc`</span>
<span class=c1>#&gt; 13    alloc   7600664   case_when() -&gt; vec_case_when() -&gt; vec_slice()</span>
<span class=c1>#&gt; 14    alloc  12003312   case_when() -&gt; vec_case_when() -&gt; vec_slice()</span>
<span class=c1>#&gt; 15    alloc  11996112   case_when() -&gt; vec_case_when() -&gt; vec_slice()</span>

<span class=c1>#&gt; # Recycling `default` of `NA` to align with `default_loc`</span>
<span class=c1>#&gt; 16    alloc   8400112 case_when() -&gt; vec_case_when() -&gt; vec_recycle()</span>

<span class=c1>#&gt; # Final output container, which we assign `x`, `y`, `z`, and `default` into</span>
<span class=c1>#&gt; # at locations `x_loc`, `y_loc`, and `z_loc`</span>
<span class=c1>#&gt; 17    alloc  40000048 case_when() -&gt; vec_case_when() -&gt; list_unchop()</span>
</code></pre></div><p>We sought to remove every one of these allocations except for the last one, which is the final output container that is returned to the user. In other words, we were after this, which is the actual profmem result of this
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> call in dplyr 1.2.0:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=c1>#&gt; Rprofmem memory profiling of:</span>
<span class=c1>#&gt; case_when(x_condition ~ x, y_condition ~ y, z_condition ~ z)</span>
<span class=c1>#&gt;</span>
<span class=c1>#&gt; Memory allocations (&gt;= 1000 bytes):</span>
<span class=c1>#&gt;        what    bytes                          calls</span>
<span class=c1>#&gt; 1     alloc 40000048 case_when() -&gt; vec_case_when()</span>
<span class=c1>#&gt; total       40000048</span>
</code></pre></div><h2 id=sliced-assignment>Sliced assignment
<a href=#sliced-assignment><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>To work towards this, let&rsquo;s focus on what happens to <code>x</code> throughout this process:</p><p><img src=./images/just-x.png alt></p><p>We had a hypothesis that we could cut out the intermediate work here. Ideally, we&rsquo;d take the logical LHS <code>x_condition</code> and the RHS <code>x</code> and map that straight into the output, with no extra allocations:</p><p><img src=./images/just-x-ideal.png alt></p><p>But this just wasn&rsquo;t possible with the way that assignment typically works in R!</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>x</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"a"</span>, <span class=s>"b"</span>, <span class=s>"c"</span>, <span class=s>"d"</span>, <span class=s>"e"</span>, <span class=s>"f"</span>, <span class=s>"g"</span><span class=o>)</span></span>
<span><span class=nv>x_condition</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=kc>FALSE</span>, <span class=kc>TRUE</span>, <span class=kc>FALSE</span>, <span class=kc>FALSE</span>, <span class=kc>TRUE</span>, <span class=kc>FALSE</span>, <span class=kc>FALSE</span><span class=o>)</span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/vector.html>vector</a></span><span class=o>(</span><span class=s>"character"</span>, length <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/length.html>length</a></span><span class=o>(</span><span class=nv>x_condition</span><span class=o>)</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>out</span><span class=o>[</span><span class=nv>x_condition</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=nv>x</span></span>
<span><span class=c>#&gt; Warning in out[x_condition] &lt;- x: number of items to replace is not a multiple of replacement length</span></span>
<span></span></code></pre></div><p>Instead, you must pre-slice <code>x</code> to a length that matches the locations that <code>x_condition</code> points to in <code>out</code>, i.e.:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>out</span><span class=o>[</span><span class=nv>x_condition</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=nv>x</span><span class=o>[</span><span class=nv>x_condition</span><span class=o>]</span></span></code></pre></div><p>Now, in
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> we don&rsquo;t actually use <code>[&lt;-</code> for assignment or <code>[</code> for slicing. Instead, we use tools from
<a href=https://vctrs.r-lib.org/ target=_blank rel=noopener>vctrs</a>, a low level package for building consistent tidyverse functions. In this case, we&rsquo;d use <code>vctrs::vec_assign()</code> and <code>vctrs::vec_slice()</code>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>x_condition</span>, <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_slice</a></span><span class=o>(</span><span class=nv>x</span>, <span class=nv>x_condition</span><span class=o>)</span><span class=o>)</span></span></code></pre></div><p>But <code>vec_assign()</code> had the same problem!</p><p>To solve this, we&rsquo;ve added a new boolean argument to <code>vec_assign()</code> called <code>slice_value</code>. You use it like this:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>x_condition</span>, <span class=nv>x</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span></code></pre></div><p>With <code>slice_value = TRUE</code>, <code>vec_assign()</code> assumes that both <code>out</code> and <code>x</code> are the same length and that <code>x_condition</code> applies to <em>both</em> of these. Internally, rather than materializing <code>x[x_condition]</code>, we instead just loop over both <code>out</code> and <code>x</code> at the same time (at C level) and copy over values from <code>x</code> whenever <code>x_condition</code> is <code>TRUE</code>.</p><p>This is huge! It means that allocations 13-15 from above related to slicing <code>x</code>, <code>y</code>, and <code>z</code> all disappear.</p><h2 id=logical-indices>Logical <code>i</code>ndices
<a href=#logical-indices><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>You might have noticed that we&rsquo;ve been using <code>which()</code> quite a bit in the above algorithm. This turns a logical vector of <code>TRUE</code> and <code>FALSE</code> into an integer vector of locations pointing to where the logical vector was <code>TRUE</code>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>x_condition</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=kc>TRUE</span>, <span class=kc>FALSE</span>, <span class=kc>TRUE</span>, <span class=kc>FALSE</span>, <span class=kc>FALSE</span>, <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>x_loc</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/which.html>which</a></span><span class=o>(</span><span class=nv>x_condition</span><span class=o>)</span></span>
<span><span class=nv>x_loc</span></span>
<span><span class=c>#&gt; [1] 1 3 6</span></span>
<span></span></code></pre></div><p>We perform this conversion up front due to how the following works at C level:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>out</span><span class=o>[</span><span class=nv>x_condition</span><span class=o>]</span> <span class=o>&lt;-</span> <span class=nv>x</span><span class=o>[</span><span class=nv>x_condition</span><span class=o>]</span></span></code></pre></div><p>Both <code>[</code> and <code>[&lt;-</code> will convert a logical <code>x_condition</code> into the integer <code>x_loc</code> form before proceeding with the assignment, meaning that <code>which()</code> gets called twice if we don&rsquo;t do it once up front. And vctrs is the same way! Both <code>vec_assign()</code> and <code>vec_slice()</code> here would convert <code>x_condition</code> to an integer vector.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>x_condition</span>, <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_slice</a></span><span class=o>(</span><span class=nv>x</span>, <span class=nv>x_condition</span><span class=o>)</span><span class=o>)</span></span></code></pre></div><p>Now, with the previous optimization we&rsquo;ve already seen that we can reduce this to:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>x_condition</span>, <span class=nv>x</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span></code></pre></div><p>But <code>vec_assign()</code> still converts a logical <code>x_condition</code> to integer locations internally before doing the assignment. So now it doesn&rsquo;t matter whether we do this conversion up front via <code>which()</code> or if we let <code>vec_assign()</code> do it, it still happens once per input. But we&rsquo;d like to avoid it entirely!</p><p>The solution here wasn&rsquo;t too magical, it just involved a good bit of grunt work. We&rsquo;ve added a path in <code>vec_assign()</code>'s
<a href=https://github.com/r-lib/vctrs/blob/94cea16b1ed3939aaa59c58dda75eedc75d6d075/src/slice-assign.c#L390-L417 target=_blank rel=noopener>C code</a> that can handle logical indices like <code>x_condition</code> directly, rather than forcing them to be converted to integer locations first.</p><p>But this is a huge win, because it means that allocations 1-10, which were all related to
<a href=https://rdrr.io/r/base/which.html target=_blank rel=noopener><code>which()</code></a>, can now be removed. <code>vec_assign()</code> will just handle that optimally for us without any extra allocations.</p><p>The nice part about an optimization like this is that any other existing code that is using <code>vec_assign()</code> with a logical index will also benefit from this without having to change a thing!</p><h2 id=default-handling><code>default</code> handling
<a href=#default-handling><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The remaining allocations are 11-12 and 16, which all have to do with the implied <code>default</code>. Allocations 11-12 were about figuring out where to put <code>default</code>, and allocation 16 was about recycling a typed size 1 <code>default</code> to the right size before assigning it into <code>out</code>.</p><p>As it turns out, we don&rsquo;t need any of this!</p><p>In vctrs, when we initialize any output container, we use <code>vec_init()</code>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_init.html>vec_init</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/integer.html>integer</a></span><span class=o>(</span><span class=o>)</span>, n <span class=o>=</span> <span class=m>5</span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] NA NA NA NA NA</span></span>
<span></span><span></span>
<span><span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_init.html>vec_init</a></span><span class=o>(</span><span class=nf><a href=https://tibble.tidyverse.org/reference/tibble.html>tibble</a></span><span class=o>(</span>x <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/integer.html>integer</a></span><span class=o>(</span><span class=o>)</span>, y <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/character.html>character</a></span><span class=o>(</span><span class=o>)</span><span class=o>)</span>, n <span class=o>=</span> <span class=m>5</span><span class=o>)</span></span>
<span><span class=c>#&gt; <span style=color:#555># A tibble: 5 × 2</span></span></span>
<span><span class=c>#&gt;       x y    </span></span>
<span><span class=c>#&gt;   <span style=color:#555;font-style:italic>&lt;int&gt;</span> <span style=color:#555;font-style:italic>&lt;chr&gt;</span></span></span>
<span><span class=c>#&gt; <span style=color:#555>1</span>    <span style=color:#b00>NA</span> <span style=color:#b00>NA</span>   </span></span>
<span><span class=c>#&gt; <span style=color:#555>2</span>    <span style=color:#b00>NA</span> <span style=color:#b00>NA</span>   </span></span>
<span><span class=c>#&gt; <span style=color:#555>3</span>    <span style=color:#b00>NA</span> <span style=color:#b00>NA</span>   </span></span>
<span><span class=c>#&gt; <span style=color:#555>4</span>    <span style=color:#b00>NA</span> <span style=color:#b00>NA</span>   </span></span>
<span><span class=c>#&gt; <span style=color:#555>5</span>    <span style=color:#b00>NA</span> <span style=color:#b00>NA</span></span></span>
<span></span></code></pre></div><p>This <em>already</em> has the implied <code>default</code> assigned to every location. We then overwrite this with <code>x</code>, <code>y</code>, and <code>z</code> at the appropriate locations, but anything left untouched by those is still set to the <code>default</code>, so we&rsquo;re done!</p><p>For cases where the user supplies their own <code>default</code>, things are slightly more complicated. We actually do have to compute a <code>default_loc</code> implied from <code>x_condition</code>, <code>y_condition</code>, and <code>z_condition</code>, but internally we do so using a C vector of <code>bool</code> (even more efficient than R&rsquo;s logical vector type), so the memory footprint is as small as it can be.</p><h2 id=the-first-wins-conundrum>The &ldquo;first wins&rdquo; conundrum
<a href=#the-first-wins-conundrum><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>One thing we&rsquo;ve skipped over is the &ldquo;first wins&rdquo; behavior of
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> mentioned earlier. Now that we&rsquo;ve removed <code>x_loc</code>, <code>y_loc</code>, and <code>z_loc</code>, which is where that was being handled, how do we keep this behavior without slowing things down?</p><p>To be explicit, we are talking about this feature of
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> where only the first hit is kept when you have overlapping logical indices:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>x</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"x1"</span>, <span class=s>"x2"</span>, <span class=s>"x3"</span><span class=o>)</span></span>
<span><span class=nv>y</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"y1"</span>, <span class=s>"y2"</span>, <span class=s>"y3"</span><span class=o>)</span></span>
<span><span class=nv>z</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"z1"</span>, <span class=s>"z2"</span>, <span class=s>"z3"</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>x_condition</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=kc>TRUE</span>, <span class=kc>FALSE</span>, <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>y_condition</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=kc>TRUE</span>, <span class=kc>TRUE</span>, <span class=kc>FALSE</span><span class=o>)</span></span>
<span><span class=nv>z_condition</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=kc>FALSE</span>, <span class=kc>TRUE</span>, <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span><span class=nf><a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html>case_when</a></span><span class=o>(</span></span>
<span>  <span class=nv>x_condition</span> <span class=o>~</span> <span class=nv>x</span>,</span>
<span>  <span class=nv>y_condition</span> <span class=o>~</span> <span class=nv>y</span>,</span>
<span>  <span class=nv>z_condition</span> <span class=o>~</span> <span class=nv>z</span></span>
<span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] "x1" "y2" "x3"</span></span>
<span></span></code></pre></div><p>A naive approach doesn&rsquo;t work, as you end up with &ldquo;last wins&rdquo; behavior:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_init.html>vec_init</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/character.html>character</a></span><span class=o>(</span><span class=o>)</span>, n <span class=o>=</span> <span class=m>3</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>x_condition</span>, <span class=nv>x</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>y_condition</span>, <span class=nv>y</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>z_condition</span>, <span class=nv>z</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span><span class=c># This is wrong!</span></span>
<span><span class=nv>out</span></span>
<span><span class=c>#&gt; [1] "y1" "z2" "z3"</span></span>
<span></span><span></span>
<span><span class=nf><a href=https://rdrr.io/r/base/identical.html>identical</a></span><span class=o>(</span></span>
<span>  <span class=nv>out</span>,</span>
<span>  <span class=nf><a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html>case_when</a></span><span class=o>(</span></span>
<span>    <span class=nv>x_condition</span> <span class=o>~</span> <span class=nv>x</span>,</span>
<span>    <span class=nv>y_condition</span> <span class=o>~</span> <span class=nv>y</span>,</span>
<span>    <span class=nv>z_condition</span> <span class=o>~</span> <span class=nv>z</span></span>
<span>  <span class=o>)</span></span>
<span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] FALSE</span></span>
<span></span></code></pre></div><p>Instead,
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> just <em>iterates in reverse</em>, assigning <code>z</code>, then <code>y</code>, then <code>x</code>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_init.html>vec_init</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/character.html>character</a></span><span class=o>(</span><span class=o>)</span>, n <span class=o>=</span> <span class=m>3</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>z_condition</span>, <span class=nv>z</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>y_condition</span>, <span class=nv>y</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/vec_slice.html>vec_assign</a></span><span class=o>(</span><span class=nv>out</span>, <span class=nv>x_condition</span>, <span class=nv>x</span>, slice_value <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span><span class=nf><a href=https://rdrr.io/r/base/identical.html>identical</a></span><span class=o>(</span></span>
<span>  <span class=nv>out</span>,</span>
<span>  <span class=nf><a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html>case_when</a></span><span class=o>(</span></span>
<span>    <span class=nv>x_condition</span> <span class=o>~</span> <span class=nv>x</span>,</span>
<span>    <span class=nv>y_condition</span> <span class=o>~</span> <span class=nv>y</span>,</span>
<span>    <span class=nv>z_condition</span> <span class=o>~</span> <span class=nv>z</span></span>
<span>  <span class=o>)</span></span>
<span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] TRUE</span></span>
<span></span></code></pre></div><p>This diagram demonstrates how that works:</p><p><img src=./images/case-when-reverse.png alt></p><h2 id=optimizing-speed>Optimizing speed?
<a href=#optimizing-speed><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Now that we&rsquo;ve optimized the memory usage of
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a>, you might be wondering if we did anything else to specifically optimize its speed. Not really! We have moved everything from R to C, but focusing our efforts on reducing memory also resulted in some pretty performant code, and there wasn&rsquo;t much left to optimize after that.</p><h2 id=if_else><code>if_else()</code>
<a href=#if_else><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>if_else()</code></a> can actually be written as a form of
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://dplyr.tidyverse.org/reference/if_else.html>if_else</a></span><span class=o>(</span><span class=nv>condition</span>, <span class=nv>true</span>, <span class=nv>false</span>, <span class=nv>missing</span><span class=o>)</span></span>
<span></span>
<span><span class=nf><a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html>case_when</a></span><span class=o>(</span></span>
<span>  <span class=nv>condition</span> <span class=o>~</span> <span class=nv>true</span>,</span>
<span>  <span class=o>!</span><span class=nv>condition</span> <span class=o>~</span> <span class=nv>false</span>,</span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/NA.html>is.na</a></span><span class=o>(</span><span class=nv>condition</span><span class=o>)</span> <span class=o>~</span> <span class=nv>missing</span></span>
<span><span class=o>)</span></span></code></pre></div><p>In our actual C implementation of
<a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>if_else()</code></a>, for simple types like integer, character, or numeric vectors we have an
<a href=https://github.com/r-lib/vctrs/blob/94cea16b1ed3939aaa59c58dda75eedc75d6d075/src/if-else.c#L276-L505 target=_blank rel=noopener>extremely fast path</a> that&rsquo;s even more optimized than this, but for anything with a class we pretty much use this exact
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a> approach.</p><h2 id=for-package-developers>For package developers
<a href=#for-package-developers><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>If you&rsquo;re a package developer, you&rsquo;ll be happy to know that vctrs itself now exposes low dependency versions of
<a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>if_else()</code></a> and
<a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html target=_blank rel=noopener><code>case_when()</code></a>, here&rsquo;s the full family:</p><ul><li><code>vec_if_else()</code></li><li><code>vec_case_when()</code></li><li><code>vec_replace_when()</code></li><li><code>vec_recode_values()</code></li><li><code>vec_replace_values()</code></li></ul><p><a href=https://dplyr.tidyverse.org/reference/if_else.html target=_blank rel=noopener><code>dplyr::if_else()</code></a> and friends are now just very thin wrappers over these. Feel free to use the vctrs versions in your package if you need the consistency of the tidyverse without the heavy-ish dependency of dplyr.</p><h2 id=at-the-deepest-level-list_combine>At the deepest level, <code>list_combine()</code>
<a href=#at-the-deepest-level-list_combine><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>At the deepest level of all of this is one final new vctrs function, <code>list_combine()</code>. This is a flexible way to combine multiple vectors together at locations specified by <code>indices</code>.</p><p><code>list_combine()</code> powers all of <code>vec_case_when()</code>, <code>vec_replace_when()</code>, <code>vec_recode_values()</code>, <code>vec_replace_values()</code>, <code>vec_if_else()</code>, and even <code>vec_c()</code>, the tidyverse version of
<a href=https://rdrr.io/r/base/c.html target=_blank rel=noopener><code>c()</code></a>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/Random.html>set.seed</a></span><span class=o>(</span><span class=m>123</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>column</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>100</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>x_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>20</span></span>
<span><span class=nv>y_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>50</span></span>
<span><span class=nv>z_condition</span> <span class=o>&lt;-</span> <span class=nv>column</span> <span class=o>&lt;</span> <span class=m>80</span></span>
<span></span>
<span><span class=nv>x</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>y</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span><span class=nv>z</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/sample.html>sample</a></span><span class=o>(</span><span class=m>10</span>, size <span class=o>=</span> <span class=m>1e7</span>, replace <span class=o>=</span> <span class=kc>TRUE</span><span class=o>)</span></span>
<span></span>
<span><span class=nv>out</span> <span class=o>&lt;-</span> <span class=nf>vctrs</span><span class=nf>::</span><span class=nf><a href=https://vctrs.r-lib.org/reference/list_combine.html>list_combine</a></span><span class=o>(</span></span>
<span>  x <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/list.html>list</a></span><span class=o>(</span><span class=nv>x</span>, <span class=nv>y</span>, <span class=nv>z</span><span class=o>)</span>,</span>
<span></span>
<span>  <span class=c># `indices` are allowed to be logical and aren't forced to integer</span></span>
<span>  indices <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/list.html>list</a></span><span class=o>(</span><span class=nv>x_condition</span>, <span class=nv>y_condition</span>, <span class=nv>z_condition</span><span class=o>)</span>,</span>
<span>  size <span class=o>=</span> <span class=nf><a href=https://rdrr.io/r/base/length.html>length</a></span><span class=o>(</span><span class=nv>x_condition</span><span class=o>)</span>,</span>
<span></span>
<span>  <span class=c># When there are overlaps, take the "first"</span></span>
<span>  multiple <span class=o>=</span> <span class=s>"first"</span>,</span>
<span></span>
<span>  <span class=c># Same as `slice_value` from `vec_assign()`</span></span>
<span>  slice_x <span class=o>=</span> <span class=kc>TRUE</span></span>
<span><span class=o>)</span></span></code></pre></div><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/identical.html>identical</a></span><span class=o>(</span></span>
<span>  <span class=nv>out</span>,</span>
<span>  <span class=nf><a href=https://dplyr.tidyverse.org/reference/case-and-replace-when.html>case_when</a></span><span class=o>(</span></span>
<span>    <span class=nv>x_condition</span> <span class=o>~</span> <span class=nv>x</span>,</span>
<span>    <span class=nv>y_condition</span> <span class=o>~</span> <span class=nv>y</span>,</span>
<span>    <span class=nv>z_condition</span> <span class=o>~</span> <span class=nv>z</span></span>
<span>  <span class=o>)</span></span>
<span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] TRUE</span></span>
<span></span></code></pre></div></div></div><div class=column25><div class="section hideOnMobile"><div class=sectionTitle>Contents</div><nav id=TableOfContents><ul><li><a href=#lets-talk-memory>Let&rsquo;s talk memory</a></li><li><a href=#sliced-assignment>Sliced assignment</a></li><li><a href=#logical-indices>Logical <code>i</code>ndices</a></li><li><a href=#default-handling><code>default</code> handling</a></li><li><a href=#the-first-wins-conundrum>The &ldquo;first wins&rdquo; conundrum</a></li><li><a href=#optimizing-speed>Optimizing speed?</a></li><li><a href=#if_else><code>if_else()</code></a></li><li><a href=#for-package-developers>For package developers</a></li><li><a href=#at-the-deepest-level-list_combine>At the deepest level, <code>list_combine()</code></a></li></ul></nav></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>