<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>gargle 1.2.0</title><meta property="og:title" content="gargle 1.2.0"><meta property="og:description" content="gargle has seen a lot of development over the past two years and five releases: cache relocation, credential rolling, a new auth method, an
 improved user interface, better verbosity control, and retries."><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="gargle 1.2.0 - Tidyverse"><meta property="description" content="gargle has seen a lot of development over the past two years and five releases: cache relocation, credential rolling, a new auth method, an
 improved user interface, better verbosity control, and retries."><meta property="og:description" content="gargle has seen a lot of development over the past two years and five releases: cache relocation, credential rolling, a new auth method, an
 improved user interface, better verbosity control, and retries."><meta property="og:image" content="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/thumbnail-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/thumbnail-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/%20/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title>gargle 1.2.0</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2021/07/gargle-1-2-0/thumbnail-wd.jpg></div><div class=photoCredit>Photo by <a href=https://unsplash.com/photos/KDJ1TbLDoOo>Mishaal Zahed</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2021/07/04</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/bigrquery/>bigrquery</a>,
<a href=/tags/gargle/>gargle</a>,
<a href=/tags/googlesheets4/>googlesheets4</a>,
<a href=/tags/googledrive/>googledrive</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Jenny Bryan</p><div class=article-content><p>We&rsquo;re psyched to announce the release of
<a href=https://gargle.r-lib.org target=_blank rel=noopener>gargle</a> 1.2.0. gargle is meant to take some of the pain out of working with Google APIs and is mostly aimed at the <em>maintainers</em> of R packages that call Google APIs.</p><p>Packages that use gargle internally include
<a href=https://bigrquery.r-dbi.org target=_blank rel=noopener>bigrquery</a>,
<a href=https://gmailr.r-lib.org target=_blank rel=noopener>gmailr</a>,
<a href=https://code.markedmondson.me/googleAuthR/ target=_blank rel=noopener>googleAuthR</a>,
<a href=https://googledrive.tidyverse.org target=_blank rel=noopener>googledrive</a>, and
<a href=https://googlesheets4.tidyverse.org target=_blank rel=noopener>googlesheets4</a>. As a conservative lower bound, gargle facilitates more than 1.5 million requests per day and over 50 million requests per month. Users of these packages, especially those who take an interest in the details around auth, may want to read on.</p><p>You can install gargle from CRAN with:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf><a href=https://rdrr.io/r/utils/install.packages.html>install.packages</a></span><span class=o>(</span><span class=s>"gargle"</span><span class=o>)</span></code></pre></div><p>I last blogged about gargle in
<a href=https://www.tidyverse.org/blog/2019/08/gargle-hello-world/ target=_blank rel=noopener>August 2019, around the release of v0.3.1</a>. There have been several releases since then and this post highlights important changes across all of them.</p><p>You can see a full list of changes in the
<a href=https://gargle.r-lib.org/news/index.html target=_blank rel=noopener>release notes</a>.</p><h2 id=stewarding-the-cache-of-user-tokens>Stewarding the cache of user tokens
<a href=#stewarding-the-cache-of-user-tokens><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Users who &ldquo;just go with the flow&rdquo; generally find themselves doing the
<a href=https://medium.com/typeforms-engineering-blog/the-beginners-guide-to-oauth-dancing-4b8f3666de10 target=_blank rel=noopener>OAuth Dance</a> in the browser:</p><div class=highlight><div class=figure style=text-align:center><p><img src=oauth-dance-web-flow.png alt="Typical OAuth dance in the browser, when initiated from within R" width=100%></p><p class=caption>Typical OAuth dance in the browser, when initiated from within R</p></div></div><p>Upon success, you see this message in the browser:</p><pre><code>Authentication complete. Please close this page and return to R.
</code></pre><p>The dance concludes with gargle (or a wrapper package) in possession of a
<a href=https://developers.google.com/identity/protocols/oauth2#installed target=_blank rel=noopener>Google user token</a>. This credential usually comes with an access token, which is valid for about an hour, and a more persistent refresh token, which can be used to get new access tokens in the future. It is nice to store this refresh token somewhere, to reduce future friction for this user. We&rsquo;ll refer to this &ldquo;somewhere&rdquo; as the <em>OAuth token cache</em>. You can get a cache &ldquo;situation report&rdquo; with
<a href=https://gargle.r-lib.org/reference/gargle_oauth_sitrep.html target=_blank rel=noopener><code>gargle::gargle_oauth_sitrep()</code></a>.</p><p>One of the original motivations for the gargle package was to depart from httr&rsquo;s behaviour around token caching, which defaults to the current working directory.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> By default, gargle caches user tokens centrally, at the user level, and their keys or labels also convey which Google identity is associated with each token. This reduces the chance of accidentally exposing tokens in projects that sync to remote servers (like DropBox or GitHub), increases the ability to reuse tokens across multiple R projects, and makes it easier to use multiple identities within a single project.</p><p>Various incremental improvements have been made around gargle&rsquo;s token cache:</p><ul><li>The default cache location has moved, to better align with general conventions around where to cache user data. After upgrading gargle, don&rsquo;t be surprised if you see some messages about cache relocation.</li><li>Token storage relies on serialized R objects and therefore is potentially sensitive to differences in R version and operating system between when a token is created and when it is (re)used. gargle is now able to recognize and cope with the most predictable and harmless effects of moving a token across time or space.</li><li>gargle is quite conservative about using cached tokens and likes to have explicit permission from the user. However, this is in tension with the desire to make things &ldquo;just work&rdquo;. Balancing these two goals is an ongoing effort:<ul><li><p>In a non-interactive context, gargle will use a cached token, if it can find (at least) one, even if the user has not given explicit instructions. However, we complain noisily and urge the user to make their intent unambiguous in the code. This comes up, for example, when rendering an R Markdown document(<code>.Rmd</code>).</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://googledrive.tidyverse.org>googledrive</a></span><span class=o>)</span>

<span class=nf><a href=https://googledrive.tidyverse.org/reference/drive_find.html>drive_find</a></span><span class=o>(</span>n_max <span class=o>=</span> <span class=m>1</span><span class=o>)</span>
<span class=c>#&gt; ℹ Suitable tokens found in the cache, associated with these emails:</span>
<span class=c>#&gt; • 'jane_personal@gmail.com'</span>
<span class=c>#&gt; • 'jane_work@example.com'</span>
<span class=c>#&gt;   Defaulting to the first email.</span>
<span class=c>#&gt; ! Using an auto-discovered, cached token.</span>
<span class=c>#&gt;   To suppress this message, modify your code or options to clearly consent to</span>
<span class=c>#&gt;   the use of a cached token.</span>
<span class=c>#&gt;   See gargle's "Non-interactive auth" vignette for more details:</span>
<span class=c>#&gt;   &lt;https://gargle.r-lib.org/articles/non-interactive-auth.html&gt;</span></code></pre></div><p>One of several ways to suppress this scolding is to specify an email:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://googledrive.tidyverse.org>googledrive</a></span><span class=o>)</span>

<span class=nf><a href=https://googledrive.tidyverse.org/reference/drive_auth.html>drive_auth</a></span><span class=o>(</span><span class=s>"jane_personal@gmail.com"</span><span class=o>)</span>

<span class=nf><a href=https://googledrive.tidyverse.org/reference/drive_find.html>drive_find</a></span><span class=o>(</span>n_max <span class=o>=</span> <span class=m>1</span><span class=o>)</span>
<span class=c>#&gt; # A tibble: 1 x 3</span>
<span class=c>#&gt;   name                       id                                 drive_resource  </span>
<span class=c>#&gt; * &lt;chr&gt;                      &lt;chr&gt;                              &lt;list&gt;          </span>
<span class=c>#&gt; 1 useR2021-Instructions_for… 11T7_aYpSObAhUzjQU6EUCHmTFQ2s0wXK… &lt;named list [32…</span></code></pre></div></li><li><p>You can now identify the token you want to use with a domain-only glob-like pattern. This makes it possible to successfully execute code like this, non-interactively, on the machines of both <code>alice@example.com</code> and <code>bob@example.com</code>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://googledrive.tidyverse.org>googledrive</a></span><span class=o>)</span>

<span class=c># googledrive uses gargle for auth</span>
<span class=nf><a href=https://googledrive.tidyverse.org/reference/drive_auth.html>drive_auth</a></span><span class=o>(</span>email <span class=o>=</span> <span class=s>"*@example.com"</span><span class=o>)</span></code></pre></div></li></ul></li></ul><h2 id=rolling-the-built-in-oauth-client>Rolling the built-in OAuth client
<a href=#rolling-the-built-in-oauth-client><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>User tokens created with gargle are the result of
<a href=#stewarding-the-cache-of-user-tokens>the OAuth Dance mentioned above</a>, involving three parties: the user, Google, and an OAuth client (id and secret). Each user or application potentially needs to set up their own OAuth client, in order to execute this flow.</p><p>A small set of packages maintained by the tidyverse team make use of a shared, built-in OAuth client, which helps new users get started quickly, without the need to create their own client in order to do &ldquo;Hello, World!". Only these specific packages are allowed to use this client and these packages do so according to a specific
<a href=https://www.tidyverse.org/google_privacy_policy/ target=_blank rel=noopener>privacy policy</a>. The &ldquo;Tidyverse API Packages&rdquo; are
<a href=https://bigrquery.r-dbi.org/ target=_blank rel=noopener>bigrquery</a>,
<a href=https://googledrive.tidyverse.org/ target=_blank rel=noopener>googledrive</a>, and
<a href=https://googlesheets4.tidyverse.org/ target=_blank rel=noopener>googlesheets4</a>.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p>As of gargle v1.0.0, released in March 2021, we have rolled the &ldquo;Tidyverse API Packages&rdquo; client, i.e. we are using a new one. Although we have not yet disabled the previous client, users should be prepared for it to stop working at any time. We use nicknames to keep track of the built-in client; the new one is known as &ldquo;tidyverse-clio&rdquo;, which is replacing the older &ldquo;tidyverse-calliope&rdquo;. You might see these nicknames in the output of
<a href=https://gargle.r-lib.org/reference/gargle_oauth_sitrep.html target=_blank rel=noopener><code>gargle::gargle_oauth_sitrep()</code></a>.</p><p>We anticipate disabling the older &ldquo;tidyverse-calliope&rdquo; client no later than December 31, 2021. If a specific reason arises before then, we could disable it even sooner. This will also be announced in a future, dedicated blog post.</p><p>When gargle encounters a token created with the old built-in client, the token is deleted from the cache. So don&rsquo;t be surprised if you see some messages about cleaning out (and relocating) the cache, after you upgrade gargle.</p><p>You can expect to do the interactive OAuth dance to obtain new credentials, with the new client, stored in the new token cache, approximately once per wrapper package / API. The consequence of credential rolling are also covered here:</p><ul><li><a href=https://gargle.r-lib.org/articles/troubleshooting.html#credential-rolling>https://gargle.r-lib.org/articles/troubleshooting.html#credential-rolling</a></li></ul><p><strong>If the rolling of the tidyverse OAuth client is highly disruptive to your workflow, consider this a wake-up call</strong> that you should be using your own OAuth client or, quite possibly, an entirely different method of auth. Our credential rolling will have no impact on users who use their own OAuth client or service account tokens.</p><p>As always, these articles explain how to take more control of auth:</p><ul><li><a href=https://gargle.r-lib.org/articles/get-api-credentials.html>https://gargle.r-lib.org/articles/get-api-credentials.html</a></li><li><a href=https://gargle.r-lib.org/articles/non-interactive-auth.html>https://gargle.r-lib.org/articles/non-interactive-auth.html</a></li></ul><h2 id=workload-identity-federation>Workload identity federation
<a href=#workload-identity-federation><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Workload identity federation is a new (as of April 2021) keyless authentication mechanism offered by Google. This allows applications running on a non-Google Cloud platform, such as AWS, to access Google Cloud resources without using a conventional service account token, eliminating the security problem posed by long-lived, powerful service account credential files. Basically, instead of storing sensitive information in a file that must be managed with great care, the necessary secrets are obtained on-the-fly and exchanged for short-lived tokens, with very granular control over what actions are allowed. There is a cost, of course, which is that this auth method requires substantial configuration on both the GCP and AWS sides.</p><p><code>credentials_external_account()</code> is a new function that implements workload identity federation. <code>credentials_external_account()</code> has been inserted into the default registry of credential-fetchers tried by <code>token_fetch()</code>, which makes it automatically available in packages that use gargle for auth, such as bigrquery. <code>credentials_app_default()</code> recognizes the JSON configuration for an external account and passes such a call along to <code>credentials_external_account()</code>. This means that, when placed in one of the locations searched by the Application Default Credential strategy, an external account configuration file will be automatically discovered.</p><p>This new feature is still experimental and currently only supports AWS. This blog post provides a good high-level introduction to workload identity federation:</p><ul><li><a href=https://cloud.google.com/blog/products/identity-security/enable-keyless-access-to-gcp-with-workload-identity-federation target=_blank rel=noopener>Keyless API authentication&mdash;Better cloud security through workload identity federation, no service account keys necessary</a></li></ul><h2 id=out-of-bound-auth>Out of bound auth
<a href=#out-of-bound-auth><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The
<a href=#stewarding-the-cache-of-user-tokens>browser-based OAuth dance described above</a> is, ironically, not fully available when you are using R inside a web browser, as is the case for RStudio Workbench, Server, and Cloud. When working on these platforms, you need to use the <strong>&ldquo;out of bound&rdquo; (oob)</strong> auth flow. After authenticating yourself and confirming permissions, a token is made available for you to copy and paste into R.</p><div class=highlight><div class=figure style=text-align:center><p><img src=oauth-dance-oob-copy-paste.png alt='A Google Sign in process ending with "Please copy this code, switch to your application and paste it there"' width=40%></p><p class=caption>A Google Sign in process ending with "Please copy this code, switch to your application and paste it there"</p></div></div><p>Back in R, you will paste this code at the prompt and then be on your merry way:</p><pre><code>Enter authorization code:
</code></pre><p>gargle-using wrapper packages generally expose an argument to request oob auth, e.g.:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>googledrive</span><span class=nf>::</span><span class=nf><a href=https://googledrive.tidyverse.org/reference/drive_auth.html>drive_auth</a></span><span class=o>(</span><span class=nv>...</span>, use_oob <span class=o>=</span> <span class=nf>gargle</span><span class=nf>::</span><span class=nf><a href=https://gargle.r-lib.org/reference/gargle_options.html>gargle_oob_default</a></span><span class=o>(</span><span class=o>)</span><span class=o>)</span></code></pre></div><p>The problem is, lots of folks who need oob auth have never even heard of oob auth! And, therefore, they don&rsquo;t know to request it. This reality is something we can, and now do, anticipate.</p><p>Instead of possibly failing with an inscrutable error,
<a href=https://gargle.r-lib.org/reference/gargle_options.html target=_blank rel=noopener><code>gargle::gargle_oob_default()</code></a> has gotten smarter about figuring out whether oob is needed:</p><ul><li>We now (try to) detect if we&rsquo;re running on RStudio Workbench, Server, or Cloud and, if so, <code>gargle_oob_default()</code> returns <code>TRUE</code> unconditionally.</li><li>We honor the <code>"httr_oob_default"</code> option, when set, if the option <code>"gargle_oob_default"</code> is unset. Previously, we only consulted the gargle option, but it makes sense to honor httr&rsquo;s as well.</li></ul><h3 id=suggesting-httpuv>Suggesting httpuv
<a href=#suggesting-httpuv><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>The slick in-browser OAuth flow described at the start of the post &ndash; i.e., the nicer <em>alternative</em> to oob auth &ndash; requires the httpuv package. Sometimes users who could enjoy this flow don&rsquo;t have httpuv installed and end up with the clunky oob auth flow, for no good reason. This is a shame, as the experience is definitely inferior.</p><p>We&rsquo;ve taken a few measures to encourage these folks to install httpuv and enjoy a happier auth life:</p><ul><li><p>Previously, httpuv was only indirectly suggested by gargle, via httr. gargle now lists httpuv in its own <code>Suggests</code> field.</p></li><li><p>We encourage the installation of httpuv in interactive sessions, if we&rsquo;re about to initiate oob auth, when it seems like we don&rsquo;t have to.</p><pre><code>The httpuv package enables a nicer Google auth experience, in many cases.
It doesn't seem to be installed.
Would you like to install it now?

1: Yes
2: No

Selection:   
</code></pre></li></ul><h2 id=user-interface>User interface
<a href=#user-interface><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The user interface has gotten more stylish, thanks to the cli package (<a href=https://cli.r-lib.org>https://cli.r-lib.org</a>). This applies to informational messages, as well as to errors.</p><p>All errors thrown by gargle now route through
<a href=https://rlang.r-lib.org/reference/abort.html target=_blank rel=noopener><code>rlang::abort()</code></a>, providing better access to the backtrace and error data. These errors have, at the very least, the <code>gargle_error</code> class and may also have additional subclasses.</p><h3 id=verbosity>Verbosity
<a href=#verbosity><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Since gargle is not a user-facing package, it has very little to say and only emits messages that end users <em>really</em> need to see. But sometimes it is useful to get more information about gargle&rsquo;s activities, especially when trying to figure out why <code>token_fetch()</code> isn&rsquo;t working the way you expect. In the past, we used the <code>"gargle_quiet"</code> option for this, which could be <code>TRUE</code> or <code>FALSE</code>.</p><p>The previous on/off switch has been deprecated in favor of the new <code>"gargle_verbosity"</code> option, which has three levels:</p><ul><li><code>"debug"</code> is equivalent to the previous <code>gargle_quiet = FALSE</code>. Use for debugging and troubleshooting.</li><li><code>"info"</code> (the default) is basically equivalent to the previous <code>gargle_quiet = TRUE</code>.</li><li><code>"silent"</code> can be used to suppress all gargle messages. It has no previous equivalent.</li></ul><p>There are a couple of helpers around verbosity:</p><ul><li><code>gargle_verbosity()</code> reports the current verbosity level.</li><li><code>with_gargle_verbosity()</code> and <code>local_gargle_verbosity()</code> are
<a href=https://withr.r-lib.org target=_blank rel=noopener>withr-style</a> functions that temporarily modify the verbosity level.</li></ul><h2 id=retries>Retries
<a href=#retries><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>gargle offers some Google-specific support for forming requests and handling responses, in addition to and separate from auth.</p><p>Not all wrapper packages use this functionality, but <em>googlesheets4 does</em>. The
<a href=https://developers.google.com/sheets/api/reference/limits target=_blank rel=noopener>usage limits for the Sheets API</a> are low enough that regular folks run up against them fairly often. This aggravation is somewhat specific to Sheets, i.e. we don&rsquo;t see similar pain with the Drive and BigQuery APIs, which have much more generous limits. When you hit the Sheets &ldquo;per user&rdquo; or &ldquo;per project&rdquo; limit, requests fail with the error code <code>429 RESOURCE_EXHAUSTED</code>.</p><p>Sidebar: As of July 2021, there is a limit of &ldquo;500 requests per 100 seconds per project&rdquo;. In the case of a user token, the &ldquo;project&rdquo; refers to the GCP project that owns the OAuth client. Everyone who uses the built-in &ldquo;Tidyverse API Packages&rdquo; OAuth client is sharing this &ldquo;per project&rdquo; quota! If you&rsquo;re hitting &ldquo;per project&rdquo; limits regularly and it upsets your workflow, the universe is telling you that it&rsquo;s time to configure your own OAuth client or use a different method of auth. End of sidebar.</p><p><a href=https://gargle.r-lib.org/reference/request_retry.html target=_blank rel=noopener><code>gargle::request_retry()</code></a> is a drop-in substitute for
<a href=https://gargle.r-lib.org/reference/request_make.html target=_blank rel=noopener><code>gargle::request_make()</code></a> that uses (modified) exponential backoff to retry requests that fail with error <code>429</code>. <code>request_retry()</code> even has some special knowledge about Sheets-specific limits and, in some cases, will wait 100 seconds for the user&rsquo;s quota to reset.</p><p>The development version of googlesheets4 already uses <code>request_retry()</code>, which will be released to CRAN soon.</p><p><code>request_retry()</code> will support error codes beyond <code>429</code> in the next gargle release.</p><h2 id=acknowledgements>Acknowledgements
<a href=#acknowledgements><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We&rsquo;d like to thank everyone who has furthered the development of gargle, from v0.3.1 to v1.2.0, through their contributions in issues and pull requests:</p><p><a href=https://github.com/acroz target=_blank rel=noopener>@acroz</a>,
<a href=https://github.com/akgold target=_blank rel=noopener>@akgold</a>,
<a href=https://github.com/alanfalcaothe target=_blank rel=noopener>@alanfalcaothe</a>,
<a href=https://github.com/atreibs target=_blank rel=noopener>@atreibs</a>,
<a href=https://github.com/batpigandme target=_blank rel=noopener>@batpigandme</a>,
<a href=https://github.com/biol75 target=_blank rel=noopener>@biol75</a>,
<a href=https://github.com/btrx-sreddy target=_blank rel=noopener>@btrx-sreddy</a>,
<a href=https://github.com/craigcitro target=_blank rel=noopener>@craigcitro</a>,
<a href=https://github.com/domsle target=_blank rel=noopener>@domsle</a>,
<a href=https://github.com/ekarsten target=_blank rel=noopener>@ekarsten</a>,
<a href=https://github.com/EricGoldsmith target=_blank rel=noopener>@EricGoldsmith</a>,
<a href=https://github.com/FedericoTrifoglio target=_blank rel=noopener>@FedericoTrifoglio</a>,
<a href=https://github.com/irfanalidv target=_blank rel=noopener>@irfanalidv</a>,
<a href=https://github.com/jayBana target=_blank rel=noopener>@jayBana</a>,
<a href=https://github.com/jcheng5 target=_blank rel=noopener>@jcheng5</a>,
<a href=https://github.com/jdtrat target=_blank rel=noopener>@jdtrat</a>,
<a href=https://github.com/jennybc target=_blank rel=noopener>@jennybc</a>,
<a href=https://github.com/jimhester target=_blank rel=noopener>@jimhester</a>,
<a href=https://github.com/lionel- target=_blank rel=noopener>@lionel-</a>,
<a href=https://github.com/maelle target=_blank rel=noopener>@maelle</a>,
<a href=https://github.com/MarkEdmondson1234 target=_blank rel=noopener>@MarkEdmondson1234</a>,
<a href=https://github.com/michaelquinn32 target=_blank rel=noopener>@michaelquinn32</a>,
<a href=https://github.com/muschellij2 target=_blank rel=noopener>@muschellij2</a>,
<a href=https://github.com/ogola89 target=_blank rel=noopener>@ogola89</a>,
<a href=https://github.com/Ozan147 target=_blank rel=noopener>@Ozan147</a>,
<a href=https://github.com/petrbouchal target=_blank rel=noopener>@petrbouchal</a>,
<a href=https://github.com/pofl target=_blank rel=noopener>@pofl</a>,
<a href=https://github.com/py9mrg target=_blank rel=noopener>@py9mrg</a>,
<a href=https://github.com/rensa target=_blank rel=noopener>@rensa</a>,
<a href=https://github.com/samterfa target=_blank rel=noopener>@samterfa</a>,
<a href=https://github.com/selesnow target=_blank rel=noopener>@selesnow</a>,
<a href=https://github.com/tareefk target=_blank rel=noopener>@tareefk</a>,
<a href=https://github.com/tstratopoulos target=_blank rel=noopener>@tstratopoulos</a>, and
<a href=https://github.com/vimota target=_blank rel=noopener>@vimota</a>.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>The successor to httr is under development and, like gargle, it will also cache user tokens at the user level: <a href=https://httr2.r-lib.org>https://httr2.r-lib.org</a>. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>gmailr is not included here, because the Gmail scopes are so sensitive that anyone wishing to work with Gmail programmatically really must set up their own OAuth client. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></div><div class=column25><div class="section hideOnMobile"><div class=sectionTitle>Contents</div><nav id=TableOfContents><ul><li><a href=#stewarding-the-cache-of-user-tokens>Stewarding the cache of user tokens</a></li><li><a href=#rolling-the-built-in-oauth-client>Rolling the built-in OAuth client</a></li><li><a href=#workload-identity-federation>Workload identity federation</a></li><li><a href=#out-of-bound-auth>Out of bound auth</a></li><li><a href=#user-interface>User interface</a></li><li><a href=#retries>Retries</a></li><li><a href=#acknowledgements>Acknowledgements</a></li></ul></nav></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>