<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>Off-label uses in ggplot2</title><meta property="og:title" content="Off-label uses in ggplot2"><meta property="og:description" content="How can ggplot2 break with no breaking changes? This short post goes into detail with how and why the latest ggplot2 release disrupted some users workflow."><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2021/06/off-label-uses-in-ggplot2/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="Off-label uses in ggplot2 - Tidyverse"><meta property="description" content="How can ggplot2 break with no breaking changes? This short post goes into detail with how and why the latest ggplot2 release disrupted some users workflow."><meta property="og:description" content="How can ggplot2 break with no breaking changes? This short post goes into detail with how and why the latest ggplot2 release disrupted some users workflow."><meta property="og:image" content="https://www.tidyverse.org/blog/2021/06/off-label-uses-in-ggplot2/thumbnail-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2021/06/off-label-uses-in-ggplot2/thumbnail-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title>Off-label uses in ggplot2</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2021/06/off-label-uses-in-ggplot2/thumbnail-wd.jpg></div><div class=photoCredit>Photo by <a href=https://data-imaginist.com>Thomas Lin Pedersen</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2021/06/24</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/ggplot2/>ggplot2</a>,
<a href=/tags/off-label/>off-label</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Thomas Lin Pedersen</p><div class=article-content><p>ggplot2 v3.3.4 landed on CRAN recently, and while every release of ggplot2 is cause for celebration, this was merely a patch release fixing a large number of bugs and so it came and went without much fanfare. However, for a couple of users this release brought an unwelcome and surprising change. We feel that this is a great opportunity to talk a bit about some of the topics that Hadley discussed in his
<a href=https://www.rstudio.com/resources/rstudioglobal-2021/maintaining-the-house-the-tidyverse-built/ target=_blank rel=noopener>rstudio::global(2021) keynote</a>, particularly the nature of breaking changes.</p><h2 id=the-surprising-use-of-ggsave>The surprising use of <code>ggsave()</code>
<a href=#the-surprising-use-of-ggsave><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We created
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> as an easy way to save a ggplot object to an image file, using the following API:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>ggplot</span><span class=o>(</span><span class=nv>mpg</span><span class=o>)</span> <span class=o>+</span> 
  <span class=nf>geom_point</span><span class=o>(</span><span class=nf>aes</span><span class=o>(</span>x <span class=o>=</span> <span class=nv>displ</span>, y <span class=o>=</span> <span class=nv>hwy</span><span class=o>)</span><span class=o>)</span>

<span class=nf>ggsave</span><span class=o>(</span><span class=s>"my_mpg_plot.png"</span><span class=o>)</span></code></pre></div><p><a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> is designed so that it automatically picks up the last created (or rendered) plot, and coupled with automatic graphic device selection determined from the file extension it provides a very lean API.</p><p>The issue we will discuss in this blog post revolves around the use of
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> in the following manner:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://ggplot2.tidyverse.org>ggplot2</a></span><span class=o>)</span>

<span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggplot.html>ggplot</a></span><span class=o>(</span><span class=nv>mpg</span><span class=o>)</span> <span class=o>+</span> 
  <span class=nf><a href=https://ggplot2.tidyverse.org/reference/geom_point.html>geom_point</a></span><span class=o>(</span><span class=nf><a href=https://ggplot2.tidyverse.org/reference/aes.html>aes</a></span><span class=o>(</span>x <span class=o>=</span> <span class=nv>displ</span>, y <span class=o>=</span> <span class=nv>hwy</span><span class=o>)</span><span class=o>)</span> <span class=o>+</span> 
  <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggsave.html>ggsave</a></span><span class=o>(</span><span class=s>"my_mpg_plot.png"</span><span class=o>)</span></code></pre></div><p>Now, if this is the first time you&rsquo;ve seen
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> being added to a plot, you are not alone. This certainly caught us by surprise. Prior to v3.3.4, this actually worked (more on that later) but with the recent release running this code will result in the following error:</p><pre><code>Error: Can't add [`ggsave(&quot;my_mpg_plot.png&quot;)`](https://ggplot2.tidyverse.org/reference/ggsave.html) to a ggplot object.
</code></pre><p>If you were a user that had used this pattern for saving plots it very much felt like we had removed a feature, pulling the rug out from under your script with no warning. However, this use of
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> had never been advertised in any of the documentation and while it worked, it could not be considered a feature as such.</p><h2 id=off-label-saving>Off-label saving
<a href=#off-label-saving><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We believe that this usage of
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> is the off-label use that Hadley talks about in his keynote. Off-label use of functions comprise of using functions in a way that only work <em>by accident</em>, and are thus susceptible to breakage at any point due to changes in the code. Another common word for this is &ldquo;a hack&rdquo;, but this term can often imply that the user is full aware of the brittle nature of the setup. Off-label use can just as well be passed on between users to a point where some thinks that this is the correct, supported, way of doing things (this was certainly the case with the above issue).</p><p>In an age of the pipe it is easy to understand why this use was picked up and thought off as a real feature.
<a href=https://rdrr.io/r/base/Arithmetic.html target=_blank rel=noopener><code>+</code></a>, however, is not <code>%>%</code> (or <code>|></code>). It is a compositional operator meant to assemble the description of a plot. There is no execution of logic (besides the assembly) going on, and thus the idea of adding
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> does not make theoretical nor practical sense. This is also the reason why we do not want to &ldquo;fix&rdquo; this issue and turn it into a regular feature.</p><h2 id=why-did-it-work-why-did-it-fail>Why did it work, why did it fail
<a href=#why-did-it-work-why-did-it-fail><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>For those interested in the cause of both the accidental functionality and its breakage, here follows a description.
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> can be used to save any plot object but defaults to the object returned by
<a href=https://ggplot2.tidyverse.org/reference/last_plot.html target=_blank rel=noopener><code>ggplot2::last_plot()</code></a>. This function returns the last rendered <em>or</em> modified plot object. That means that whenever you add something to a plot the result will be retrievable with
<a href=https://ggplot2.tidyverse.org/reference/last_plot.html target=_blank rel=noopener><code>last_plot()</code></a> but only until you manipulate or render another plot. What happens when adding
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> to a plot is that all the additions are resolved from the left and at each point the result is pushed to the
<a href=https://ggplot2.tidyverse.org/reference/last_plot.html target=_blank rel=noopener><code>last_plot()</code></a> store. When it comes to the
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> term, it will evaluate it and add the result to the plot. Since the expected plot is present in the
<a href=https://ggplot2.tidyverse.org/reference/last_plot.html target=_blank rel=noopener><code>last_plot()</code></a> store the evaluation of
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> will proceed as expected. Prior to ggplot2 v3.3.4
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> returned <code>NULL</code> which, when added to a ggplot object is a no-op (i.e.Â it does nothing). The change that provoked the error is that with v3.3.4
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> now returns the path to the saved file invisibly, and adding a string to a plot object is an error.</p><p>Based on this understanding there are some interesting observations we can make: First, while you&rsquo;ll get an error in v3.3.4, the plot is actually saved to a file since the error is thrown after the evaluation of
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a>. This means that you can &ldquo;fix&rdquo; your code by putting the whole expression in a
<a href=https://rdrr.io/r/base/try.html target=_blank rel=noopener><code>try()</code></a> block (please don&rsquo;t do this though ðŸ˜¬):</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=kr><a href=https://rdrr.io/r/base/try.html>try</a></span><span class=o>(</span>
  <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggplot.html>ggplot</a></span><span class=o>(</span><span class=nv>mpg</span><span class=o>)</span> <span class=o>+</span> 
    <span class=nf><a href=https://ggplot2.tidyverse.org/reference/geom_point.html>geom_point</a></span><span class=o>(</span><span class=nf><a href=https://ggplot2.tidyverse.org/reference/aes.html>aes</a></span><span class=o>(</span>x <span class=o>=</span> <span class=nv>displ</span>, y <span class=o>=</span> <span class=nv>hwy</span><span class=o>)</span><span class=o>)</span> <span class=o>+</span> 
    <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggsave.html>ggsave</a></span><span class=o>(</span><span class=s>"my_mpg_plot.png"</span><span class=o>)</span>
<span class=o>)</span></code></pre></div><p>Another tidbit is that the perceived feature was extremely brittle, even when it worked. Consider the following code:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nv>p1</span> <span class=o>&lt;-</span> <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggplot.html>ggplot</a></span><span class=o>(</span><span class=nv>mpg</span><span class=o>)</span> <span class=o>+</span> 
  <span class=nf><a href=https://ggplot2.tidyverse.org/reference/geom_point.html>geom_point</a></span><span class=o>(</span><span class=nf><a href=https://ggplot2.tidyverse.org/reference/aes.html>aes</a></span><span class=o>(</span>x <span class=o>=</span> <span class=nv>displ</span>, y <span class=o>=</span> <span class=nv>hwy</span><span class=o>)</span><span class=o>)</span>

<span class=nv>p2</span> <span class=o>&lt;-</span> <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggplot.html>ggplot</a></span><span class=o>(</span><span class=nv>mpg</span><span class=o>)</span> <span class=o>+</span> 
  <span class=nf><a href=https://ggplot2.tidyverse.org/reference/geom_bar.html>geom_bar</a></span><span class=o>(</span><span class=nf><a href=https://ggplot2.tidyverse.org/reference/aes.html>aes</a></span><span class=o>(</span>x <span class=o>=</span> <span class=nv>cyl</span><span class=o>)</span><span class=o>)</span>

<span class=nv>p1</span> <span class=o>+</span> <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggsave.html>ggsave</a></span><span class=o>(</span><span class=s>"scatterplot.png"</span><span class=o>)</span>
<span class=nv>p2</span> <span class=o>+</span> <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggsave.html>ggsave</a></span><span class=o>(</span><span class=s>"barplot.png"</span><span class=o>)</span></code></pre></div><p>If you assumed that
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> could be added to a plot you&rsquo;d expect the above to be totally valid code and that <code>scatterplot.png</code> would contain the plot from <code>p1</code>, and <code>barplot.png</code> would contain the plot from <code>p2</code>. However, since
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> just fetched the last modified or rendered plot by default, both png files would be identical and contain the barplot in <code>p2</code>.</p><h2 id=wrapping-up>Wrapping up
<a href=#wrapping-up><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>In the end this short post is not intended to shame the users who used
<a href=https://ggplot2.tidyverse.org/reference/ggsave.html target=_blank rel=noopener><code>ggsave()</code></a> in an unsupported way. ggplot2 is such a huge package that it is easy to pick up usage patterns without ever thinking about whether it is the correct way - if it works it works. Instead, this post is meant to showcase how, even with rigorous testing and no breaking changes, an update can break someones workflow, often to the surprise of the developer. Once a package becomes popular enough, even the slightest change in the code have the capacity for disruption.</p></div></div><div class=column25><div class="section hideOnMobile"><div class=sectionTitle>Contents</div><nav id=TableOfContents><ul><li><a href=#the-surprising-use-of-ggsave>The surprising use of <code>ggsave()</code></a></li><li><a href=#off-label-saving>Off-label saving</a></li><li><a href=#why-did-it-work-why-did-it-fail>Why did it work, why did it fail</a></li><li><a href=#wrapping-up>Wrapping up</a></li></ul></nav></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>