<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>vdiffr 1.0.0</title><meta property="og:title" content="vdiffr 1.0.0"><meta property="og:description" content="This major release of vdiffr includes an updated SVG engine and integrates with the snapshot management mechanism of testthat 3."><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2021/06/vdiffr-1-0-0/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="vdiffr 1.0.0 - Tidyverse"><meta property="description" content="This major release of vdiffr includes an updated SVG engine and integrates with the snapshot management mechanism of testthat 3."><meta property="og:description" content="This major release of vdiffr includes an updated SVG engine and integrates with the snapshot management mechanism of testthat 3."><meta property="og:image" content="https://www.tidyverse.org/blog/2021/06/vdiffr-1-0-0/thumbnail-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2021/06/vdiffr-1-0-0/thumbnail-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title>vdiffr 1.0.0</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2021/06/vdiffr-1-0-0/thumbnail-wd.jpg></div><div class=photoCredit>Photo by <a href=https://unsplash.com/photos/e8rfcKAx1Rk>Jakob Owens</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2021/06/21</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/testthat/>testthat</a>,
<a href=/tags/ggplot2/>ggplot2</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Lionel Henry</p><div class=article-content><p>We&rsquo;re delighted to announce the release of
<a href=https://vdiffr.r-lib.org/ target=_blank rel=noopener>vdiffr</a> 1.0.0. vdiffr is a testthat extension that makes it easy to automatically check code that generates R graphics. In particular, vdiffr is used by the ggplot2 team to ensure that changes and contributions do not affect the expected output of plots.</p><p>You can install vdiffr from CRAN with:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf><a href=https://rdrr.io/r/utils/install.packages.html>install.packages</a></span><span class=o>(</span><span class=s>"vdiffr"</span><span class=o>)</span></code></pre></div><p>This blog post briefly introduces the vdiffr workflow and describes the changes in this 1.0 version. In the last section you will learn how to migrate your existing vdiffr snapshots to the new version. You can see a full list of changes in the
<a href=https://vdiffr.r-lib.org/news/index.html#vdiffr-1-0-0-2021-06-08 target=_blank rel=noopener>release notes</a>.</p><p>Attach these three packages to follow the examples:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://testthat.r-lib.org>testthat</a></span><span class=o>)</span>
<span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://vdiffr.r-lib.org/>vdiffr</a></span><span class=o>)</span>
<span class=kr><a href=https://rdrr.io/r/base/library.html>library</a></span><span class=o>(</span><span class=nv><a href=https://ggplot2.tidyverse.org>ggplot2</a></span><span class=o>)</span></code></pre></div><h2 id=regression-testing-for-r-graphics>Regression testing for R graphics
<a href=#regression-testing-for-r-graphics><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>vdiffr is a
<a href=https://testthat.r-lib.org/ target=_blank rel=noopener>testthat</a> extension for monitoring the appearance of R plots and graphics over time. Its goals are to make it easy to test graphics, make it easy to review changes, and to be reproducible across platforms.</p><p>The only vdiffr function you will need to use is
<a href=https://vdiffr.r-lib.org/reference/expect_doppelganger.html target=_blank rel=noopener><code>expect_doppelganger()</code></a>. It takes a plot title and a plot object.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf><a href=https://testthat.r-lib.org/reference/test_that.html>test_that</a></span><span class=o>(</span><span class=s>"ggplot2 histogram works"</span>, <span class=o>&#123;</span>
  <span class=nv>p</span> <span class=o>&lt;-</span> <span class=nf><a href=https://ggplot2.tidyverse.org/reference/ggplot.html>ggplot</a></span><span class=o>(</span><span class=nv>mtcars</span><span class=o>)</span> <span class=o>+</span> <span class=nf><a href=https://ggplot2.tidyverse.org/reference/geom_histogram.html>geom_histogram</a></span><span class=o>(</span><span class=nf><a href=https://ggplot2.tidyverse.org/reference/aes.html>aes</a></span><span class=o>(</span><span class=nv>disp</span><span class=o>)</span><span class=o>)</span>
  <span class=nf><a href=https://vdiffr.r-lib.org/reference/expect_doppelganger.html>expect_doppelganger</a></span><span class=o>(</span><span class=s>"default histogram"</span>, <span class=nv>p</span><span class=o>)</span>
<span class=o>&#125;</span><span class=o>)</span></code></pre></div><p>With base graphics a slightly different syntax is needed because base plots are created by side effects rather than by constructing a plot object as in ggplot2. In this case you can supply a function that generates the plot:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf><a href=https://testthat.r-lib.org/reference/test_that.html>test_that</a></span><span class=o>(</span><span class=s>"base histogram works"</span>, <span class=o>&#123;</span>
  <span class=nv>p</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=o>(</span><span class=o>)</span> <span class=nf><a href=https://rdrr.io/r/graphics/hist.html>hist</a></span><span class=o>(</span><span class=nv>mtcars</span><span class=o>$</span><span class=nv>disp</span><span class=o>)</span>
  <span class=nf><a href=https://vdiffr.r-lib.org/reference/expect_doppelganger.html>expect_doppelganger</a></span><span class=o>(</span><span class=s>"base histogram"</span>, <span class=nv>p</span><span class=o>)</span>
<span class=o>&#125;</span><span class=o>)</span></code></pre></div><p>Then run
<a href=https://devtools.r-lib.org//reference/test.html target=_blank rel=noopener><code>devtools::test()</code></a> as usual. The first time it is run,
<a href=https://vdiffr.r-lib.org/reference/expect_doppelganger.html target=_blank rel=noopener><code>expect_doppelganger()</code></a> generates a reproducible SVG file that represents the expected appearance of your plot and saves it inside your test folder. After that, the generated SVG is compared to the saved version and any mismatch is reported as a failure in the testthat output.</p><p>Note that, by default, mismatches do not cause failures on CRAN machines. That&rsquo;s because testing the appearance of a plot is inherently fragile. Small upstream changes (e.g.Â in the R graphics device or in the ggplot2 package) might cause subtle differences in the appearance of a plot that are not real failures. If every such change caused a CRAN failure this would be distracting for both you and the CRAN maintainers. This is why vdiffr expectations only report failures when they are ran locally or in your CI platform. This allows you to monitor the appearance of your plots over time without causing distracting and time-consuming failures on CRAN.</p><h2 id=new-snapshot-management-system-via-testthat-3>New snapshot management system via testthat 3
<a href=#new-snapshot-management-system-via-testthat-3><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The main user visible change in vdiffr 1.0.0 is the replacement of the case management system and the accompanying Shiny app by the
<a href=https://testthat.r-lib.org/articles/snapshotting.html target=_blank rel=noopener>snapshot system introduced in testthat 3</a>. Following this change, a lot of vdiffr code has been removed and the package is now a simple generator of reproducible SVGs.</p><p>Snapshot management in testthat 3 is much more straightforward than the mechanism in previous versions of vdiffr.</p><ul><li><p>New cases are automatically recorded in the snapshot folder. They no longer need to be validated via the Shiny app.</p></li><li><p>Orphaned cases are automatically deleted from the snapshot folder.</p></li><li><p>Failures are reviewed with
<a href=https://testthat.r-lib.org/reference/snapshot_accept.html target=_blank rel=noopener><code>testthat::snapshot_review()</code></a>, a minimalist Shiny app powered by the
<a href=https://github.com/r-lib/diffviewer/ target=_blank rel=noopener>diffviewer</a> package.</p></li></ul><p>This workflow integrates nicely with other kinds of testthat snapshots such as error, warning, or output snapshots.</p><h2 id=a-simpler-svg-engine>A simpler SVG engine
<a href=#a-simpler-svg-engine><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>To generate reproducible snapshots, vdiffr embeds an SVG generation engine based on svglite. This engine has been updated and simplified.</p><ul><li><p>The main user-visible change from this update is that points now look smaller in the new SVGs. In the old snapshots they were too large.</p></li><li><p>The computation of character sizes is now hardcoded which allowed us to simplify the dependencies of vdiffr. It should also be less maintenance work for us in the long term.</p></li></ul><h2 id=migrating-existing-vdiffr-snapshots>Migrating existing vdiffr snapshots
<a href=#migrating-existing-vdiffr-snapshots><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Because of the switch to testthat 3 snapshots and the update to the SVG engine, you will need to regenerate all of your figures if you are an existing vdiffr user. Thankfully the process is straightforward and only includes two steps.</p><ol><li><p>This step is optional. Since the update to the SVG engine alters the appearance of your plots, you might want to review the changes. To do so, install the github-only 0.4.0 version of vdiffr with
<a href=https://remotes.r-lib.org/reference/install_github.html target=_blank rel=noopener><code>remotes::install_github("r-lib/vdiffr@v0.4.0")</code></a>. This release only contains the new SVG engine. You can then review the snapshot changes as usual with <code>vdiffr::manage_cases()</code>.</p></li><li><p>Install vdiffr 1.0.0 from CRAN. Delete the <code>tests/figs</code> directory where the old snapshots were saved (they will now be saved in <code>tests/testthat/_snaps</code>) and run
<a href=https://devtools.r-lib.org//reference/test.html target=_blank rel=noopener><code>devtools::test()</code></a> to generate the new snapshots.</p></li></ol><p>Please let us know of any trouble during migration, we&rsquo;re here to help!</p><h2 id=acknowledgements>Acknowledgements
<a href=#acknowledgements><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>vdiffr 1.0.0 wouldn&rsquo;t be possible without my colleague Thomas Lin Pedersen. His experience with R graphics device (
<a href=https://github.com/r-lib/ragg target=_blank rel=noopener>raggs</a>,
<a href=https://github.com/r-lib/textshaping target=_blank rel=noopener>textshaping</a>, &mldr;) was crucial to the update and simplification of the SVG engine. Thanks Thomas!</p><p>We also would like to thank all the issues and code contributors for this release:
<a href=https://github.com/aghaynes target=_blank rel=noopener>@aghaynes</a>,
<a href=https://github.com/IndrajeetPatil target=_blank rel=noopener>@IndrajeetPatil</a>,
<a href=https://github.com/JauntyJJS target=_blank rel=noopener>@JauntyJJS</a>,
<a href=https://github.com/jgabry target=_blank rel=noopener>@jgabry</a>,
<a href=https://github.com/krassowski target=_blank rel=noopener>@krassowski</a>,
<a href=https://github.com/mtalluto target=_blank rel=noopener>@mtalluto</a>,
<a href=https://github.com/pat-s target=_blank rel=noopener>@pat-s</a>,
<a href=https://github.com/rfaelens target=_blank rel=noopener>@rfaelens</a>, and
<a href=https://github.com/Sumidu target=_blank rel=noopener>@Sumidu</a>.</p></div></div><div class=column25><div class="section hideOnMobile"><div class=sectionTitle>Contents</div><nav id=TableOfContents><ul><li><a href=#regression-testing-for-r-graphics>Regression testing for R graphics</a></li><li><a href=#new-snapshot-management-system-via-testthat-3>New snapshot management system via testthat 3</a></li><li><a href=#a-simpler-svg-engine>A simpler SVG engine</a></li><li><a href=#migrating-existing-vdiffr-snapshots>Migrating existing vdiffr snapshots</a></li><li><a href=#acknowledgements>Acknowledgements</a></li></ul></nav></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script src=/js/math-code.js></script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>