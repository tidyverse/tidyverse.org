<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>withr 3.0.0</title><meta property="og:title" content="withr 3.0.0"><meta property="og:description" content="withr is the tidyverse solution for automatically cleaning up after yourselves (temporary files, options, etc). This milestone makes withr much faster."><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2024/01/withr-3-0-0/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="withr 3.0.0 - Tidyverse"><meta property="description" content="withr is the tidyverse solution for automatically cleaning up after yourselves (temporary files, options, etc). This milestone makes withr much faster."><meta property="og:description" content="withr is the tidyverse solution for automatically cleaning up after yourselves (temporary files, options, etc). This milestone makes withr much faster."><meta property="og:image" content="https://www.tidyverse.org/blog/2024/01/withr-3-0-0/thumbnail-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2024/01/withr-3-0-0/thumbnail-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/%20/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title>withr 3.0.0</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2024/01/withr-3-0-0/thumbnail-wd.jpg></div><div class=photoCredit>Photo by <a href=https://unsplash.com/photos/brown-and-black-brush-on-brown-wooden-table-V0cSTljC92k>Neal E. Johnson</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2024/01/18</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/r-lib/>r-lib</a>,
<a href=/tags/withr/>withr</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Lionel Henry</p><div class=article-content><p>It&rsquo;s not without jubilant bearing that we announce the release of the 3.0.0 version of
<a href=https://withr.r-lib.org/ target=_blank rel=noopener>withr</a>, the tidyverse solution for automatic cleanup of resources! In this release, the internals of withr were rewritten to improve the performance and increase the compatibility with base R&rsquo;s
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> mechanism.</p><p>You can install it from CRAN with:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/utils/install.packages.html>install.packages</a></span><span class=o>(</span><span class=s>"withr"</span><span class=o>)</span></span></code></pre></div><p>In this blog post we&rsquo;ll go over the changes that made this rewrite possible, but first we&rsquo;ll review the cleanup strategies made possible by withr.</p><p>You can see a full list of changes in the
<a href=https://withr.r-lib.org/news/index.html#withr-300 target=_blank rel=noopener>release notes</a>.</p><div class=highlight></div><h2 id=cleaning-up-resources-with-base-r-and-with-withr>Cleaning up resources with base R and with withr
<a href=#cleaning-up-resources-with-base-r-and-with-withr><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Traditionally, resource cleanup in R is done with
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>base::on.exit()</code></a>. Cleaning up in the on-exit hook ensures that the cleanup happens both in the normal case, when the code has finished running without error, and in the error case, when something went wrong and execution is interrupted.</p><p><a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> is meant to be used inside functions but it also works within
<a href=https://rdrr.io/r/base/eval.html target=_blank rel=noopener><code>local()</code></a>, which we&rsquo;ll use here for our examples:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/eval.html>local</a></span><span class=o>(</span><span class=o>&#123;</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/on.exit.html>on.exit</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/message.html>message</a></span><span class=o>(</span><span class=s>"Cleaning time!"</span><span class=o>)</span><span class=o>)</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>1</span> <span class=o>+</span> <span class=m>2</span><span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] 3</span></span>
<span></span><span><span class=c>#&gt; Cleaning time!</span></span>
<span></span></code></pre></div><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/eval.html>local</a></span><span class=o>(</span><span class=o>&#123;</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/on.exit.html>on.exit</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/message.html>message</a></span><span class=o>(</span><span class=s>"Cleaning time!"</span><span class=o>)</span><span class=o>)</span></span>
<span>  <span class=kr><a href=https://rdrr.io/r/base/stop.html>stop</a></span><span class=o>(</span><span class=s>"uh oh"</span><span class=o>)</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>1</span> <span class=o>+</span> <span class=m>2</span><span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span>
<span><span class=c>#&gt; <span style=color:#bb0;font-weight:700>Error</span><span style=font-weight:700>:</span></span></span>
<span><span class=c>#&gt; <span style=color:#bb0>!</span> uh oh</span></span>
<span></span><span><span class=c>#&gt; Cleaning time!</span></span>
<span></span></code></pre></div><p><a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> is guaranteed to run no matter what and this property makes it invaluable for resource cleaning. No more accidental littering!</p><p>However the process of cleaning up this way can be a bit verbose and feel too manual. Here is how you&rsquo;d create and clean up a temporary file for instance:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/eval.html>local</a></span><span class=o>(</span><span class=o>&#123;</span></span>
<span>  <span class=nv>my_file</span> <span class=o>&lt;-</span> <span class=nf><a href=https://rdrr.io/r/base/tempfile.html>tempfile</a></span><span class=o>(</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/files.html>file.create</a></span><span class=o>(</span><span class=nv>my_file</span><span class=o>)</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/on.exit.html>on.exit</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/files.html>file.remove</a></span><span class=o>(</span><span class=nv>my_file</span><span class=o>)</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/writeLines.html>writeLines</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"a"</span>, <span class=s>"b"</span><span class=o>)</span>, con <span class=o>=</span> <span class=nv>my_file</span><span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span></code></pre></div><p>Wouldn&rsquo;t it be great if we could wrap this code up in a function? That&rsquo;s the goal of withr&rsquo;s <code>local_</code>-prefixed functions. They combine both the creation or modification of a resource and its (eventual) restoration to the original state into a single function:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/eval.html>local</a></span><span class=o>(</span><span class=o>&#123;</span></span>
<span>  <span class=nv>my_file</span> <span class=o>&lt;-</span> <span class=nf>withr</span><span class=nf>::</span><span class=nf><a href=https://withr.r-lib.org/reference/with_tempfile.html>local_tempfile</a></span><span class=o>(</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/writeLines.html>writeLines</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/c.html>c</a></span><span class=o>(</span><span class=s>"a"</span>, <span class=s>"b"</span><span class=o>)</span>, con <span class=o>=</span> <span class=nv>my_file</span><span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span></code></pre></div><p>In this case we have created a resource (a file), but the same principle applies to modifying resources such as global options:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/eval.html>local</a></span><span class=o>(</span><span class=o>&#123;</span></span>
<span>  <span class=c># Let's temporarily print with a single decimal place</span></span>
<span>  <span class=nf>withr</span><span class=nf>::</span><span class=nf><a href=https://withr.r-lib.org/reference/with_options.html>local_options</a></span><span class=o>(</span>digits <span class=o>=</span> <span class=m>1</span><span class=o>)</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>1</span><span class=o>/</span><span class=m>3</span><span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] 0.3</span></span>
<span></span><span></span>
<span><span class=c># The original option value has been restored</span></span>
<span><span class=nf><a href=https://rdrr.io/r/base/options.html>getOption</a></span><span class=o>(</span><span class=s>"digits"</span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] 7</span></span>
<span></span><span></span>
<span><span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>1</span><span class=o>/</span><span class=m>3</span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] 0.3333333</span></span>
<span></span></code></pre></div><p>And you can equivalently use the <code>with_</code>-prefixed variants (from which the package takes its name!), this way you don&rsquo;t need to wrap in
<a href=https://rdrr.io/r/base/eval.html target=_blank rel=noopener><code>local()</code></a>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf>withr</span><span class=nf>::</span><span class=nf><a href=https://withr.r-lib.org/reference/with_options.html>with_options</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/list.html>list</a></span><span class=o>(</span>digits <span class=o>=</span> <span class=m>1</span><span class=o>)</span>, <span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>1</span><span class=o>/</span><span class=m>3</span><span class=o>)</span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] 0.3</span></span>
<span></span></code></pre></div><p>The <code>with_</code> functions are useful for creating very small scopes for given resources, inside or outside a function.</p><h2 id=the-withr-300-rewrite>The withr 3.0.0 rewrite
<a href=#the-withr-300-rewrite><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Traditionally, withr implemented its own exit event system on top of
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a>. We needed an extra layer because of a couple of missing features:</p><ul><li><p>When multiple resources are managed by a piece of code, the order in which these resources are restored or cleaned up sometimes matter. The most consistent order for cleanup is last-in first-out (LIFO). In other words the oldest resource, on which younger resources might depend, is cleaned up last. But historically R only supported first-in first-out (FIFO) order.</p></li><li><p>The other missing piece was being able to inspect the contents of the exit hook. The
<a href=https://rdrr.io/r/base/sys.parent.html target=_blank rel=noopener><code>sys.on.exit()</code></a> R helper was created for this purpose but was affected by a bug that prevented it from working inside functions.</p></li></ul><p>We contributed two changes to R 3.5.0 that filled these missing pieces, fixing the
<a href=https://rdrr.io/r/base/sys.parent.html target=_blank rel=noopener><code>sys.on.exit()</code></a> bug and adding an <code>after</code> argument to
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> to allow last-in first-out ordering.</p><p>Until now, we haven&rsquo;t been able to leverage these contributions because of our policy of
<a href=https://www.tidyverse.org/blog/2019/04/r-version-support target=_blank rel=noopener>supporting the current and previous four versions of R</a>. Now that enough time has passed, it was time for a rewrite! Our version of
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>base::on.exit()</code></a> is
<a href=https://withr.r-lib.org/reference/defer.html target=_blank rel=noopener><code>withr::defer()</code></a>. Along with better default behaviour,
<a href=https://withr.r-lib.org/reference/defer.html target=_blank rel=noopener><code>withr::defer()</code></a> allows the clean up of resources non-locally (ironically an essential feature for implementing <code>local_</code> functions). Given the changes in R 3.5.0,
<a href=https://withr.r-lib.org/reference/defer.html target=_blank rel=noopener><code>withr::defer()</code></a> can now be implemented as a simple wrapper around
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a>.</p><p>One benefit of the rewrite is that mixing withr tools and
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> in the same function now correctly interleaves cleanup:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nf><a href=https://rdrr.io/r/base/eval.html>local</a></span><span class=o>(</span><span class=o>&#123;</span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/on.exit.html>on.exit</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>1</span><span class=o>)</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf>withr</span><span class=nf>::</span><span class=nf><a href=https://withr.r-lib.org/reference/defer.html>defer</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>2</span><span class=o>)</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/on.exit.html>on.exit</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>3</span><span class=o>)</span>, add <span class=o>=</span> <span class=kc>TRUE</span>, after <span class=o>=</span> <span class=kc>FALSE</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf>withr</span><span class=nf>::</span><span class=nf><a href=https://withr.r-lib.org/reference/defer.html>defer</a></span><span class=o>(</span><span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>4</span><span class=o>)</span><span class=o>)</span></span>
<span></span>
<span>  <span class=nf><a href=https://rdrr.io/r/base/print.html>print</a></span><span class=o>(</span><span class=m>5</span><span class=o>)</span></span>
<span><span class=o>&#125;</span><span class=o>)</span></span>
<span><span class=c>#&gt; [1] 5</span></span>
<span><span class=c>#&gt; [1] 4</span></span>
<span><span class=c>#&gt; [1] 3</span></span>
<span><span class=c>#&gt; [1] 2</span></span>
<span><span class=c>#&gt; [1] 1</span></span>
<span></span></code></pre></div><p>But the main benefit is increased performance. Here is how <code>defer()</code> compared to
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> in the previous version:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>base</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=o>(</span><span class=o>)</span> <span class=nf><a href=https://rdrr.io/r/base/on.exit.html>on.exit</a></span><span class=o>(</span><span class=kc>NULL</span><span class=o>)</span></span>
<span><span class=nv>withr</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=o>(</span><span class=o>)</span> <span class=nf>defer</span><span class=o>(</span><span class=kc>NULL</span><span class=o>)</span></span>
<span></span>
<span><span class=c># withr 2.5.2</span></span>
<span><span class=nf>bench</span><span class=nf>::</span><span class=nf><a href=http://bench.r-lib.org/reference/mark.html>mark</a></span><span class=o>(</span><span class=nf>base</span><span class=o>(</span><span class=o>)</span>, <span class=nf>withr</span><span class=o>(</span><span class=o>)</span>, check <span class=o>=</span> <span class=kc>FALSE</span><span class=o>)</span><span class=o>[</span><span class=m>1</span><span class=o>:</span><span class=m>8</span><span class=o>]</span></span>
<span><span class=c>#&gt; # A tibble: 2 × 8</span></span>
<span><span class=c>#&gt;   expression      min median `itr/sec` mem_alloc `gc/sec` n_itr  n_gc</span></span>
<span><span class=c>#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class=c>#&gt; 1 base()            0   82ns  6954952.        0B    696.   9999     1</span></span>
<span><span class=c>#&gt; 2 withr()      26.2µs 27.9µs    35172.    88.4KB     52.8  9985    15</span></span></code></pre></div><p>withr 3.0.0 has now caught up to
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> quite a bit:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=c># withr 3.0.0</span></span>
<span><span class=nf>bench</span><span class=nf>::</span><span class=nf><a href=http://bench.r-lib.org/reference/mark.html>mark</a></span><span class=o>(</span><span class=nf>base</span><span class=o>(</span><span class=o>)</span>, <span class=nf>withr</span><span class=o>(</span><span class=o>)</span>, check <span class=o>=</span> <span class=kc>FALSE</span><span class=o>)</span><span class=o>[</span><span class=m>1</span><span class=o>:</span><span class=m>8</span><span class=o>]</span></span>
<span><span class=c>#&gt; # A tibble: 2 × 8</span></span>
<span><span class=c>#&gt;   expression      min median `itr/sec` mem_alloc `gc/sec` n_itr  n_gc</span></span>
<span><span class=c>#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class=c>#&gt; 1 base()            0   82ns  7329829.        0B       0  10000     0</span></span>
<span><span class=c>#&gt; 2 withr()      2.95µs  3.4µs   280858.        0B     225.  9992     8</span></span></code></pre></div><p>Of course
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> is still much faster, in part because <code>defer()</code> supports more features (more on that below), but mostly because <code>on.exit</code> is a primitive function whereas <code>defer()</code> is implemented as a normal R function. That said, we hope that we now have made <code>defer()</code> (and the <code>local_</code> and <code>with_</code> functions that use it) sufficiently fast to be used even in performance-critical micro-tools.</p><h2 id=improved-withr-features>Improved withr features
<a href=#improved-withr-features><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Over the successive releases of withr we&rsquo;ve improved the behaviour of cleanup expressions interactively, in scripts executed with
<a href=https://rdrr.io/r/base/source.html target=_blank rel=noopener><code>source()</code></a>, and in knitr.
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a> is a bit inconsistent when it is used outside of a function:</p><ul><li>Interactively, it doesn&rsquo;t do anything.</li><li>In
<a href=https://rdrr.io/r/base/source.html target=_blank rel=noopener><code>source()</code></a> and in knitr, it runs immediately instead of a the end of the script</li></ul><p><a href=https://withr.r-lib.org/reference/defer.html target=_blank rel=noopener><code>withr::defer()</code></a> and the
<a href=https://withr.r-lib.org/reference/with_.html target=_blank rel=noopener><code>withr::local_</code></a> helpers try to be more helpful for these cases.</p><p>Interactively, it saves the cleanup action in a special global hook and you get information about how to actually perform the cleanup:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span><span class=nv>file</span> <span class=o>&lt;-</span> <span class=nf>withr</span><span class=nf>::</span><span class=nf><a href=https://withr.r-lib.org/reference/with_tempfile.html>local_tempfile</a></span><span class=o>(</span><span class=o>)</span></span>
<span><span class=c>#&gt; Setting global deferred event(s).</span></span>
<span><span class=c>#&gt; i These will be run:</span></span>
<span><span class=c>#&gt;   * Automatically, when the R session ends.</span></span>
<span><span class=c>#&gt;   * On demand, if you call `withr::deferred_run()`.</span></span>
<span><span class=c>#&gt; i Use `withr::deferred_clear()` to clear them without executing.</span></span>
<span></span>
<span><span class=c># Clean up now</span></span>
<span><span class=nf>withr</span><span class=nf>::</span><span class=nf><a href=https://withr.r-lib.org/reference/defer.html>deferred_run</a></span><span class=o>(</span><span class=o>)</span></span>
<span><span class=c>#&gt; Ran 1/1 deferred expressions</span></span></code></pre></div><p>In knitr or
<a href=https://rdrr.io/r/base/source.html target=_blank rel=noopener><code>source()</code></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, the cleanup is performed at the end of the document or of the script. If you need chunk-level cleanup, use
<a href=https://rdrr.io/r/base/eval.html target=_blank rel=noopener><code>local()</code></a> as we&rsquo;ve been doing in the examples of this blog post:</p><div class=highlight><pre class=chroma><code class=language-md data-lang=md>Cleaning up at the end of the document:

<span class=s>```r
</span><span class=s></span><span class=n>document_wide_file</span> <span class=o>&lt;-</span> <span class=n>withr</span><span class=o>::</span><span class=nf>local_tempfile</span><span class=p>()</span>
<span class=s>```</span>

Cleaning up at the end of the chunk:

<span class=s>```r
</span><span class=s></span><span class=nf>local</span><span class=p>({</span>
  <span class=n>local_file</span> <span class=o>&lt;-</span> <span class=n>withr</span><span class=o>::</span><span class=nf>local_tempfile</span><span class=p>()</span>
<span class=p>})</span>
<span class=s>```</span>
</code></pre></div><p>Starting from withr 3.0.0, you can also run <code>deferred_run()</code> inside of a chunk:</p><div class=highlight><pre class=chroma><code class=language-md data-lang=md><span class=s>```r
</span><span class=s></span><span class=n>withr</span><span class=o>::</span><span class=nf>deferred_run</span><span class=p>()</span>
<span class=c1>#&gt; Ran 1/1 deferred expressions</span>
<span class=s>```</span>
</code></pre></div><h2 id=acknowledgements>Acknowledgements
<a href=#acknowledgements><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Thanks to the github contributors who helped us with this release!</p><p><a href=https://github.com/ashbythorpe target=_blank rel=noopener>@ashbythorpe</a>,
<a href=https://github.com/bastistician target=_blank rel=noopener>@bastistician</a>,
<a href=https://github.com/DavisVaughan target=_blank rel=noopener>@DavisVaughan</a>,
<a href=https://github.com/fkohrt target=_blank rel=noopener>@fkohrt</a>,
<a href=https://github.com/gaborcsardi target=_blank rel=noopener>@gaborcsardi</a>,
<a href=https://github.com/gdurif target=_blank rel=noopener>@gdurif</a>,
<a href=https://github.com/hadley target=_blank rel=noopener>@hadley</a>,
<a href=https://github.com/HenrikBengtsson target=_blank rel=noopener>@HenrikBengtsson</a>,
<a href=https://github.com/honghaoli42 target=_blank rel=noopener>@honghaoli42</a>,
<a href=https://github.com/IndrajeetPatil target=_blank rel=noopener>@IndrajeetPatil</a>,
<a href=https://github.com/jameslairdsmith target=_blank rel=noopener>@jameslairdsmith</a>,
<a href=https://github.com/jennybc target=_blank rel=noopener>@jennybc</a>,
<a href=https://github.com/jonkeane target=_blank rel=noopener>@jonkeane</a>,
<a href=https://github.com/krlmlr target=_blank rel=noopener>@krlmlr</a>,
<a href=https://github.com/lionel- target=_blank rel=noopener>@lionel-</a>,
<a href=https://github.com/maelle target=_blank rel=noopener>@maelle</a>,
<a href=https://github.com/MichaelChirico target=_blank rel=noopener>@MichaelChirico</a>,
<a href=https://github.com/MLopez-Ibanez target=_blank rel=noopener>@MLopez-Ibanez</a>,
<a href=https://github.com/moodymudskipper target=_blank rel=noopener>@moodymudskipper</a>,
<a href=https://github.com/multimeric target=_blank rel=noopener>@multimeric</a>,
<a href=https://github.com/orichters target=_blank rel=noopener>@orichters</a>,
<a href=https://github.com/pfuehrlich-pik target=_blank rel=noopener>@pfuehrlich-pik</a>,
<a href=https://github.com/solmos target=_blank rel=noopener>@solmos</a>,
<a href=https://github.com/tillea target=_blank rel=noopener>@tillea</a>, and
<a href=https://github.com/vanhry target=_blank rel=noopener>@vanhry</a>.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://rdrr.io/r/base/source.html target=_blank rel=noopener><code>source()</code></a> is only supported by default when running in the global environment, which is usually the case. For the special case of sourcing in a local environment, you need to set <code>options(withr.hook_source = TRUE)</code> first. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></div><div class=column25><div class="section hideOnMobile"><div class=sectionTitle>Contents</div><nav id=TableOfContents><ul><li><a href=#cleaning-up-resources-with-base-r-and-with-withr>Cleaning up resources with base R and with withr</a></li><li><a href=#the-withr-300-rewrite>The withr 3.0.0 rewrite</a></li><li><a href=#improved-withr-features>Improved withr features</a></li><li><a href=#acknowledgements>Acknowledgements</a></li></ul></nav></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>