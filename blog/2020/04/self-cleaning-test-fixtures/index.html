<!doctype html><html><head><!doctype html><html lang=en-us><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/main-site.css><link rel=stylesheet href=/css/fa5-all.css><style type=text/css>body{background-color:#fff;color:#1a1917}a{color:#38577f}a:hover{color:#42709b}a:focus{outline-color:#42709b}.column25-left .sectionTitle a:hover:not(.current),.column16-left .sectionTitle a:hover:not(.current){color:#1a1917}.icon-attribution,.icon-attribution a{color:#1a1917;opacity:75%}#homeContent .band.first{background-color:#fff}#homeContent .band.second{background-color:#fdeba4}#homeContent .band.third{background-color:#fff}#rStudioHeader{background-color:#1a162d;color:#fff}#rStudioHeader .productName{color:#fff}#rStudioHeader .productName:hover,#rStudioHeader .productName:focus{color:#fdeba4}#rStudioHeader #menu .menuItem.a{background-color:#75aadb;color:#fff}#rStudioHeader #menu .menuItem:hover{background-color:#484557;color:#fff}#rStudioHeader #menu .menuItem.current{background-color:#fff;color:#1a162d;text-decoration:none}#rStudioFooter.band{background-color:#767381}#rStudioFooter .bandContent #copyright{color:#e3eef8}table tbody tr:nth-child(even){background-color:#f7faff}table tbody tr:nth-child(odd){background-color:#fff}.latest{border-top:.5em solid <no value>}.event{-moz-box-shadow:0 0 0 0 rgba(0,0,0,.1);-webkit-box-shadow:0 0 0 0 rgba(0,0,0,.1);box-shadow:0 0 0 0 rgba(0,0,0,.1)}.section .event{background-color:#eab0c41a}.section .event{border-top:7pt solid #a19ea936}.section .event a{color:#1a162d}.section .event{color:#404040}</style><link rel=stylesheet href=/css/tidyverse.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.71.1"><title>Self-cleaning test fixtures</title><meta property="og:title" content="Self-cleaning test fixtures"><meta property="og:description" content="A wild romp through environments -- namely, the environments associated with
functions and tests. How to adopt a low-impact lifestyle."><meta property="og:type" content="article"><meta property="og:url" content="https://www.tidyverse.org/blog/2020/04/self-cleaning-test-fixtures/"><meta property="twitter:card" content="summary_large_image"><meta property="og:title" content="Self-cleaning test fixtures - Tidyverse"><meta property="description" content="A wild romp through environments -- namely, the environments associated with
functions and tests. How to adopt a low-impact lifestyle."><meta property="og:description" content="A wild romp through environments -- namely, the environments associated with
functions and tests. How to adopt a low-impact lifestyle."><meta property="og:image" content="https://www.tidyverse.org/blog/2020/04/self-cleaning-test-fixtures/thumbnail-sq.jpg"><meta name=twitter:image content="https://www.tidyverse.org/blog/2020/04/self-cleaning-test-fixtures/thumbnail-wd.jpg"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg><link rel="shortcut icon" href=/images/favicons/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config href=/images/favicons/browserconfig.xml><script type=text/javascript src=/js/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/site.js></script><link rel=icon href=/images/favicon.ico><script type=text/javascript src=/js/clipboard.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin=anonymous></script><script defer data-domain=tidyverse.org,all.tidyverse.org src=https://plausible.io/js/plausible.js></script></head><body><div id=appTidyverseSite class="shrinkHeader alwaysShrinkHeader"><div id=main><div id=rStudioHeader><nav class=band><div class="innards bandContent"><div><a class=productName href=/%20/>Tidyverse</a></div><div id=menu><div id=menuToggler></div><div id=menuItems><a class=menuItem href=/packages/>Packages</a>
<a class="menuItem current" href=/blog/>Blog</a>
<a class=menuItem href=/learn/>Learn</a>
<a class=menuItem href=/help/>Help</a>
<a class=menuItem href=/contribute/>Contribute</a></div></div></div></nav></div><main><div class="band padForHeader pushFooter"><div class=bandContent><div class="full splitColumns withMobileMargins"><div class=column75><h1 class=article-title>Self-cleaning test fixtures</h1><div class=article-header aria-hidden=true><div class=photo><img src=/blog/2020/04/self-cleaning-test-fixtures/thumbnail-wd.jpg></div><div class=photoCredit>Photo by <a href=https://twitter.com/MariannaFoos>Marianna Foos</a></div></div><span class=article-date><i class="fas fa-calendar-day fa-fw"></i>&nbsp;&nbsp;2020/04/27</span><p style=margin-bottom:.5em;margin-top:.85em><i class="fas fa-tags"></i>&nbsp;
<a href=/tags/r-lib/>r-lib</a></p><p style=margin-top:.5em><i class="fas fa-user-circle fa-fw"></i>&nbsp;
Jenny Bryan</p><div class=article-content><p><em>Adapted from an internal presentation to the tidyverse team, which tells you something about the target reader. The primary audience for this post is R programmers and, especially, package developers. The problems identified and solved here are pretty niche! People who are mostly interested in R as a data analysis tool may not have direct use for this material. But the post offers something for anyone curious about the hazards of side effects and the various ways we can leave the world as you found it.</em></p><h2 id=test-hygiene>Test hygiene
<a href=#test-hygiene><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><blockquote><p>Take nothing but memories, leave nothing but footprints.</p></blockquote><p>â€• Chief Si&rsquo;ahl</p><p>Ideally a test should leave the world exactly as it found it. Examples of things you might do inside a test and, therefore, need to undo:</p><ul><li>Create a file or directory</li><li>Create a resource on an external system</li><li>Set an R option</li><li>Set an environment variable</li><li>Change working directory</li><li>Change an aspect of the tested package&rsquo;s state</li></ul><p>Scrupulous attention to cleanup is more than just courtesy or being fastidious. It is also self-serving. The state of the world after test <code>i</code> is the starting state for test <code>i + 1</code>. Tests that change state willy-nilly eventually end up interfering with each other in ways that can be very difficult to debug. Most tests are written with an implicit assumption about the starting state, usually whatever <em>tabula rasa</em> means for the target domain of your package. If you accumulate enough sloppy tests, you will eventually find yourself asking the programming equivalent of questions like &ldquo;Who forgot to turn off the oven?&rdquo; and &ldquo;Who didn&rsquo;t clean up after the dog?".</p><p>First, we lay some foundations that aren&rsquo;t obviously related to tests, but just trust that we&rsquo;ll get there eventually.</p><h2 id=the-onexit-pattern>The <code>on.exit()</code> pattern
<a href=#the-onexit-pattern><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>If you want to clean up after yourself, how should you actually do it?</p><p>The first function to know about is base R&rsquo;s
<a href=https://rdrr.io/r/base/on.exit.html target=_blank rel=noopener><code>on.exit()</code></a>. You use it inside a function. In the function body, every time you do something that should be undone <strong>on exit</strong>, you immediately register the cleanup code with <code>on.exit(expr, add = TRUE)</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>Here&rsquo;s a <code>sloppy()</code> function that prints a number with a specific number of significant digits, by adjusting an R option.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>sloppy</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>sig_digits</span><span class=p>)</span> <span class=p>{</span>
  <span class=nf>options</span><span class=p>(</span><span class=n>digits</span> <span class=o>=</span> <span class=n>sig_digits</span><span class=p>)</span>
  <span class=nf>print</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
<span class=p>}</span>

<span class=kc>pi</span>
<span class=c1>#&gt; [1] 3.141593</span>

<span class=nf>sloppy</span><span class=p>(</span><span class=kc>pi</span><span class=p>,</span> <span class=m>2</span><span class=p>)</span>
<span class=c1>#&gt; [1] 3.1</span>

<span class=kc>pi</span>
<span class=c1>#&gt; [1] 3.1</span>
</code></pre></div><p>Notice how <code>pi</code> prints differently before and after the call to <code>sloppy()</code>. Calling <code>sloppy()</code> has a side effect: it changes the <code>digits</code> option globally, not just within its own scope of operations. This is what we want to avoid.</p><p><em>Don&rsquo;t worry, I&rsquo;m restoring global state (specifically, the <code>digits</code> option) behind the scenes here.</em></p><p>Here&rsquo;s how to do better with <code>on.exit()</code>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>neat</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>sig_digits</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>op</span> <span class=o>&lt;-</span> <span class=nf>options</span><span class=p>(</span><span class=n>digits</span> <span class=o>=</span> <span class=n>sig_digits</span><span class=p>)</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>options</span><span class=p>(</span><span class=n>op</span><span class=p>),</span> <span class=n>add</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>)</span>
  <span class=nf>print</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
<span class=p>}</span>

<span class=kc>pi</span>
<span class=c1>#&gt; [1] 3.141593</span>

<span class=nf>neat</span><span class=p>(</span><span class=kc>pi</span><span class=p>,</span> <span class=m>2</span><span class=p>)</span>
<span class=c1>#&gt; [1] 3.1</span>

<span class=kc>pi</span>
<span class=c1>#&gt; [1] 3.141593</span>
</code></pre></div><p>The use of <code>on.exit()</code> ensures that <code>neat()</code> leaves <code>digits</code> the way that it found it. <code>on.exit()</code> also works when you exit the function abnormally, i.e. due to error. This is why it&rsquo;s a better choice than any do-it-yourself solution.</p><p>But I promised to talk about tests! Never fear, <code>on.exit()</code> also works inside a test.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>library</span><span class=p>(</span><span class=n>testthat</span><span class=p>)</span>

<span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>)</span>
<span class=c1>#&gt; [1] 2.718282</span>

<span class=nf>test_that</span><span class=p>(</span><span class=s>&#34;on.exit() works in a test&#34;</span><span class=p>,</span> <span class=p>{</span>
  <span class=n>op</span> <span class=o>&lt;-</span> <span class=nf>options</span><span class=p>(</span><span class=n>digits</span> <span class=o>=</span> <span class=m>2</span><span class=p>)</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>options</span><span class=p>(</span><span class=n>op</span><span class=p>),</span> <span class=n>add</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>)</span>
  <span class=n>out</span> <span class=o>&lt;-</span> <span class=nf>format</span><span class=p>(</span><span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>
  <span class=nf>expect_equal</span><span class=p>(</span><span class=n>out</span><span class=p>,</span> <span class=s>&#34;2.7&#34;</span><span class=p>)</span>
  <span class=c1># printing just for the benefit of the reader</span>
  <span class=nf>print</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> 
<span class=p>})</span>
<span class=c1>#&gt; [1] &#34;2.7&#34;</span>

<span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>)</span>
<span class=c1>#&gt; [1] 2.718282</span>
</code></pre></div><p><code>on.exit()</code> is a very useful function and provides enough inspiration for an entire package: withr (
<a href=http://withr.r-lib.org target=_blank rel=noopener>withr.r-lib.org</a>), which is a Swiss army knife for managing state in very flexible ways. It&rsquo;s what I usually use, in functions and tests, for situations like that above.</p><p><em>For more background, the section about
<a href=https://adv-r.hadley.nz/functions.html#on-exit target=_blank rel=noopener>Exit handlers</a> in Advanced R is a good reference. The
<a href=https://github.com/r-lib/cleancall#readme target=_blank rel=noopener>cleancall package</a> addresses a similar problem, but in the C code of an R package. cleancall is introduced in the blog post
<a href=https://www.tidyverse.org/blog/2019/05/resource-cleanup-in-c-and-the-r-api/ target=_blank rel=noopener>Resource Cleanup in C and the R API</a>.</em></p><h2 id=withrdefer><code>withr::defer()</code>
<a href=#withrdefer><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><code>withr::defer()</code> is a more general version of <code>on.exit()</code>. It can run cleanup for any environment, but defaults to the environment it was called in. Therefore, it works like <code>on.exit()</code> inside a function &ndash; an extremely important special case &ndash; but the added flexibility means you can use it in more situations.</p><p>Below I compare <code>on.exit()</code> and <code>withr::defer()</code> and I put the code inside <code>local()</code>, instead of inside a function. This is meant to reinforce that cleanup can be relevant beyond function execution environments. It also gives you another tool to play with, in addition to toy functions and tests, in your own explorations of how to manage scope.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>library</span><span class=p>(</span><span class=n>withr</span><span class=p>)</span>

<span class=nf>local</span><span class=p>({</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>))</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;last&#34;</span><span class=p>))</span>  <span class=c1># this clobbers `print(&#34;first&#34;)` :(</span>
<span class=p>})</span>
<span class=c1>#&gt; [1] &#34;last&#34;</span>

<span class=nf>local</span><span class=p>({</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>),</span> <span class=n>add</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>)</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;last&#34;</span><span class=p>),</span> <span class=n>add</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>)</span>
<span class=p>})</span>
<span class=c1>#&gt; [1] &#34;first&#34;</span>
<span class=c1>#&gt; [1] &#34;last&#34;</span>

<span class=nf>local</span><span class=p>({</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>),</span> <span class=n>add</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>,</span> <span class=n>after</span> <span class=o>=</span> <span class=kc>FALSE</span><span class=p>)</span>
  <span class=nf>on.exit</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;last&#34;</span><span class=p>),</span> <span class=n>add</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>,</span> <span class=n>after</span> <span class=o>=</span> <span class=kc>FALSE</span><span class=p>)</span>
<span class=p>})</span>
<span class=c1>#&gt; [1] &#34;last&#34;</span>
<span class=c1>#&gt; [1] &#34;first&#34;</span>

<span class=nf>local</span><span class=p>({</span>
  <span class=nf>defer</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>))</span>
  <span class=nf>defer</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;last&#34;</span><span class=p>))</span>
<span class=p>})</span>
<span class=c1>#&gt; [1] &#34;last&#34;</span>
<span class=c1>#&gt; [1] &#34;first&#34;</span>
</code></pre></div><p>This showcases the nice ergonomics of <code>defer()</code>: each call <em>adds</em> to the list of deferred tasks (vs. replaces) and, by default, adds to the <em>front</em> of the stack (vs. the back). As you&rsquo;ll see below, this turns out to matter in most real world usage<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><h2 id=withrlocal_><code>withr::local_*()</code>
<a href=#withrlocal_><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><code>on.exit()</code> usage has a very predictable, slightly clunky pattern. In <code>neat()</code>, it looks like:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>op</span> <span class=o>&lt;-</span> <span class=nf>options</span><span class=p>(</span><span class=n>digits</span> <span class=o>=</span> <span class=n>sig_digits</span><span class=p>)</span>
<span class=nf>on.exit</span><span class=p>(</span><span class=nf>options</span><span class=p>(</span><span class=n>op</span><span class=p>),</span> <span class=n>add</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>)</span>      
</code></pre></div><p>The first statement accomplishes two things at once: it sets the <code>digits</code> option and captures its original value in <code>op</code>. The second statement schedules the restoration of <code>digits</code>. This order of operations is encouraged by the design of <code>options()</code>, which returns the original values when it&rsquo;s used as a setter.</p><p>Here is the more general (and possibly slightly safer) approach: First, capture the current state. Then, immediately schedule the eventual restoration of this original state, so that this is arranged before any additional calls are made that could exit, e.g. throw an error. Last, make the desired state change.</p><p>What if such a maneuver happens all over your package and you want to write a helper?</p><p>You can&rsquo;t wrap <code>on.exit()</code> in your own helpers, because there&rsquo;s no way to reach back up into the correct parent frame and schedule cleanup there. But with <code>defer()</code>, we can! Here is such a custom helper, called <code>local_digits()</code>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>local_digits</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>sig_digits</span><span class=p>,</span> <span class=n>env</span> <span class=o>=</span> <span class=nf>parent.frame</span><span class=p>())</span> <span class=p>{</span>
  <span class=n>op</span> <span class=o>&lt;-</span> <span class=nf>options</span><span class=p>(</span><span class=n>digits</span> <span class=o>=</span> <span class=n>sig_digits</span><span class=p>)</span>
  <span class=nf>defer</span><span class=p>(</span><span class=nf>options</span><span class=p>(</span><span class=n>op</span><span class=p>),</span> <span class=n>env</span> <span class=o>=</span> <span class=n>env</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>We can use it to keep any manipulation of <code>digits</code> local to a test (or function).</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>)</span>
<span class=c1>#&gt; [1] 2.718282</span>

<span class=nf>test_that</span><span class=p>(</span><span class=s>&#34;withr lets us write custom helpers for local state manipulation&#34;</span><span class=p>,</span> <span class=p>{</span>
  <span class=nf>local_digits</span><span class=p>(</span><span class=m>20</span><span class=p>)</span>
  <span class=nf>print</span><span class=p>(</span><span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>
<span class=p>})</span>
<span class=c1>#&gt; [1] 2.7182818284590450908</span>

<span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>)</span>
<span class=c1>#&gt; [1] 2.718282</span>

<span class=nf>test_that</span><span class=p>(</span><span class=s>&#34;we can even make multiple calls to local_digits()&#34;</span><span class=p>,</span> <span class=p>{</span>
  <span class=nf>local_digits</span><span class=p>(</span><span class=m>1</span><span class=p>)</span>
  <span class=nf>print</span><span class=p>(</span><span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>
  <span class=nf>local_digits</span><span class=p>(</span><span class=m>3</span><span class=p>)</span>
  <span class=nf>print</span><span class=p>(</span><span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>
  <span class=nf>local_digits</span><span class=p>(</span><span class=m>5</span><span class=p>)</span>
  <span class=nf>print</span><span class=p>(</span><span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>
<span class=p>})</span>
<span class=c1>#&gt; [1] 3</span>
<span class=c1>#&gt; [1] 2.72</span>
<span class=c1>#&gt; [1] 2.7183</span>

<span class=nf>exp</span><span class=p>(</span><span class=m>1</span><span class=p>)</span>
<span class=c1>#&gt; [1] 2.718282</span>
</code></pre></div><p>The ability to write <code>on.exit()</code>-like functions, customized to your own needs, is very empowering. However, you may not even need to. There are certain state changes that come up over and over again, for all of us. These are pre-implemented in withr&rsquo;s <code>local_*()</code> family of functions. A few examples:</p><table><thead><tr><th>Do / undo this</th><th>withr function</th></tr></thead><tbody><tr><td>Create a file</td><td><code>local_file()</code></td></tr><tr><td>Set an R option</td><td><code>local_options()</code></td></tr><tr><td>Set an environment variable</td><td><code>local_envvar()</code></td></tr><tr><td>Change working directory</td><td><code>local_dir()</code></td></tr></tbody></table><p>&ldquo;Local&rdquo; here refers to the fact that the state change persists only for the lifetime of an associated environment, usually the execution environment of a function or test.</p><p>We can use <code>withr::local_options()</code> to write yet another version of <code>neat()</code>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>neater</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>sig_digits</span><span class=p>)</span> <span class=p>{</span>
  <span class=nf>local_options</span><span class=p>(</span><span class=nf>list</span><span class=p>(</span><span class=n>digits</span> <span class=o>=</span> <span class=n>sig_digits</span><span class=p>))</span>
  <span class=nf>print</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
<span class=p>}</span>

<span class=kc>pi</span>
<span class=c1>#&gt; [1] 3.141593</span>

<span class=nf>neater</span><span class=p>(</span><span class=kc>pi</span><span class=p>,</span> <span class=m>3</span><span class=p>)</span>
<span class=c1>#&gt; [1] 3.14</span>

<span class=kc>pi</span>
<span class=c1>#&gt; [1] 3.141593</span>
</code></pre></div><p>Each <code>local_*()</code> function has a companion <code>with_()</code> function, which is a nod to
<a href=https://rdrr.io/r/base/with.html target=_blank rel=noopener><code>with()</code></a>. We won&rsquo;t use the <code>with_*()</code> functions here, but you can learn more about them at
<a href=http://withr.r-lib.org target=_blank rel=noopener>withr.r-lib.org</a>.</p><h2 id=test-fixtures>Test fixtures
<a href=#test-fixtures><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Testing is often demonstrated with cute little tests and functions where all the inputs and expected results can be inlined. But in real packages, things aren&rsquo;t always so simple. The main functions in your package probably aren&rsquo;t &ldquo;1 number in, 1 number out&rdquo;. They might require more exotic objects or very specific circumstances. Changing state might be the entire purpose of a function! Now what?</p><p><em>Obligatory caveat: If you find it hard to write tests, this may be the universe telling you that your package has some design problems. Maybe you&rsquo;ve somehow ended up with a small number of monster functions, with oodles of arguments and complex conditional logic, that can do everything from scramble eggs to change a lightbulb. The best move in this case may be to break things up into smaller and simpler functions. And those will be easier to test. End caveat.</em></p><p>Tricky test situations can&rsquo;t always be eliminated by better package design. Let&rsquo;s assume you&rsquo;ve got a reasonable design and you&rsquo;re still facing some test dilemmas. Unless you find a way to make writing tests as pleasant as possible, you won&rsquo;t write nearly enough of them.</p><p>One technique I&rsquo;ve found useful is what I&rsquo;ll call a <strong>self-cleaning test fixture</strong>.</p><h3 id=usethis-and-create_local_package>usethis and <code>create_local_package()</code>
<a href=#usethis-and-create_local_package><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>The usethis package (
<a href=https://usethis.r-lib.org target=_blank rel=noopener>usethis.r-lib.org</a>) provides functions for looking after the files and folders in an R project, especially an R package. These function names should give you a vague sense of what usethis does: <code>create_package()</code>, <code>use_vignette()</code>, <code>use_testthat()</code>, <code>use_github()</code>. Many of these functions only make sense in the context of an R package. That means in order to test them, we have to be working inside an R package. And they can&rsquo;t all target some persistent Frankenpackage.</p><p>We need a way to quickly spin up a minimal package, in the session temp directory. Test some functions against it. Then destroy it. Without a lot of fuss. We need a <strong>local package</strong>.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>create_local_package</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>dir</span> <span class=o>=</span> <span class=nf>file_temp</span><span class=p>(),</span> <span class=n>env</span> <span class=o>=</span> <span class=nf>parent.frame</span><span class=p>())</span> <span class=p>{</span>
  <span class=n>old_project</span> <span class=o>&lt;-</span> <span class=nf>proj_get_</span><span class=p>()</span>            <span class=c1># --- Record starting state --- </span>
  
  <span class=n>withr</span><span class=o>::</span><span class=nf>defer</span><span class=p>({</span>                        <span class=c1># --- Defer The Undoing --- </span>
    <span class=nf>proj_set</span><span class=p>(</span><span class=n>old_project</span><span class=p>,</span> <span class=n>force</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>)</span> <span class=c1># restore active usethis project (-C)</span>
    <span class=nf>setwd</span><span class=p>(</span><span class=n>old_project</span><span class=p>)</span>                  <span class=c1># restore working directory      (-B)</span>
    <span class=n>fs</span><span class=o>::</span><span class=nf>dir_delete</span><span class=p>(</span><span class=n>dir</span><span class=p>)</span>                 <span class=c1># delete the temporary package   (-A)</span>
  <span class=p>},</span> <span class=n>envir</span> <span class=o>=</span> <span class=n>env</span><span class=p>)</span>
                                        <span class=c1># --- Do The Doing ---      </span>
  <span class=nf>create_package</span><span class=p>(</span><span class=n>dir</span><span class=p>,</span> <span class=n>open</span> <span class=o>=</span> <span class=kc>FALSE</span><span class=p>)</span>     <span class=c1># create new folder and package  (A)</span>
  <span class=nf>setwd</span><span class=p>(</span><span class=n>dir</span><span class=p>)</span>                            <span class=c1># change working directory       (B)</span>
  <span class=nf>proj_set</span><span class=p>(</span><span class=n>dir</span><span class=p>)</span>                         <span class=c1># switch to new usethis project  (C)</span>
  <span class=nf>invisible</span><span class=p>(</span><span class=n>dir</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>That&rsquo;s a simplified version of the test helper<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> we use in over 170 tests in usethis. Here&rsquo;s an example of how <code>create_local_package()</code> is used in a test:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>test_that</span><span class=p>(</span><span class=s>&#34;use_roxygen_md() adds DESCRIPTION fields&#34;</span><span class=p>,</span> <span class=p>{</span>
  <span class=nf>skip_if_not_installed</span><span class=p>(</span><span class=s>&#34;roxygen2&#34;</span><span class=p>)</span>
  
  <span class=n>pkg</span> <span class=o>&lt;-</span> <span class=nf>create_local_package</span><span class=p>()</span> <span class=c1># &lt;&lt;&lt;&lt;&lt;------------------------ HERE IT IS!!!!!</span>
  
  <span class=nf>use_roxygen_md</span><span class=p>()</span>
  
  <span class=nf>expect_identical</span><span class=p>(</span>
    <span class=n>desc</span><span class=o>::</span><span class=nf>desc_get</span><span class=p>(</span><span class=s>&#34;Roxygen&#34;</span><span class=p>,</span> <span class=n>pkg</span><span class=p>),</span>
    <span class=nf>c</span><span class=p>(</span><span class=n>Roxygen</span> <span class=o>=</span> <span class=s>&#34;list(markdown = TRUE)&#34;</span><span class=p>)</span>
  <span class=p>)</span>
  <span class=nf>expect_true</span><span class=p>(</span><span class=n>desc</span><span class=o>::</span><span class=nf>desc_has_fields</span><span class=p>(</span><span class=s>&#34;RoxygenNote&#34;</span><span class=p>,</span> <span class=n>pkg</span><span class=p>))</span>
  <span class=nf>expect_true</span><span class=p>(</span><span class=nf>uses_roxygen_md</span><span class=p>())</span>
<span class=p>})</span>
</code></pre></div><p>This test checks that <code>usethis::use_roxygen_md()</code> does the setup necessary to use roxygen2 in a package and, specifically, to write documentation with markdown syntax. All 3 expectations consult the DESCRIPTION file, directly or indirectly. So it&rsquo;s very convenient that <code>create_local_package()</code> creates a minimal package, with a valid DESCRIPTION file, for us to test against. And when the test is done &ndash; poof! &ndash; the package is gone.</p><p>The setup and teardown done by <code>create_local_package()</code> would be aggravating and repetitive to inline in each individual test. The tests would be dominated by this code, making them less readable. If we need to tweak something, we&rsquo;d have to do it in hundreds of places. This sort of friction has a real chilling effect on one&rsquo;s enthusiasm for writing and maintaining tests.</p><p>A few more observations about the self-cleaning test fixture pattern:</p><ul><li>Every action has an equal and opposite reaction. Each individual &ldquo;doing&rdquo;
action (A) has a matching, deferred &ldquo;undoing&rdquo; reaction (-A).</li><li>We work in this order (usually and preferably):<ul><li>Record existing state.</li><li>Describe the eventual cleanup.</li><li>Make the desired state change.</li></ul></li><li>The undoing usually unfolds in the opposite order from the doing (&ldquo;last in,
first out&rdquo;). This is almost always OK and it is often absolutely necessary.
In <code>create_local_package()</code>:<ul><li>Doing: We must create directory <code>dir</code> (A) before we can make it the
working directory (B). (A) must come before (B).</li><li>Undoing: We must restore the original working directory (-B) before
we can delete <code>dir</code> (-A). (-B) must come before (-A). We can&rsquo;t delete
<code>dir</code> while it&rsquo;s still the working directory!</li><li>Think of it like a stack of plates: the last plate onto the stack has to
be the first one off.</li></ul></li></ul><p><strong>Test fixture</strong> is a pre-existing term in the software engineering world (and beyond):</p><blockquote><p>A test fixture is something used to consistently test some item, device, or piece of software.</p></blockquote><p>&ndash;
<a href=https://en.wikipedia.org/wiki/Test_fixture target=_blank rel=noopener>Wikipedia</a></p><p>When I first heard &ldquo;test fixture&rdquo; (from GÃ¡bor CsÃ¡rdi, I think), a light bulb clicked on in my head. This was something I <em>knew</em> I needed and had even implemented in various half-baked ways. But I hadn&rsquo;t identified it as A Real Thing, with specific goals and design principles. It&rsquo;s a great example of
<a href=https://blogs.scientificamerican.com/observations/unknown-unknowns-the-problem-of-hypocognition/ target=_blank rel=noopener>hypocognition</a>. Learning the term &ldquo;test fixture&rdquo; gave me a place to hang this knowledge and allowed me to more quickly identify situations where a test fixture was needed.</p><h3 id=googlesheets4-and-local_ss>googlesheets4 and <code>local_ss()</code>
<a href=#googlesheets4-and-local_ss><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>The googlesheets4 package (
<a href=https://googlesheets4.tidyverse.org target=_blank rel=noopener>googlesheets4.tidyverse.org</a>) provides an R interface to the Google Sheets API. A typical test needs access to a Google Sheet, constructed to have very specific properties and the test may even need to modify the Sheet<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><p>I need a way to quickly create a Sheet, possibly with very specific initial worksheets, cell data, locale, time zone, etc. Test some functions against it. Then trash it. I need a <em>local spreadsheet</em>.</p><p>Here&rsquo;s a simplified version of the helper <code>local_ss()</code>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>local_ss</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=kc>...</span><span class=p>,</span> <span class=n>env</span> <span class=o>=</span> <span class=nf>parent.frame</span><span class=p>())</span> <span class=p>{</span>
  <span class=n>existing</span> <span class=o>&lt;-</span> <span class=nf>gs4_find</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
  <span class=nf>if </span><span class=p>(</span><span class=nf>nrow</span><span class=p>(</span><span class=n>existing</span><span class=p>)</span> <span class=o>&gt;</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=nf>stop_glue</span><span class=p>(</span><span class=s>&#34;A spreadsheet named {sq(name)} already exists.&#34;</span><span class=p>)</span>
  <span class=p>}</span>

  <span class=n>withr</span><span class=o>::</span><span class=nf>defer</span><span class=p>({</span>
    <span class=n>trash_me</span> <span class=o>&lt;-</span> <span class=nf>gs4_find</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
    <span class=n>googledrive</span><span class=o>::</span><span class=nf>drive_trash</span><span class=p>(</span><span class=n>trash_me</span><span class=p>)</span>
  <span class=p>},</span> <span class=n>envir</span> <span class=o>=</span> <span class=n>env</span><span class=p>)</span>
  
  <span class=nf>gs4_create</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=kc>...</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Even though the Sheets API is very file-ID-oriented, I go out of my way to work here via Sheet name. I bring this up to illustrate another point: you can also use a helper like this to rationalize your development workflow.</p><p>At first, it feels like <code>local_ss()</code> should create a new Sheet, store its ID, and then schedule it for deletion. But reality is more messy. As I develop a function and its tests, my experimentation can leave behind several instances of a test Sheet (yes, on Drive, you can have several files with the same name!). This leads to a very cluttered and confusing situation in the test account, requiring a periodic &ldquo;search and destroy&rdquo; mission for zombie test Sheets. Now my helper immediately alerts me to this problem and applies constant pressure to keep things neat and tidy.</p><p>If you keep stubbing your toe in a particular way as you work on your package, zoom out and consider if you can design the problem away by adjusting your workflow. The helper that creates a self-cleaning test fixture is great place to apply this sort of leverage.</p><h2 id=defer-on-the-global-environment><code>defer()</code> on the global environment
<a href=#defer-on-the-global-environment><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>I conclude with one more story about workflow. We&rsquo;ve talked about two main functions for registering deferred events: base R&rsquo;s <code>on.exit()</code> and <code>withr::defer()</code>. Part of what <code>withr::defer()</code> offers over <code>on.exit()</code> is the ability to defer events on <em>any</em> environment. But there was still a big exception: the global environment.</p><p>Until quite recently, here&rsquo;s what happened if you called <code>defer()</code> in an interactive R session<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>withr</span><span class=o>::</span><span class=nf>defer</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;hi&#34;</span><span class=p>))</span>
<span class=c1>#&gt; Error in withr::defer(print(&#34;hi&#34;)):</span>
<span class=c1>#&gt;   attempt to defer event on global environment</span>

<span class=nf>packageVersion</span><span class=p>(</span><span class=s>&#34;withr&#34;</span><span class=p>)</span>
<span class=c1>#&gt; [1] &#39;2.1.2&#39;</span>
</code></pre></div><p>Frankly, this makes a lot of sense. Deferred events are triggered when an environment goes out of scope. <code>on.exit()</code> and <code>defer()</code> are meant to be used in an ephemeral environment, like a function execution environment. Deferring events on the global environment is pretty weird.</p><p>But what about your interactive development of functions and tests? Every time you hit a call to <code>defer()</code> or <code>local_*()</code>, that code fails to execute. You&rsquo;re forced to develop your logic at arm&rsquo;s length or implement the intent of the <code>local_*()</code> calls manually. If you&rsquo;re doing quite a bit of work via <code>local_*()</code> or <code>on.exit()</code>, this presents a problem. Basically, it&rsquo;s harder to develop with functions that work one way inside a function, but another way in the global environment (or, worse, don&rsquo;t work at all). <code>substitute()</code> is another example of this.</p><p>As of withr v2.2.0, you can <code>defer()</code> events on the global environment, which means that <code>local_*()</code> functions work too. This is still a pretty weird thing to do, which is why you get a message about how to trigger execution.</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=nf>library</span><span class=p>(</span><span class=n>withr</span><span class=p>)</span>

<span class=nf>packageVersion</span><span class=p>(</span><span class=s>&#34;withr&#34;</span><span class=p>)</span>
<span class=c1>#&gt; [1] &#39;2.2.0&#39;</span>

<span class=nf>defer</span><span class=p>(</span><span class=nf>print</span><span class=p>(</span><span class=s>&#34;hi&#34;</span><span class=p>))</span>
<span class=c1>#&gt; Setting deferred event(s) on global environment.</span>
<span class=c1>#&gt;   * Execute (and clear) with `deferred_run()`.</span>
<span class=c1>#&gt;   * Clear (without executing) with `deferred_clear()`.</span>

<span class=nf>deferred_run</span><span class=p>()</span>
<span class=c1>#&gt; [1] &#34;hi&#34;</span>
</code></pre></div><p>Since the global environment isn&rsquo;t perishable, like a test environment is, you have to call <code>deferred_run()</code> explicitly to execute the deferred events. You can also clear them, without running, with <code>deferred_clear()</code>.</p><p>This new capability is especially handy with self-cleaning test fixtures, like <code>create_local_package()</code> and <code>local_ss()</code> shown above. Sometimes you have to change global state while developing tests, e.g. change working directory or create test Sheets. But now there&rsquo;s a way to run the associated cleanup on demand.</p><h2 id=recap>Recap
<a href=#recap><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="currentcolor"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We&rsquo;ve demonstrated that it&rsquo;s a problem to change state in a function or test. Obviously there are exceptions if, for example, that is the whole point of the function.</p><p>The most common and recommended solution to this is to use <code>on.exit()</code> to organize the necessary cleanup, i.e. restore the original state. However, <code>on.exit()</code> has some inherent limitations.</p><p>If this sort of setup/teardown happens frequently in the functions and tests in a package, it makes sense to write a custom helper. This function should follow the conventions of the <code>local_*()</code> functions in withr and will presumably be built around <code>withr::defer()</code>.</p><p>There is some cost to using a custom <code>local_*()</code> helper, as it is one more thing to maintain and that all contributors must understand. Consider whether the pros outweigh the cons when adding another layer of abstraction.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>It&rsquo;s too bad <code>add = TRUE</code> isn&rsquo;t the default, because you almost always want this. Without it, each call to <code>on.exit()</code> clobbers the effect of previous calls. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>Note: the <code>after</code> argument of <code>on.exit()</code> first appeared in R 3.5.0. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><code>create_local_package()</code> is a test helper. The testthat package allows such things to be defined in <code>tests/testthat/helper.R</code> and then makes them available within package tests. They are also loaded by <code>devtools::load_all()</code>. <code>tests/testthat/helper.R</code> is also a great place to define custom expectations. <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>You might ask about mocking here, but I usually don&rsquo;t embrace that heavily and, in any case, that is a topic for another day. <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p>For all practical purposes, you get the same result with <code>on.exit()</code>. It&rsquo;s just a silent no-op. <a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></div><div class=column25><div class="section hideOnMobile"><div class=sectionTitle>Contents</div><nav id=TableOfContents><ul><li><a href=#test-hygiene>Test hygiene</a></li><li><a href=#the-onexit-pattern>The <code>on.exit()</code> pattern</a></li><li><a href=#withrdefer><code>withr::defer()</code></a></li><li><a href=#withrlocal_><code>withr::local_*()</code></a></li><li><a href=#test-fixtures>Test fixtures</a></li><li><a href=#defer-on-the-global-environment><code>defer()</code> on the global environment</a></li><li><a href=#recap>Recap</a></li></ul></nav></div><div class=section></div></div></div></div></div><div id=rStudioFooter class=band><div class=bandContent><div id=copyright>The tidyverse is proudly supported by <a class=rstudioLogo href=https://posit.co/ aria-label="Posit Homepage"></a></div><div id=logos><a href=https://www.tidyverse.org/google_privacy_policy>Privacy policy</a>
<a href=https://github.com/tidyverse class="footerLogo gitHub" aria-label="Tidyverse GitHub organization"></a><a href=https://twitter.com/hashtag/rstats class="footerLogo twitter" aria-label="rstats hashtag on twitter.com"></a></div></div></div></div></div><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-115082821-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('set','anonymizeIp',true);ga('send','pageview');}</script></body></html></div></div></body></html>